# AIpayment 画面ロジック定義書 v2.0

**作成日**: 2026-02-21
**改訂日**: 2026-02-21（v1.0 洗い出し → v2.0 ロジック定義）
**目的**: v1.0で洗い出した39項目全てに対し、具体的なビジネスロジック・計算式・閾値・遷移ルールを定義する

---

## 凡例

- ✅ **確定**: ロジック定義済み。バックエンド実装時にこの仕様に従う
- ⏳ **質問票待ち**: 現場スタッフの回答（Requirements_Questionnaire_v1.0.md）を反映して確定する
- 📐 **計算式あり**: 計算ロジックを明記

---

## M01 ダッシュボード

### #1 ✅ KPI「自動化率」の定義

**計算式:**
```
自動化率(%) = (自動処理件数 / 全取引件数) × 100

自動処理件数 = AI自動承認件数 + 自動ブロック件数 + 通常決済件数（ルールに抵触せず処理完了）
全取引件数   = 上記 + 例外キュー送り件数 + 手動レビュー件数
```

**仕様:**
- 集計期間: 直近30日間（ローリング）
- 更新タイミング: 1時間ごとにバッチ集計（Redisキャッシュ）
- 目標値: 95%（M13システム設定で変更可能）
- データソース: `transactions` + `fraud_detection_logs` + `exception_queue`

---

### #2 ✅ KPI「チャージバック率」の計算期間

**計算式:**
```
チャージバック率(%) = (当月CB件数 / 当月取引件数) × 100
```

**仕様:**
- 集計期間: **当月1日〜現在（月次ベース）** — VISAモニタリングプログラム準拠
- データソース: `chargebacks` (status != 'withdrawn') / `transactions` (status = 'captured')
- 閾値アラート:
  - 🟢 0.00〜0.50%: 正常
  - 🟡 0.50〜0.90%: 注意（VISAモニタリングプログラム警告水準）
  - 🔴 0.90%以上: 危険（VDMP登録リスク）
- 加盟店別にもM03で同じ計算式を適用

---

### #3 ✅ 接続先ヘルスの判定基準

**判定マトリクス:**

| ステータス | 条件 | 色 |
|-----------|------|-----|
| 正常 | 成功率 ≥ 99.0% AND レイテンシ < 500ms | 🟢 |
| 注意 | 成功率 95.0〜98.9% OR レイテンシ 500〜1000ms | 🟡 |
| 異常 | 成功率 < 95.0% OR レイテンシ > 1000ms OR 直近5分で5件以上連続エラー | 🔴 |
| メンテナンス | 接続先からメンテナンス通知受信 or 手動設定 | 🔵 |

**仕様:**
- 計測間隔: 1分ごとに内部API `I-007` でZone A → Zone Bにヘルスデータ送信
- 計測対象: 直近5分間のスライディングウィンドウ
- 異常時のアクション: WebSocket `ws-health` チャネルでダッシュボードにリアルタイム通知
- 閾値はM13システム設定 > 接続先管理タブで接続先ごとにカスタマイズ可能

---

### #4 ✅ AIサマリーの更新頻度

**仕様:**
- 定期更新: **30分ごと**（Redisキャッシュ TTL = 1800s）
- 即時再生成トリガー（キャッシュ無効化）:
  1. 接続先ステータスが「異常」に変化
  2. 例外キューに「高リスク」（risk_score ≥ 80）の案件が登録
  3. チャージバック率が0.50%を超過
  4. バッチジョブがエラーで停止
- 即時再生成時はWebSocket `ws-dashboard` で「サマリー更新中...」をスピナー表示

---

### #5 ✅ お知らせ欄の出し分けロジック

**フィルタリングルール:**
```sql
SELECT * FROM announcements
WHERE (target_type = 'all' OR target_merchants @> '[{current_merchant_id}]')
  AND published_at IS NOT NULL
  AND published_at <= NOW()
  AND (expires_at IS NULL OR expires_at > NOW())
ORDER BY priority DESC, published_at DESC
LIMIT 5
```

- 管理者画面（M01）: 全てのお知らせを表示（target_type問わず）
- 加盟店画面（S01）: `target_type = 'all'` OR 自社merchant_idが`target_merchants`に含まれるもの
- ロール別フィルタ: `announcement_type = 'incident'` は全ロールに表示、`announcement_type = 'release'` は admin/super_admin のみ

---

## M02 例外キュー

### #6 ✅ チャージバック未収リスクからの流入 → **ワイヤーフレーム修正必要**

**対応方針:**
- M02のフィルタに「チャージバック」タイプを追加
- 追加後のフィルタ: **全て / 審査保留 / 不正検知 / URL巡回 / 精算 / チャージバック / 処理済み**

**チャージバック種別の例外キュー仕様:**
| 項目 | 値 |
|------|-----|
| タイプ | `chargeback` |
| 登録トリガー | M08でCB受領時に `is_uncollectible_risk = true` の場合自動登録 |
| AI推薦 | 「リザーブから充当可能 / 加盟店へ請求 / 損金処理」の3択を提示 |
| 表示情報 | CB金額、加盟店名、サイト名、リザーブ残高、直近30日取扱高 |
| アクション | 充当実行 / 請求通知送信 / 損金処理 / 保留 |

---

### #7 ✅ 例外キューの滞留アラート閾値

**種別ごとの閾値:**

| 種別 | 注意（🟡） | 警告（🔴） | 理由 |
|------|-----------|-----------|------|
| 審査保留 | 4時間 | 24時間 | 加盟店審査は翌営業日内が目標 |
| 不正検知 | 30分 | 2時間 | 不正取引は早期対応が必要 |
| URL巡回 | 12時間 | 48時間 | サイト変更の緊急性は低い |
| 精算 | 2時間 | 8時間 | 入金スケジュールに影響 |
| チャージバック | 1時間 | 4時間 | 反論期限があるため迅速対応 |

- 閾値はM13システム設定で変更可能
- 🔴 到達時にSlack + メール通知（M13通知設定に従う）

---

### #8 ✅ 一括承認/一括拒否のリスク制御

**ルール:**
1. **種別混在時は一括操作不可** — 同一種別のみ選択可能とするUIバリデーション
2. 一括操作の上限: **10件まで**（11件以上は「本当に実行しますか？」の確認ダイアログ）
3. 一括承認時、AIスコアが50%未満の案件が含まれる場合は警告ダイアログ:
   「AI推薦が拒否の案件が含まれています。個別対応を推奨します。」
4. 監査ログ: 一括操作は `action_type = 'bulk_approve' / 'bulk_reject'` で全件分を記録

---

### #9 ✅ ロック機構の自動解除

**ルール:**
| 条件 | アクション |
|------|---------|
| 操作なし15分経過 | ロック自動解除 + WebSocket通知 |
| ロック者がログアウト | 即時解除 |
| ロック者のセッションタイムアウト | セッション終了時に解除 |
| ロック者がブラウザを閉じた | WebSocket切断検知後30秒で解除 |

- 実装: Redis TTL (key: `queue_lock:{item_id}`, value: `{user_id}`, TTL: 900s)
- ロック中に他ユーザーがアクセス: 「{名前}さんが対応中（残り{X}分）」表示 + 「ロック解除をリクエスト」ボタン

---

## M06 取引モニタリング（リアルタイム監視）

### #10 ✅ 「返金」ボタン押下後のフロー

**フロー定義:**
```
1. ボタン押下
2. 確認ダイアログ表示:
   「取引 {TXN-ID} に対して ¥{金額} の全額返金を実行しますか？」
   ※返金しても手数料は取消にならない旨を表示
3. [実行] 押下 → ボタンをローディング状態に（スピナー + テキスト「返金処理中...」）
4. Zone B API (POST /api/refunds) → Zone A 内部API I-002 呼び出し
5a. 成功 → トースト「✅ 返金が完了しました（¥{金額}）」+ 取引ステータスを「返金済」に更新
5b. 失敗 → トースト「❌ 返金に失敗しました: {エラーメッセージ}」+ ボタン復帰
5c. タイムアウト(30秒) → トースト「⏳ 返金処理がタイムアウトしました。例外キューに送られます」
    → 自動で例外キュー（種別: 精算）に登録
```

**金額ルール:**
- 全額返金のみ（一部返金は実装しない — 返金ポリシー確定済み）
- 管理者権限での金額編集: 返金モーダル内に「金額変更」リンク（super_admin のみ表示）
- 金額変更時: `admin_adjusted_amount` に記録 + `admin_adjust_reason` 必須

---

### #11 ✅ リアルタイム監視の更新方式

**方式: WebSocket（6チャネル方式に統合）**

| チャネル | データ | 更新頻度 |
|---------|--------|---------|
| `ws-transactions` | 新規取引/ステータス変更 | イベント駆動（即時） |
| `ws-fraud` | 不正検知アラート | イベント駆動（即時） |
| `ws-health` | 接続先ヘルス | 1分ごと |
| `ws-settlement` | 精算バッチ進捗 | バッチ実行中のみ |
| `ws-queue` | 例外キュー更新 | イベント駆動（即時） |
| `ws-dashboard` | KPI/AIサマリー | 5分ごと |

- フォールバック: WebSocket接続失敗時は30秒ポーリングに自動切替
- 再接続: 指数バックオフ（1s → 2s → 4s → 8s → 最大30s）
- System_Architecture 7.2の通信経路に整合: `ブラウザ → ALB (WSS) → ECS Fargate`

---

### #12 ✅ 「マネロン疑い」フィルタの判定ロジック

**AMLルール（初期実装）:**

| ルール | 条件 | フラグ |
|-------|------|--------|
| 構造化取引 | 同一顧客が24時間以内に¥450,000〜¥499,999の取引を2回以上 | `aml_structuring` |
| 高額頻回 | 同一カードで30日間に¥1,000,000以上の累計決済 | `aml_high_volume` |
| 国際取引集中 | 同一カードでカード発行国と異なる3カ国以上の加盟店で決済 | `aml_cross_border` |
| 休眠口座 | 180日以上取引なしの顧客が突然¥500,000以上の取引 | `aml_dormant` |

- フラグは `transactions.metadata` JSONBフィールドに格納
- M06の「マネロン疑い」フィルタ: `metadata->>'aml_flag' IS NOT NULL` でフィルタ
- 本格的なAML対応は Phase 2 以降（犯収法対応コンサルとの連携）

---

## M08 精算管理

### #13 ✅📐 入金明細の「リザーブ留保」「リザーブ解放」の計算ロジック

**精算計算式（加盟店×サイト×接続先×精算期間ごと）:**
```
① 総決済高         = SUM(transactions.amount) WHERE status='captured' AND period
② ブランド別手数料  = Σ(ブランド別決済高 × sites.fee_rate->{brand})
③ CB差引額         = SUM(chargebacks.amount) WHERE status IN ('lost','expired') AND period
④ リザーブ留保      = (① - ②) × rolling_reserve_settings.reserve_rate / 100
⑤ リザーブ解放      = SUM(rolling_reserve_transactions.amount)
                      WHERE type='hold'
                      AND executed_at <= NOW() - (reserve_period_days || ' days')::interval
                      AND NOT EXISTS (既に解放済みレコード)
⑥ 入金額           = ① - ② - ③ - ④ + ⑤
```

**留保の計算基準:**
- **手数料差引後 × リザーブ率** — つまり `(① - ②) × rate`
- 理由: 手数料はPSP側の収益であり、加盟店の実質入金前の額にリザーブをかける

**解放ルール:**
- `rolling_reserve_settings.reserve_period_days` に従う（デフォルト180日）
- 解放タイミング: 精算バッチ実行時に自動チェック
- 解放対象: `留保日 + reserve_period_days <= 精算実行日` の全未解放レコード
- 解放レコード: `rolling_reserve_transactions` に `type='release'` で記録

**データソース参照先:**
- 手数料率: `sites.fee_rate` (JSONB) — 例: `{"VISA": 3.25, "MC": 3.00, "JCB": 3.50}`
- リザーブ率: `rolling_reserve_settings.reserve_rate`
- リザーブ期間: `rolling_reserve_settings.reserve_period_days`

---

### #14 ✅ 精算明細のブランド別手数料率 → **ワイヤーフレーム修正必要**

**現状の問題:** ワイヤーフレームで「3.2%」「3.0%」等がハードコードされている
**対応:**
- ワイヤーフレームのサンプルデータは残すが、実装時は `sites.fee_rate` JSONBから動的取得
- API: `R-034 サイト接続先詳細` で取得 → ブランド別手数料率（加盟店率/原価率/マージン）
- 手数料率変更API: `W-014 加盟店手数料率変更`（super_admin権限）

**手数料率の適用ルール:**
1. `sites.fee_rate` に値があれば **サイト別レート** を適用
2. なければ `merchant_processors.fee_rate` から **加盟店×接続先レート** を適用
3. いずれもなければ `processors.default_fee_rate` の **接続先デフォルトレート** を適用

---

### #15 ✅ 精算バッチのエラーリカバリ

**再実行ルール:**

| 項目 | 仕様 |
|------|------|
| 再実行範囲 | **エラー分のみ**（正常完了分は再処理しない） |
| 重複チェック | `settlements.batch_id` + `merchant_id` + `period` のユニーク制約で防止 |
| 新規取引の扱い | 精算対象は `settlement_cutoff_at`（バッチ開始時刻）以前の取引のみ。カットオフ後の取引は次回バッチ対象 |
| 同日再実行 | 可能。ただし同一期間のバッチIDが異なるため重複しない |
| 手動再実行 | エラー行ごとに「再実行」ボタン or 「例外キューに送る」ボタン |
| 自動リトライ | バッチエラー発生時、30分後に自動リトライ1回。失敗時は例外キュー送り |

**エラー種別と対応:**
| エラー | 対応 |
|--------|------|
| 口座情報不一致 | 加盟店に通知 → S08で口座情報修正後に手動再実行 |
| 入金限度額超過 | 分割入金（翌日分として繰越）or 例外キュー |
| 接続先タイムアウト | 30分後自動リトライ |

---

### #16 ✅ 代理店精算の「決済種別ごとの内訳」

**代理店フィーの料率構造:**
- `agent_commissions.commission_rate` = 代理店報酬率（基本率）
- M15フィー設定タブでは **決済種別ごとの料率設定が可能**

**計算式:**
```
代理店報酬(ブランド別) = ブランド別決済高 × agent_brand_commission_rate

agent_brand_commission_rate =
  M15フィー設定で種別別レートが設定されていればそれを使用
  なければ agent_commissions.commission_rate（全種別共通の基本率）
```

**DB拡張（検討）:**
- `agents.contract_terms` JSONB に種別別レートを格納:
  ```json
  {
    "commission_by_brand": {
      "VISA": 0.5, "MC": 0.5, "JCB": 0.6,
      "AMEX": 0.7, "QR": 0.3, "bank": 0.2, "convenience": 0.2
    }
  }
  ```

---

## M07 不正検知

### #17 ✅ シミュレーション用データセット

**仕様:**
| 項目 | 値 |
|------|-----|
| 対象データ | 直近 **30日間** の全取引データ |
| データ件数上限 | 100,000件（超過時はサンプリング） |
| 実行環境 | 非同期ジョブ（バックグラウンド実行） |
| 所要時間目安 | 30秒〜3分（データ量に応じて） |
| 結果表示 | 検知数・ブロック数・誤検知率（既知の正常取引に対する判定結果）|

- シミュレーション結果は一時テーブルに保存（24時間後に自動削除）
- 「このルールを有効にした場合の影響」を可視化する目的

---

### #18 ✅ 加盟店別オーバーライドの上限チェック

**緩和方向の制限ルール:**

| グローバル設定 | オーバーライド許容範囲 | 例 |
|--------------|---------------------|-----|
| 金額閾値 | **グローバル値の最大5倍まで** | グローバル ¥500,000 → 最大 ¥2,500,000 |
| 速度チェック回数 | **グローバル値の最大3倍まで** | グローバル 5回/5分 → 最大 15回/5分 |
| AIスコア閾値 | **グローバル値から -20ポイントまで** | グローバル 0.7 → 最低 0.5 |

- 許容範囲を超えるオーバーライドは **super_admin承認が必要**
- オーバーライド設定画面に「⚠️ グローバル値の{X}倍に緩和されています」の警告バッジ表示
- `fraud_merchant_overrides.is_enabled` を切り替える際にも上限チェック実行

---

## M10 ルーティング

### #19 ✅ 一括ライン変更の「元に戻す」復元機能

**仕様:**
| 項目 | 値 |
|------|-----|
| 復元可能範囲 | **直近1回のみ** |
| 復元可能期間 | 変更実行から **72時間以内** |
| 復元対象 | 一括変更で切り替えた全ルーティングルール |
| 切替→復元間の取引 | **影響なし**（切替先で処理済みの取引はそのまま）。復元は今後の新規取引のルーティングのみ変更 |
| 復元ログ | `audit_logs` に `action_type = 'routing_bulk_restore'` で記録 |

- 復元データ: `routing_change_history` テーブルに変更前の設定を保持
- 72時間経過後は「元に戻す」ボタンを非活性化

---

### #20 ✅ ルーティングルールの優先度競合

**評価ルール:**
```
1. routing_rules を priority ASC でソート（小さい = 高優先）
2. 上から順に条件をチェック、最初にマッチしたルールを適用
3. 同一priority の場合: created_at ASC（先に作成された方を優先）
4. どのルールにもマッチしない場合: デフォルトルーティング（接続先のweight比率でランダム）
```

- ルール作成時にpriority重複の警告を表示
- M10画面でドラッグ&ドロップによる優先度並べ替えを実装予定

---

## M14 リカーリング管理

### #21 ✅ バッチ実行スケジュールの柔軟性

**仕様:**
| 項目 | 値 |
|------|-----|
| デフォルト実行時刻 | **AM 2:00**（全加盟店共通） |
| カスタム実行時刻 | **加盟店単位で変更不可** — 全加盟店一律 AM 2:00 |
| 決済日指定 | **プラン単位で設定可能**（`billing_day` カラム: 1〜28日） |
| 月末対応 | `billing_day = 28` は「月末」として扱う（2月は28日、他は28日） |

**バッチ動作:**
```
AM 2:00 起動:
1. subscription_users WHERE status='active' AND next_payment_date = TODAY を取得
2. 加盟店×接続先でグルーピング
3. 各ユーザーに対して Zone A I-008 API で決済実行
4. 結果を Zone A → Zone B I-009 API で通知
5. next_payment_date を次サイクルに更新
```

- 「毎月15日」のプランは `billing_day = 15` で設定。バッチ自体は毎日AM2:00に実行し、当日が決済日のユーザーのみ対象
- 実行時刻カスタムは Phase 2（運用安定後に検討）

---

### #22 ✅ 「自動停止急増アラート」の閾値

**閾値定義:**

| アラートレベル | 条件 | アクション |
|------------|------|---------|
| 🟡 注意 | 当日の自動停止件数 ≥ **前日比150%** | ダッシュボード注意アイコン |
| 🔴 警告 | 当日の自動停止件数 ≥ **前日比250%** | Slack + メール通知 + ダッシュボード赤バッジ |
| 🔴🔴 緊急 | 当日の自動停止件数 ≥ **前日比500%** OR 1時間で10件以上停止 | PagerDuty + バッチ一時停止提案 |

- 閾値はM13システム設定で変更可能
- 集計: 日次バッチ + 1時間ごとの中間チェック

---

### #23 ✅ CSV決済の承認フロー

**フロー定義:**
```
1. 加盟店がCSVアップロード（S10 CSV決済タブ）→ Zone B S3保存
2. バリデーション自動実行（フォーマットチェック、金額上限チェック）
3. バリデーション通過 → ステータス「承認待ち」
4. 運営スタッフが承認 or 拒否（M14 CSV決済管理タブ）
5. 承認後 → 「決済予定日」に自動バッチ実行
```

| 項目 | 仕様 |
|------|------|
| 承認権限 | **admin, super_admin**（operator は閲覧のみ） |
| 部分承認 | **不可** — CSV全体を承認 or 拒否。個別行の除外は加盟店側でCSVを再アップロード |
| 実行タイミング | **CSVに記載の「決済予定日」の AM 2:00**（リカーリングバッチと同一タイミング） |
| 金額上限 | 1CSVファイルあたり **¥10,000,000**（超過時は自動拒否 + エラーメッセージ） |
| 行数上限 | **10,000行**（S10のUIに記載済み） |

---

## M04 申込・登録管理

### #24 ✅ 審査フローのステップ間遷移ルール

**遷移マトリクス:**

| ステップ | 遷移条件 | 自動/手動 |
|---------|---------|----------|
| 申込受付 → AI審査 | 申込データ受信（P01フォーム送信） | **自動**（即時） |
| AI審査 → 運営確認 | AI審査完了（タイムアウト3分で強制遷移） | **自動** |
| 運営確認 → 自社承認 | スタッフが「承認」ボタン押下 | **手動** |
| 運営確認 → 却下 | スタッフが「却下」ボタン押下（理由必須） | **手動** |
| 自社承認 → 接続先審査 | スタッフが接続先を選択して「審査開始」 | **手動** |
| 接続先審査 → 完了 | 接続先から承認通知受信（API or 手動更新） | **手動/API** |

**AI審査のスコア閾値:**
| スコア | 判定 | 処理 |
|--------|------|------|
| 80〜100 | 承認推薦 | 自動で運営確認ステップに遷移（推薦表示付き） |
| 40〜79 | 要確認 | 自動で運営確認ステップに遷移（注意事項表示付き） |
| 0〜39 | 拒否推薦 | 自動で運営確認ステップに遷移（拒否推薦表示付き） |

※全件で運営確認は必須（自動承認/自動拒否はしない — 人間の判断を必ず介在）

**接続先審査がない場合:**
- 接続先が `skip_review = true` の設定 → 接続先審査ステップをスキップして「完了」

---

### #25 ✅ サイト追加申請と新規申込の審査フローの差異

**サイト追加は簡略フロー:**

| 項目 | 新規申込 | サイト追加 |
|------|---------|----------|
| ステップ数 | 5ステップ | **3ステップ** |
| フロー | 申込→AI審査→運営確認→接続先審査→完了 | **申込→運営確認→接続先審査** |
| AI審査 | あり | **なし**（既に加盟店として承認済みのためスキップ） |
| 書類 | フル提出（法人確認、本人確認等） | **サイト関連のみ**（URL、業種、商品説明） |
| 接続先審査 | 必須 | **接続先が同じ場合はスキップ** |

---

## S01 加盟店ダッシュボード

### #26 ✅ KPIの表示範囲

**ルール:**
- **サイトセレクター未選択（デフォルト）**: 全サイト合算
- **サイトセレクター選択時**: 選択中のサイトのみ
- サイトセレクターはグローバルヘッダーに配置（全画面で共通使用）
- 選択状態はセッションストレージに保存（ページ遷移で維持）

**KPIクエリ例:**
```sql
-- サイトセレクター未選択時
SELECT SUM(amount) FROM transactions
WHERE merchant_id = :merchant_id AND period = :period

-- サイトセレクター選択時
SELECT SUM(amount) FROM transactions
WHERE site_id = :site_id AND period = :period
```

---

### #27 ✅ 「お知らせ」の表示対象

- **#5 と同一ロジック** を適用
- 加盟店画面では: `target_type = 'all'` OR `target_merchants` に自社 `merchant_id` が含まれるもの
- 表示順: `priority DESC, published_at DESC`
- 表示件数: 最新5件（「もっと見る」で全件表示）

---

## S04 入金確認

### #28 ✅ 入金カレンダーの入金サイクル → **ワイヤーフレーム修正必要**

**現状の問題:** 「毎週金曜日」がハードコード
**対応:**
- `sites.settlement_cycle` フィールドから動的取得
- 入金サイクルの種類:

| サイクル | settlement_cycle値 | カレンダー表示 |
|---------|-------------------|-------------|
| 月1回 | `monthly_end` | 月末の💰マーク |
| 月2回 | `biweekly_15_end` | 15日と月末の💰マーク |
| 週1回（金曜） | `weekly_fri` | 毎週金曜の💰マーク |
| 日次 | `daily` | 毎営業日の💰マーク |

- ⏳ 質問票 A-2 で入金サイクルの選択肢を最終確認
- カレンダーの精算対象期間も `settlement_cycle` に応じて動的計算

---

### #29 ✅ リザーブ（デポジット）タブの「解放予定」計算

**計算式:**
```
今月解放予定額 = SUM(rolling_reserve_transactions.amount)
  WHERE type = 'hold'
  AND executed_at + reserve_period_days <= 月末日
  AND NOT EXISTS (対応する release レコード)

来月解放予定額 = 同上で翌月末日まで
```

**M08との整合性:**
- **同一データソース** — `rolling_reserve_settings` + `rolling_reserve_transactions`
- S04: 加盟店視点（自社の全サイト or 選択サイト）
- M08: 運営視点（全加盟店横断）
- 表示の粒度が異なるだけで、データと計算ロジックは同一

---

## S09 決済リンク管理

### #30 ✅ 決済リンクの「利用回数制限」

**仕様:**
| 項目 | 値 |
|------|-----|
| 回数チェックタイミング | **決済完了時**（アクセス時ではない） |
| 理由 | アクセスのみで回数消費するとDDoSで簡単に枯渇する |
| 排他制御 | `current_uses` のインクリメントに `SELECT ... FOR UPDATE` を使用 |
| 同時決済対応 | `max_uses - current_uses` が1以上なら決済処理開始。完了時にインクリメント |
| 超過時の挙動 | P02決済ページに「このリンクの利用可能回数に達しました」エラー表示 |

---

### #31 ✅ 決済リンクのステータス遷移

**遷移ルール:**
```
active  →  inactive   (加盟店が手動で無効化)
active  →  expired    (expires_at を過ぎた場合)
inactive →  active    (加盟店が手動で再有効化 ✅ 可能)
expired  →  (なし)    (期限切れからの復活は不可。新規作成が必要)
```

**期限切れチェック:**
- **リアルタイムチェック** — P02決済ページアクセス時に `expires_at` を確認
- 日次バッチ（AM 3:00）で `status = 'active' AND expires_at < NOW()` のレコードを `expired` に一括更新
- 理由: リアルタイムチェックだけだと管理画面の一覧表示で「有効」のまま残ってしまうため

---

## S10 決済管理（継続・分割）

### #32 ✅ 「カード変更URL」発行の実フロー

**フロー定義:**
```
1. 加盟店がS10でユーザー行の「カード変更URL」ボタンを押下
2. Zone B API: POST /api/subscriptions/:user_id/card-change-url
   → card_change_token (UUID) を生成、有効期限 = 24時間
   → subscription_users.card_change_token, card_change_expires に保存
3. URL生成: https://pay.aipayment.jp/card-change/{card_change_token}
4. 加盟店にURL表示（コピーボタン付き）
   ※メール送信はPSP側では行わない — 加盟店がエンドユーザーに直接案内
5. エンドユーザーがURLにアクセス
6. P02決済ページの派生画面を表示:
   - 既存カード下4桁を表示（確認用）
   - 新しいカード情報入力フォーム（CDE iframe）
   - 3DS認証実施
7. 新カードでトークン取得 → subscription_users.card_token を更新
8. 完了画面表示:「カード情報が更新されました」
```

**ページ種別:** P02の派生（`/card-change/` パス）— 専用ページではなくP02のモードバリエーション

**セキュリティ:**
- トークンはワンタイム（使用後に無効化）
- 有効期限: 24時間（card_change_expires で管理）
- 期限切れ時: 「このURLの有効期限が切れています」エラー表示

---

### #33 ✅ リトライ中ユーザーの「永久停止」操作

**仕様:**
| 項目 | 値 |
|------|-----|
| 停止タイミング | **即時停止**（当月末ではない） |
| 残課金期間 | **放棄**（残りの課金は実行しない） |
| ステータス変更 | `subscription_users.status = 'stopped'` + `stopped_at = NOW()` |
| 通知 | **加盟店にメール通知**（「ユーザー{email}の継続課金を手動停止しました」） |
| エンドユーザーへの通知 | **PSPからは送信しない** — 加盟店がエンドユーザーに連絡する責任 |
| 再開 | **不可**（AQUAGATES準拠: 停止後の再開不可） |
| 分割決済の場合 | 未払い分はそのまま残債（加盟店がエンドユーザーと個別対応） |

---

## S08 アカウント設定

### #34 ✅ 口座変更時の承認フロー

**仕様:**
```
1. 加盟店がS08で口座情報を変更して「保存」
2. ステータス = 「口座変更 承認待ち」（即時反映しない）
3. M02例外キュー（種別: 精算）に自動登録
   → 表示: 「{加盟店名} 口座情報変更申請: {旧口座} → {新口座}」
4. 運営スタッフが承認 or 拒否
5a. 承認 → 口座情報を更新 + 加盟店にメール通知
5b. 拒否 → 加盟店にメール通知（理由付き）
```

**不正口座防止策:**
- 変更承認後、**最初の入金を72時間保留**（口座名義の確認期間）
- 入金保留中は加盟店ダッシュボードに「口座確認中」バッジ表示
- 72時間後に自動入金（問題なければ）

---

## P02 決済ページ

### #35 ✅ CDE iframe との通信プロトコル

**postMessage仕様:**

**親ウィンドウ → CDE iframe:**
```javascript
// 決済情報送信（カード入力フォーム表示後）
iframe.contentWindow.postMessage({
  type: 'INIT_PAYMENT',
  payload: {
    merchant_id: 'MERCH-xxx',
    site_id: 'SITE-xxx',
    amount: 29800,
    currency: 'JPY',
    order_id: 'ORD-xxx'
  }
}, 'https://cde.aipayment.jp');
```

**CDE iframe → 親ウィンドウ:**
```javascript
// トークン化成功
window.parent.postMessage({
  type: 'TOKEN_CREATED',
  payload: {
    token: 'tok_xxxx',
    card_last4: '4242',
    card_brand: 'VISA',
    exp_month: 12,
    exp_year: 2028
  }
}, origin);  // origin = pay.aipayment.jp

// エラー通知
window.parent.postMessage({
  type: 'TOKEN_ERROR',
  payload: {
    code: 'INVALID_CARD',
    message: 'カード番号が正しくありません'
  }
}, origin);

// 3DS認証が必要
window.parent.postMessage({
  type: '3DS_REQUIRED',
  payload: {
    acs_url: 'https://...',
    pareq: '...',
    transaction_id: '...'
  }
}, origin);

// 3DS認証完了
window.parent.postMessage({
  type: '3DS_COMPLETE',
  payload: {
    status: 'Y',  // Y=成功, N=失敗, A=Attempt
    eci: '05',
    cavv: '...'
  }
}, origin);
```

**セキュリティ:**
- `origin` チェック: `event.origin === 'https://cde.aipayment.jp'` のみ受け入れ
- CSP: `frame-src https://cde.aipayment.jp` のみ許可

---

### #36 ✅ 3Dセキュア認証のUI遷移

**方式: iframe内ポップアップ方式**

```
1. カード入力 → CDE iframeでトークン化
2. 3DS必要判定 → '3DS_REQUIRED' メッセージ
3. 親ウィンドウにオーバーレイモーダルを表示
4. モーダル内にACS URLをiframe表示（銀行認証画面）
5. 認証完了 → ACSからリダイレクト → CDE iframeが受信
6. CDE → 親ウィンドウに '3DS_COMPLETE' メッセージ
7. モーダルを閉じて決済処理続行
```

**失敗時:**
| ケース | 対応 |
|--------|------|
| 3DS認証失敗（status = 'N'） | リトライなし。エラー画面表示「カード認証に失敗しました。別のカードをお試しください」 |
| 3DSタイムアウト（5分） | エラー画面表示「認証がタイムアウトしました」 |
| 3DSなしでの決済 | **不可** — PCI DSS v4.0 / EMV 3DS 2.0準拠のため全取引で3DS必須（除外: リカーリング2回目以降） |

---

### #37 ✅ 決済完了後のリダイレクト先

**仕様:**

| 流入元 | 成功時 | 失敗時 |
|--------|--------|--------|
| API決済（加盟店サーバー） | `payment_links.success_url` or 加盟店API設定の `default_success_url` | `failure_url` 同様 |
| 決済リンク（S09） | P02内の完了画面（「お支払いが完了しました」） | P02内のエラー画面 |
| カード変更（S10） | P02内の完了画面（「カード情報が更新されました」） | P02内のエラー画面 |

**リダイレクトパラメータ:**
```
success_url?order_id={order_id}&status=success&amount={amount}
failure_url?order_id={order_id}&status=failure&error_code={code}
```

- `success_url` / `failure_url` は `payment_links` テーブルまたは S05 API設定で加盟店が登録
- 未設定の場合: P02内のデフォルト完了/エラー画面を表示

---

## D01-D05 代理店画面

### #38 ✅ D03 報酬明細の集計期間

**仕様:**
| 項目 | 値 |
|------|-----|
| 集計期間 | **月次**（毎月1日〜末日） |
| 確定タイミング | 翌月5営業日目（精算バッチ完了後） |
| 閲覧可能範囲 | **全期間**（代理店契約開始月から現在まで） |
| データソース | `agent_commissions` テーブル |
| 表示項目 | 期間、紹介加盟店名、決済高、適用料率、報酬額、ステータス（pending/confirmed/paid） |

---

### #39 ✅ D04 紹介管理の申込ステータス開示範囲

**代理店に表示する情報:**
| ステータス | 代理店に表示 | 詳細情報 |
|-----------|------------|---------|
| 申込受付 | ✅「申込受付済み」 | 申込日のみ |
| AI審査中 | ✅「審査中」 | 進捗なし |
| 運営確認中 | ✅「審査中」 | AI審査と同一表示（区別しない） |
| 接続先審査中 | ✅「接続先審査中」 | 接続先名は非表示 |
| 承認完了 | ✅「承認完了」 | 承認日 |
| 却下 | ✅「却下」 | **却下理由は非表示**（代理店には開示しない） |

**理由:** 却下理由には加盟店の財務情報やリスク情報が含まれる可能性があり、代理店に開示するとプライバシーリスクがある

---

## 全画面共通

### #40 ✅ ドキュメント間の画面数統一 → **各ドキュメント修正必要**

**正式画面数の定義:**

| カテゴリ | 画面 | 数 |
|---------|------|-----|
| マスター管理 | M01〜M16 + AIチャット | 17 |
| 加盟店管理 | S01〜S11 | 11 |
| 代理店管理 | D01〜D05 | 5 |
| 公開画面 | P01〜P03 | 3 |
| **合計** | | **36** |

**修正対象:**
| ドキュメント | 現在 | 修正後 |
|-------------|------|--------|
| CLAUDE.md | 36画面 ✅ | 修正不要 |
| Screen_Specification | 34画面 | 36画面（P03 + AIチャットを追加カウント） |
| Gap分析 | 35画面 | 36画面 |
| System_Architecture | 38画面 | 36画面 |

---

### #41 ✅ 操作ログ保持期間の統一 → **Core_System_Integration修正必要**

**正式仕様: 12ヶ月保持（PCI DSS v4.0 Req 10.5.1準拠）**

| ドキュメント | 現在 | 修正後 |
|-------------|------|--------|
| System_Architecture | 12ヶ月 ✅ | 修正不要 |
| DB設計 (audit_logs) | 12ヶ月 ✅ | 修正不要 |
| **Core_System_Integration** | **90日** ❌ | **12ヶ月に修正** |

修正箇所: Core_System_Integration_v2.0.md 269行目
`操作ログ | 全操作を記録、90日保持（PCI DSS準拠）`
→ `操作ログ | 全操作を記録、12ヶ月保持（PCI DSS v4.0 Req 10.5.1準拠）`

---

### #42 ✅ パスワードポリシーの統一 → **Screen_Specification修正必要**

**正式仕様: PCI DSS v4.0 Req 8.3.6準拠**

| ドキュメント | 現在 | 修正後 |
|-------------|------|--------|
| System_Architecture | 12文字+複雑性 ✅ | 修正不要 |
| M13セキュリティタブ | PCI DSS v4.0準拠 ✅ | 修正不要 |
| **Screen_Specification** | **8文字/英数字混合** ❌ | **12文字+英大小数字記号+過去5回再利用禁止** |

修正箇所: Screen_Specification_v1.0.md 1373行目
`8文字以上 / 英数字混合 / 有効期限なし`
→ `12文字以上 / 英大文字+小文字+数字+特殊文字 / 過去5回再利用禁止 / 90日有効期限 / 5回失敗で30分ロック（PCI DSS v4.0 Req 8.3.6準拠）`

---

### #43 ⏳ セッションタイムアウト

**現状:** Screen_Specification: 8時間
**PCI DSS v4.0 Req 8.2.8:** アイドル15分以内

**暫定方針（質問票 D-2 回答待ち）:**

| 案 | タイムアウト | 備考 |
|-----|-----------|------|
| A（PCI DSS厳格準拠） | **15分** | セキュリティ最優先だが運用負荷高 |
| B（運用バランス型）推奨 | **管理画面: 30分 / 加盟店画面: 1時間** | 管理画面のみ厳格、加盟店は緩和 |
| C（現状維持） | **8時間** | PCI DSS不適合リスクあり |

⏳ **質問票 D-2 の回答を待って確定**
ただし CDE に直接アクセスする管理者は Req 8.2.8 準拠で15分が必須

---

### #44 ✅ API失敗時の共通エラーUI

**HTTPステータス別の表示マッピング:**

| ステータス | UI表示 | ユーザーアクション |
|-----------|--------|----------------|
| 400 Bad Request | 「入力内容を確認してください」+ バリデーションエラー詳細 | フォーム修正 |
| 401 Unauthorized | ログイン画面にリダイレクト | 再ログイン |
| 403 Forbidden | 「この操作を実行する権限がありません」 | 管理者に連絡 |
| 404 Not Found | 「データが見つかりません」 | 一覧に戻る |
| 409 Conflict | 「他のユーザーがこのデータを編集中です」 | リロード |
| 422 Unprocessable | 「処理できませんでした: {詳細}」 | 内容修正 |
| 429 Too Many Requests | 「リクエストが多すぎます。{X}秒後に再試行してください」 | 待機 |
| 500 Internal Server Error | 「システムエラーが発生しました」+ リトライボタン | リトライ or サポート |
| 502/503/504 | 「サーバーに接続できません」+ リトライボタン（自動30秒リトライ） | 待機 |

**実装:**
- グローバルエラーハンドラー（Axios interceptor）で共通処理
- トースト通知: 成功=緑、警告=黄、エラー=赤、5秒で自動消去
- 500系は自動リトライ（最大3回、指数バックオフ: 1s → 3s → 9s）

---

### #45 ✅ テーブル数の統一 → **System_Architecture修正必要**

| ドキュメント | 現在 | 修正後 |
|-------------|------|--------|
| DB設計 | 64テーブル / 46 ENUM ✅ | 修正不要（マスター） |
| **System_Architecture** | **62テーブル / 42 ENUM** ❌ | **64テーブル / 46 ENUM** |

修正箇所: System_Architecture_v1.0.md 54行目 + セクション8サマリー

---

## サマリー（v2.0更新）

| ステータス | 件数 | 内容 |
|-----------|------|------|
| ✅ 確定 | 38件 | ロジック定義済み |
| ⏳ 質問票待ち | 1件 | セッションタイムアウト（#43） |
| **合計** | **39件** | |

### ドキュメント修正が必要な箇所（4件）

| # | ドキュメント | 修正内容 |
|---|------------|---------|
| 1 | Core_System_Integration_v2.0.md | 操作ログ保持期間 90日 → 12ヶ月 |
| 2 | Screen_Specification_v1.0.md | パスワードポリシー 8文字 → 12文字+PCI DSS v4.0 |
| 3 | Screen_Specification_v1.0.md | 画面数 34 → 36 |
| 4 | System_Architecture_v1.0.md | テーブル数 62/42 → 64/46 |

### ワイヤーフレーム修正が必要な箇所（2件）

| # | 画面 | 修正内容 |
|---|------|---------|
| 1 | M02 例外キュー | フィルタに「チャージバック」タイプを追加 |
| 2 | S04 入金カレンダー | settlement_cycle に応じた動的カレンダー表示（ハードコード金曜日を削除） |
