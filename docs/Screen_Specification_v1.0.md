# 画面機能詳細仕様書 v1.2

> AIネイティブ決済代行システム — 全36画面の機能定義
> v1.2: 顧客管理（簡易CRM）画面を追加（M16 / S11）
> v1.1: AQUAGATES照合による追加要件8件を反映（+13画面 / 既存6画面修正）

---

## 目次

### マスター管理画面（運営向け）— 16画面
1. [M01: ダッシュボード](#m01-ダッシュボード)
2. [M02: 例外キュー](#m02-例外キュー)
3. [M03: 加盟店管理](#m03-加盟店管理) ← v1.1 サイト一覧追加
4. [M04: 申込・登録管理](#m04-申込登録管理) ← v1.1 サイト追加申請対応
5. [M05: AI監視](#m05-ai監視)
6. [M06: 注文管理](#m06-注文管理)
7. [M07: 不正検知設定](#m07-不正検知設定)
8. [M08: 精算・入金](#m08-精算入金)
9. [M09: 接続先管理](#m09-接続先管理)
10. [M10: ルーティング](#m10-ルーティング) ← v1.1 一括ライン変更追加
11. [M11: レポート](#m11-レポート)
12. [M12: ユーザー管理](#m12-ユーザー管理)
13. [M13: システム設定](#m13-システム設定) ← v1.1 エラーコード・お知らせ追加
14. [M14: リカーリング管理](#m14-リカーリング管理) 🆕 v1.1
15. [M15: 代理店管理](#m15-代理店管理) 🆕 v1.1
16. [M16: 顧客管理](#m16-顧客管理) 🆕 v1.2

### 加盟店管理画面 — 11画面
17. [S01: ダッシュボード](#s01-ダッシュボード) ← v1.1 お知らせ・サイト切替追加
18. [S02: 取引一覧](#s02-取引一覧)
19. [S03: 売上レポート](#s03-売上レポート)
20. [S04: 入金確認](#s04-入金確認)
21. [S05: API設定](#s05-api設定)
22. [S06: AIサポート](#s06-aiサポート)
23. [S07: ユーザー管理](#s07-ユーザー管理)
24. [S08: アカウント設定](#s08-アカウント設定) ← v1.1 サイト追加申請・エラーコード追加
25. [S09: 決済リンク管理](#s09-決済リンク管理) 🆕 v1.1
26. [S10: 継続・分割決済管理](#s10-継続分割決済管理) 🆕 v1.1
27. [S11: 顧客管理](#s11-顧客管理) 🆕 v1.2

### 代理店管理画面 — 5画面 🆕 v1.1
28. [D01: ダッシュボード](#d01-ダッシュボード) 🆕 v1.1
29. [D02: 加盟店一覧](#d02-加盟店一覧) 🆕 v1.1
30. [D03: 報告書](#d03-報告書) 🆕 v1.1
31. [D04: 申込紹介](#d04-申込紹介) 🆕 v1.1
32. [D05: アカウント設定](#d05-アカウント設定) 🆕 v1.1

### 公開画面 — 2画面
33. [P01: 加盟店申込フォーム](#p01-加盟店申込フォーム)
34. [P02: 決済ページ](#p02-決済ページ) 🆕 v1.1

---

## 共通仕様

### アクセス制御

| ロール | マスター管理画面 | 加盟店画面 | 代理店画面 |
|--------|:---:|:---:|:---:|
| super_admin | 全画面・全操作 | — | — |
| admin | 全画面・全操作（システム設定の一部除く） | — | — |
| reviewer | 例外キューのみ（担当カテゴリ限定） | — | — |
| merchant_owner | — | 全画面・全操作 | — |
| merchant_admin | — | 全画面（API設定・アカウント設定の一部除く） | — |
| merchant_viewer | — | 全画面（閲覧のみ） | — |
| agent_admin | — | — | 全画面・全操作 |
| agent_viewer | — | — | 全画面（閲覧のみ） |

### マルチサイト共通仕様 🆕 v1.1

| 要素 | 仕様 |
|------|------|
| サイト切替セレクター | 加盟店画面のヘッダーに常設。ドロップダウンでサイトを切替 |
| 「全サイト」表示 | S01ダッシュボード・S03レポートは「全サイト合算」と「サイト個別」を切替可 |
| デフォルト選択 | 最後に選択したサイトをlocalStorageで記憶。初回は最初のサイト |
| サイト切替時の挙動 | 各画面のデータが選択サイトでフィルタされる。API呼び出しにsite_idパラメータ付与 |
| マスター画面での表示 | M03加盟店詳細・M06注文管理にサイト別フィルタ追加 |

### 共通UI要素

| 要素 | 仕様 |
|------|------|
| ヘッダー | ロゴ + ユーザー名 + ロール表示 + ログアウト |
| サイドメニュー | アイコン + ラベル、アクティブ状態ハイライト |
| テーブル | ソート（昇順/降順）+ 検索 + フィルタ + ページネーション |
| 確認ダイアログ | 破壊的操作（削除・停止・拒否）は必ずダイアログ表示 |
| トースト通知 | 操作成功時は緑、エラー時は赤、3秒で自動消去 |
| ローディング | API通信中はスケルトンUI表示 |
| エラー表示 | API失敗時はインラインエラーメッセージ + リトライボタン |
| 日付表示 | YYYY-MM-DD HH:MM（日本時間） |
| 金額表示 | ¥XX,XXX（3桁カンマ区切り） |
| ページネーション | 1ページ20件（設定変更可能: 20/50/100件） |

---

# マスター管理画面（運営向け）

---

## M01: ダッシュボード

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M01 |
| メニューID | dashboard |
| 画面名 | ダッシュボード |
| 目的 | システム全体の状態を一目で把握する。AIサマリーで当日の要注意事項を確認する |
| アクセス権 | super_admin / admin / reviewer（閲覧のみ。AIサマリーは非表示） |
| 自動更新 | 30秒ごとにKPI・接続先ヘルスを自動リフレッシュ |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「ダッシュボード」 + システムステータス    │
│           + 最終更新時刻                          │
├─────────────────────────────────────────────────┤
│ ① AIサマリー（グラデーション背景）                 │
│   本日の概況をAIが自然言語で要約                    │
│   ※ reviewer ロールには非表示                      │
├─────────────────────────────────────────────────┤
│ ② KPIカード × 5 + 期間切替 [本日|今週|今月]       │
│   取引量 | 売上 | 成功率 | CB率 | 自動化率         │
├──────────────────────┬──────────────────────────┤
│ ③ 取引推移グラフ       │ ④ 例外キュープレビュー    │
│   件数 + 金額の2段表示  │   未処理の上位3件表示     │
│   期間: [7d|30d|90d]  │   ※ reviewer は担当のみ  │
├──────────────────────┴──────────────────────────┤
│ ⑤ 接続先ヘルス（全アクティブ接続先）                │
│   LED + 成功率 + レスポンスタイム                   │
│   🟢正常 🟡注意 🔴異常 🔵メンテナンス 🟠緊急       │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### ① AIサマリー

| 項目 | 仕様 |
|------|------|
| 表示内容 | 当日の取引概況・異常検知・未処理タスクの要約 |
| 生成タイミング | ページ表示時にリアルタイム生成 + 30分キャッシュ |
| AI | レポートAI（日次サマリープロンプト）を使用 |
| 文字数 | 最大200文字 |
| 更新ボタン | 「🔄 再生成」ボタンでキャッシュ破棄して再生成 |
| エラー時 | 「AIサマリーを生成中...」のスケルトン表示 |

**生成に必要なデータ:**
- 本日の取引数・売上額・前日比
- 不正検知の自動ブロック件数
- 例外キューの未処理件数（2時間超過のアラート）
- 接続先の障害有無
- CB率の当月推移

**❓ 未定義事項:**
- [x] ~~AIサマリーの生成APIエンドポイント~~ → Zone B内部API `GET /api/v1/dashboard/ai-summary` として開発時に定義
- [x] ~~キャッシュ戦略~~ → **Redisキャッシュ（30分間保持）**。ルーティングエンジンと同じRedisインスタンスを共用
- [x] ~~reviewer ロールにもAIサマリーを表示するか~~ → **非表示**。reviewer にはAIサマリーエリアを表示しない

#### ② KPIカード × 5

| KPI | データソース | 計算方法 | 色の条件 |
|-----|-----------|---------|---------|
| 本日の取引量 | transactions テーブル | 当日の COUNT | 前日比の増減で色変更 |
| 本日の売上 | transactions テーブル | 当日の SUM(amount) WHERE status='captured' | 前日比の増減で色変更 |
| 決済成功率 | transactions テーブル | 成功数 / 全件数 × 100 | 99%以上=緑、98-99%=黄、98%未満=赤 |
| チャージバック率 | chargebacks テーブル | 当月CB件数 / 当月取引件数 × 100 | 0.5%未満=緑、0.5-1.0%=黄、1.0%超=赤 |
| 自動化率 | exception_queue テーブル | (全件 - 人間判定件数) / 全件 × 100 | 95%以上=紫(達成)、それ以外=灰 |

**各カードの表示要素:**
- メイン数値（大きいフォント）
- サブテキスト（前日比 or 目標値）
- トレンドインジケーター（▲ 緑 / ▼ 赤 / — 灰）
- 期間切替セレクタ: [本日] / [今週] / [今月]（デフォルト: 本日。全KPI共通で連動）

**❓ 未定義事項:**
- [x] ~~KPIの集計期間の切替~~ → **切替あり（本日 / 今週 / 今月）。デフォルト: 本日**
- [x] ~~前日比の計算で休日をどう扱うか~~ → **休日も取引は発生するため、通常通り前日比を計算する**

#### ③ 取引量推移グラフ

| 項目 | 仕様 |
|------|------|
| グラフ種類 | 縦棒グラフ × 2（件数 + 金額を併記） |
| データ期間 | 切替可能: 7日 / 30日 / 90日（デフォルト: 7日） |
| X軸 | 7日=曜日、30日=日付、90日=週単位 |
| Y軸（上段） | 取引件数 |
| Y軸（下段） | 取引金額（¥） |
| インタラクション | ホバーで件数/金額のツールチップ表示 |
| クリック | 該当日の注文管理画面（M06）へ遷移 |

**❓ 未定義事項:**
- [x] ~~グラフの期間切替~~ → **切替あり（7日 / 30日 / 90日）。デフォルト: 7日**
- [x] ~~金額ベースのグラフも併記するか~~ → **併記する**。件数グラフと金額グラフを上下 or タブで切替表示

#### ④ 例外キュープレビュー

| 項目 | 仕様 |
|------|------|
| 表示件数 | 未処理の上位3件 |
| ソート順 | 緊急度 → 滞留時間（長い順） |
| 表示情報 | ID / 種別 / 対象名 / AI推薦 / 滞留時間 |
| アラート | 2時間超過の案件は赤色バッジ |
| クリック | 例外キュー画面（M02）の該当案件へ遷移 |
| バッジ | 未処理件数を赤丸で表示 |

**❓ 未定義事項:**
- [x] ~~reviewerは自分の担当カテゴリのみ表示するか~~ → **担当カテゴリのみ表示**
- [x] ~~「全て見る」リンクの遷移先~~ → **M02のフィルタ済みビュー**（reviewerの場合は担当カテゴリでフィルタした状態で遷移）

#### ⑤ 接続先ヘルス

| 項目 | 仕様 |
|------|------|
| 表示対象 | アクティブな全接続先（processors テーブル WHERE status='active'） |
| 表示情報 | 接続先名 / ステータスLED / 直近1時間の成功率 / 平均レスポンスタイム |
| ステータスLED | 🟢 正常（成功率99%以上）/ 🟡 注意（95-99%）/ 🔴 異常（95%未満）/ 🔵 メンテナンス / 🟠 緊急 |
| データソース | API #4（接続先ヘルス更新）のデータ |
| クリック | 接続先管理画面（M09）の該当接続先詳細へ遷移 |

**❓ 未定義事項:**
- [x] ~~接続先がメンテナンス中の場合の表示~~ → **🔵メンテナンス / 🟠緊急 のタグを表示**。事前に情報が入るため、管理者が手動でステータスを設定
- [x] ~~ヘルス履歴の時系列グラフは必要か~~ → **不要**。現在値のみ表示

### 使用するAPI

| API | 用途 | 方向 |
|-----|------|------|
| Zone B 内部: GET /api/v1/dashboard/summary | KPI集計データ取得 | フロント → Zone B |
| Zone B 内部: GET /api/v1/dashboard/ai-summary | AIサマリー取得 | フロント → Zone B |
| Zone B 内部: GET /api/v1/exception-queue?limit=3 | 例外キュープレビュー | フロント → Zone B |
| API #4: POST /internal/v1/routing/health | 接続先ヘルス（参照） | Zone A → Zone B |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| transactions | KPI集計（取引量・売上・成功率） |
| chargebacks | CB率計算 |
| exception_queue | 未処理件数・プレビュー |
| processors | 接続先一覧 |
| routing_logs | 接続先ヘルス（成功率・レスポンスタイム） |

### 画面遷移

| 操作 | 遷移先 |
|------|-------|
| 例外キューの案件クリック | M02 例外キュー（該当案件を選択状態で開く） |
| 接続先ヘルスの行クリック | M09 接続先管理（該当接続先の詳細タブ） |
| 取引グラフの棒クリック | M06 注文管理（該当日でフィルタ） |

---

## M02: 例外キュー

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M02 |
| メニューID | queue |
| 画面名 | 例外キュー |
| 目的 | AIが自動判定できなかった案件を人間が判断する。Human-in-the-Loopの中核画面 |
| アクセス権 | super_admin（全カテゴリ）/ admin（全カテゴリ）/ reviewer（担当カテゴリのみ） |
| リアルタイム | WebSocket で新規案件をプッシュ通知 |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「例外キュー」                            │
├─────────────────────────────────────────────────┤
│ ① カテゴリフィルタタブ                              │
│   [全て] [審査保留] [不正検知] [URL巡回] [精算]      │
│   [処理済み]                                        │
│   ※ reviewer は担当カテゴリのタブのみ表示            │
├─────────────────────────────────────────────────┤
│ ② 統計バー: 今日の処理件数 / AI一致率               │
├─────────────────────────────────────────────────┤
│ ② 選択中の案件 — 詳細カード（メイン表示エリア）      │
│   ┌─ ヘッダー: ID + 加盟店名 + 滞留時間バッジ      │
│   ├─ 3カラム: AI推薦 | リスクレベル | AI分析サマリー  │
│   ├─ AIが収集したデータ一覧（グリッド表示）          │
│   └─ 操作ボタン: [拒否] [差戻し] [承認]             │
├─────────────────────────────────────────────────┤
│ ③ 未処理キュー一覧（テーブル）                      │
│   ID | 種別 | 対象 | AI推薦 | 滞留時間 | 操作       │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### ① カテゴリフィルタ

| カテゴリ | 対応する queue_category | 具体例 |
|---------|----------------------|--------|
| 審査保留 | screening | 新規加盟店のAI審査で信頼度が低い案件 |
| 不正検知 | fraud | 不正スコアがグレーゾーン（40-70点）の取引 |
| URL巡回 | url_check | サイト変更検出でリスク判定が微妙な案件 |
| 精算 | settlement | 入金エラー・口座不一致等の対応が必要な案件 |
| 処理済み | — (全カテゴリ) | resolved / escalated の案件。処理者名・処理日時・処理結果を表示。操作ボタンは非表示（閲覧のみ）。期間・ID・対象名で検索可能 |

**reviewer のフィルタ制御:**
- reviewer は admin_user_categories テーブルで割り当てられたカテゴリのみ表示
- 未割り当てカテゴリのタブは非表示（グレーアウトではなく完全に非表示）
- 件数バッジは自分の担当カテゴリ分のみカウント

#### ② 詳細カード（カテゴリ別の表示内容）

**審査保留の場合:**

| 表示項目 | データソース |
|---------|-----------|
| AI推薦判定 | 承認 / 拒否 / 再確認 + 信頼度 % |
| リスクレベル | スコア（0-100） + 業種 + 月商予測 |
| AI分析サマリー | 自然言語で審査結果を要約（200文字以内） |
| 収集データ | 法人名 / 設立年 / 資本金 / 代表者 / 業種 / URL / 反社チェック結果 / 決算書解析結果 |
| 操作ボタン | [拒否] [差戻し] [承認] |

**不正検知の場合:**

| 表示項目 | データソース |
|---------|-----------|
| AI推薦判定 | ブロック / 通過 / 再確認 + 不正スコア |
| 取引情報 | 金額 / ブランド / 加盟店名 / カード下4桁 / BIN6桁 |
| トリガーされたルール | どのルールに引っかかったか一覧表示 |
| 過去の取引パターン | 同一カードの直近取引一覧（5件） |
| 操作ボタン | [ブロック確定] [通過許可] [加盟店に確認] |

**URL巡回の場合:**

| 表示項目 | データソース |
|---------|-----------|
| AI推薦判定 | 問題なし / 警告 / 停止推薦 + リスクスコア |
| サイト情報 | URL / 前回巡回日 / 変更検出箇所 |
| AI解析結果 | 検出された問題（禁止商材 / 薬機法 / 詐欺表現等） |
| スクリーンショット比較 | 前回 vs 今回の画像比較（並列表示） |
| 操作ボタン | [問題なし] [加盟店に警告] [決済停止] |

**精算の場合:**

| 表示項目 | データソース |
|---------|-----------|
| エラー種別 | 口座不一致 / 金額不整合 / 振込失敗 等 |
| 精算バッチ情報 | バッチID / 期間 / 金額 / 加盟店名 |
| エラー詳細 | 銀行からのエラーコード + 説明 |
| 操作ボタン | [手動入金実行] [エスカレーション] [保留] |

#### ③ 未処理キュー一覧

| カラム | 内容 | ソート |
|--------|------|:----:|
| ID | 例外キュー ID（#XXXX） | ✅ |
| 種別 | カテゴリバッジ（色分け） | ✅ |
| 対象 | 加盟店名 / 取引情報 / URL 等 | — |
| 緊急度 | low / medium / high / critical | ✅ |
| AI推薦 | 推薦アクション + バッジ色 | ✅ |
| 滞留時間 | 経過時間（2h超は赤色） | ✅ |
| 操作 | [承認] [拒否] [詳細] ボタン | — |

**一覧のルール:**
- デフォルトソート: 緊急度（高→低）→ 滞留時間（長→短）
- 行クリックで ② の詳細カードに表示
- 処理済み案件は一覧から消える（resolved / escalated）
- 処理済み履歴は別タブ or フィルタで表示可能

#### 操作時の確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| 承認 | 「この案件を承認しますか？（AI推薦: 承認 / 信頼度: 82%）」+ [キャンセル] [承認する] |
| 拒否 | 「拒否理由を入力してください」+ テキストエリア + [キャンセル] [拒否する]（赤ボタン） |
| 差戻し | 「差戻し理由を入力してください」+ テキストエリア + [キャンセル] [差戻す] |
| ブロック確定 | 「この取引をブロックしますか？ 加盟店（〇〇）に通知されます」+ [キャンセル] [ブロック] |
| 決済停止 | 「⚠️ 加盟店（〇〇）の決済を停止しますか？ 全取引が即時停止されます」+ [キャンセル] [停止する]（赤ボタン） |

### ビジネスルール

| ルール | 内容 |
|--------|------|
| 滞留アラート | 2時間超過で赤色バッジ + 管理者に通知 |
| 自動エスカレーション | 4時間超過で admin に自動エスカレーション |
| 操作ログ | 全操作を audit_logs に記録（誰が / いつ / 何を / 理由） |
| 同時操作防止 | WebSocketで「🔒 Aさんが対応中」をリアルタイム表示 + 楽観ロックで二重処理を完全防止 |
| AI推薦の表示義務 | 人間判断前にAI推薦を必ず表示（バイアス回避のため非表示オプションなし） |

#### 統計バー（② に表示）

| 統計項目 | 計算方法 |
|---------|---------|
| 今日の処理件数 | 本日の resolved + escalated の件数 |
| AI推薦との一致率 | (AI推薦通りに処理した件数 / 全処理件数) × 100% |

**❓ 未定義事項:**
- [x] ~~滞留時間のSLA定義~~ → **全カテゴリ共通で現行のまま**（2時間で赤バッジ、4時間で自動エスカレーション）
- [x] ~~同時操作防止の具体的な実装方法~~ → **WebSocket + 楽観ロックの併用**。WebSocketで「Aさんが対応中」をリアルタイム表示（🔒アイコン + 対応者名）。楽観ロックでDB側の二重処理を完全防止（後から押した人には「既に処理されました」と表示）
- [x] ~~処理済み案件の検索・再閲覧機能の要否~~ → **必要**。フィルタタブに「処理済み」を追加。処理者名・処理日時・処理結果を表示。操作ボタンは非表示（閲覧のみ）
- [x] ~~拒否/差戻し後の加盟店への自動通知テンプレート~~ → **開発時にテンプレートを作成**。メール通知テンプレート（拒否理由 / 差戻し理由を含む）
- [x] ~~統計表示~~ → **表示する（2項目）**。今日の処理件数 / AI推薦との一致率。~~平均処理時間~~ は不要

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B 内部: GET /api/v1/exception-queue | キュー一覧取得（フィルタ・ページネーション付き） |
| Zone B 内部: GET /api/v1/exception-queue/{id} | 案件詳細取得 |
| Zone B 内部: PUT /api/v1/exception-queue/{id}/resolve | 承認/拒否/差戻し処理 |
| Zone B 内部: WebSocket /ws/exception-queue | 新規案件のリアルタイム通知 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| exception_queue | キュー案件 |
| admin_user_categories | reviewer のカテゴリフィルタ |
| merchant_applications | 審査保留の詳細データ |
| transactions + fraud_alerts | 不正検知の詳細データ |
| url_patrol_results | URL巡回の詳細データ |
| settlement_batches + payout_records | 精算の詳細データ |
| audit_logs | 操作ログ記録 |

---

## M03: 加盟店管理

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M03 |
| メニューID | merchants |
| 画面名 | 加盟店管理 |
| 目的 | 全加盟店の状態を一覧管理する。接続先審査状況も確認できる |
| アクセス権 | super_admin / admin |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「加盟店管理 (N件)」                      │
│ [+ 手動登録] [📥 CSV] [📥 Excel] + 検索 + フィルタ │
├─────────────────────────────────────────────────┤
│ ① ソートインジケーター                             │
│   「並び替え: 加盟店ID ↑昇順」 [✕ リセット]        │
├─────────────────────────────────┬───────────────┤
│ ② 加盟店一覧テーブル（ソート7列）│ ⑤ スライド    │
│   ID | 名前 | ステータス | リスク│    パネル      │
│   接続先 | 月間売上 | CB率 |     │               │
│   成功率 | 手数料               │  企業情報      │
│   ※ 行クリックで接続先展開      │  リスク変更    │
│   ※ [詳細] ボタンでパネル表示   │  取引統計      │
│                                │  接続先状況    │
│ ③ 接続先審査状況パネル（展開時） │  操作:         │
│   フロー図 + 詳細テーブル       │  [サスペンド]  │
│   + AI提案                     │  [解約]        │
│                                │               │
├─────────────────────────────────┴───────────────┤
│ ④ 手動登録パネル（[+ 手動登録] 押下時にスライド表示）  │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### 検索・フィルタ

| 機能 | 仕様 |
|------|------|
| テキスト検索 | 加盟店名 or 加盟店ID で部分一致検索 |
| ステータスフィルタ | 全ステータス / 有効 / 審査中 / 停止中 |
| リスクフィルタ | 全リスク / 低 / 中 / 高 |
| 接続先数フィルタ | 全て / 1社のみ / 2社以上 / 3社以上 |

#### ソート対応カラム（7列）

| カラム | ソートキー | ソート方式 |
|--------|----------|----------|
| 加盟店ID | id | 文字列（自然順） |
| 加盟店名 | name | 日本語ロケール |
| リスク | riskOrder | 数値（低=1, 中=2, 高=3） |
| 月間売上 | salesNum | 数値 |
| CB率 | cbNum | 数値 |
| 成功率 | successNum | 数値 |
| 手数料 | feeNum | 数値 |

#### 接続先審査状況パネル（行クリックで展開）

| 要素 | 内容 |
|------|------|
| フロー図 | 接続先をカード形式で横並び表示。承認済み=緑、審査中=青(点滅)、準備中=灰、停止=赤 |
| 詳細テーブル | 接続先名 / 対応ブランド / 審査状況 / 承認日 / 累計取引 / ルーティング状態 / 操作ボタン |
| AI提案 | 接続先が1社のみで月間売上が一定以上 → 「接続先追加を推薦」メッセージ |
| 操作 | [+ 接続先審査を追加申請] ボタン → M09（接続先管理）へ遷移 |

#### ⑤ スライドパネル（加盟店詳細）

一覧の [詳細] ボタン押下で画面右側からスライド表示。一覧は左側に見えたまま操作可能。

**パネルのセクション構成:**

| セクション | 表示内容 | 編集可否 |
|-----------|---------|:-------:|
| 企業情報 | 法人名 / 法人番号 / 代表者 / 設立年月 / 資本金 / 所在地 / URL / 担当者 / 連絡先 | ✅ 編集可 |
| リスク情報 | 現在のリスクレベル + AI判定スコア + 変更ドロップダウン（低/中/高）+ 変更理由テキスト | ✅ 手動変更可 |
| 取引統計 | 月間売上 / 取引件数 / 成功率 / CB率 / 平均単価（直近3ヶ月推移ミニグラフ） | 閲覧のみ |
| サイト一覧 🆕 | サイト名 / URL / ステータス / 取引件数 / [詳細] [停止] + [サイト追加] ボタン | ✅ 停止可 |
| 接続先状況 | 接続先一覧（承認済み / 審査中 / 準備中）のサマリー | 閲覧のみ |
| リザーブ設定 | 接続先ごとのリザーブ率（%）/ リザーブ期間（90日/180日/365日）/ 現在の残高 / 次回解放額。変更は次回精算から適用 | ✅ 編集可 |
| 手数料 | ブランド別手数料率 / 入金サイクル（※サイト別に表示切替）| ✅ 編集可 |
| 代理店情報 🆕 | 紹介代理店名 / 代理店コード / 紹介日（代理店経由の場合のみ表示）| 閲覧のみ |
| メモ | 運営メモ（自由記述テキストエリア） | ✅ 編集可 |
| 操作 | [保存] [サスペンド] [解約] [全サイト一括停止] ボタン | — |

**リスクレベル手動変更のルール:**
- 変更時は理由入力が必須
- 変更前後のレベルと理由を audit_logs に記録
- AI判定スコアとの乖離がある場合は注意メッセージ表示（例: 「AI判定: 低リスク → 手動: 高リスク に変更します」）

**サスペンド/解約の確認ダイアログ:**

| 操作 | ダイアログ内容 |
|------|-------------|
| サスペンド | 「⚠️ 加盟店（〇〇）を停止しますか？ 全取引が即時停止されます。」+ 理由入力（必須）+ [キャンセル] [停止する]（赤ボタン） |
| 解約 | 「🚨 加盟店（〇〇）を解約しますか？ この操作は取り消せません。全取引停止 + アカウント無効化されます。」+ 理由入力（必須）+ 確認テキスト入力（加盟店名を入力させる）+ [キャンセル] [解約する]（赤ボタン） |

#### ④ 手動登録パネル（スライドパネル）

[+ 手動登録] ボタン押下で表示されるスライドパネル（右からスライド）。申込フォーム（P01）を経由せず直接登録する場合に使用。

| 項目 | 型 | 必須 |
|------|---|:---:|
| 法人名 | テキスト | ✅ |
| 法人番号 | 13桁数字 | ✅ |
| 代表者名 | テキスト | ✅ |
| 所在地 | テキスト | ✅ |
| 担当者名 | テキスト | ✅ |
| 担当者メール | email | ✅ |
| 担当者電話 | 電話番号 | ✅ |
| URL | URL | ✅ |
| 業種 | 選択（8種） | ✅ |
| 月間予想売上 | 数値 | ✅ |
| 初期リスクレベル | 選択（低/中/高） | ✅ |
| 登録理由 | テキストエリア | ✅ |

※ 手動登録は審査をスキップするため、audit_logs に「手動登録」として記録。AI審査は後から任意で実行可能。

#### エクスポート機能

| 項目 | 仕様 |
|------|------|
| 形式 | CSV / Excel（.xlsx）の選択 |
| 対象 | フィルタ適用中はフィルタ結果のみ。未適用時は全件 |
| 文字コード | CSV: UTF-8（BOM付き）、Excel: そのまま |
| 出力項目 | ID / 法人名 / ステータス / リスク / 接続先数 / 月間売上 / CB率 / 成功率 / 手数料率 / 登録日 |
| 上限 | 最大10,000件（超過時は期間を絞るよう案内） |

**❓ 未定義事項:**
- [x] ~~加盟店詳細ページは別途必要か~~ → **必要。スライドパネル方式**（右からスライド）で実装。一覧を左に見ながら詳細を編集可能
- [x] ~~加盟店のエクスポート機能~~ → **必要**。CSV / Excel 出力ボタンを一覧ヘッダーに配置。フィルタ適用中はフィルタ結果のみエクスポート
- [x] ~~加盟店の手動追加機能~~ → **必要**。[+ 手動登録] ボタンをヘッダーに配置。申込フォーム経由でなく直接登録できるフォーム
- [x] ~~リスクレベルの手動変更機能~~ → **必要**。スライドパネル内でリスクレベルを手動変更可能。変更理由の入力必須 + audit_logsに記録
- [x] ~~加盟店のサスペンド/解約操作~~ → **この画面（M03）のスライドパネル内で実行**。サスペンド/解約ボタン + 確認ダイアログ + 理由入力必須

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B 内部: GET /api/v1/merchants | 加盟店一覧（検索・フィルタ・ソート・ページネーション） |
| Zone B 内部: GET /api/v1/merchants/{id} | 加盟店詳細（スライドパネル用） |
| Zone B 内部: PUT /api/v1/merchants/{id} | 加盟店情報更新（企業情報・手数料・リスクレベル・メモ） |
| Zone B 内部: POST /api/v1/merchants | 加盟店手動登録 |
| Zone B 内部: PUT /api/v1/merchants/{id}/suspend | サスペンド処理 |
| Zone B 内部: PUT /api/v1/merchants/{id}/terminate | 解約処理 |
| Zone B 内部: GET /api/v1/merchants/export?format=csv | エクスポート（CSV / Excel） |
| Zone B 内部: GET /api/v1/merchants/{id}/processors | 接続先審査状況一覧 |
| API #15: GET /internal/v1/merchants/{id}/config | 加盟店設定（キャッシュ経由） |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| merchants | 加盟店マスタ（詳細表示・編集・手動登録・サスペンド/解約） |
| merchant_processors | 接続先審査状況 |
| processors | 接続先マスタ |
| processor_conditions | 手数料等の条件 |
| transactions | 月間売上・成功率・CB率の集計 |
| audit_logs | リスクレベル変更・手動登録・サスペンド/解約の操作ログ記録 |

---

## M04: 申込・登録管理

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M04 |
| メニューID | applications |
| 画面名 | 申込・登録管理 |
| 目的 | 新規加盟店の申込を管理し、AI審査フロー（5ステップ）を進行する |
| アクセス権 | super_admin / admin |
| 責任範囲 | Phase 1: 自社審査のみ（接続先審査は M09 で管理） |

### UIエリア構成

```
┌───────────────┬─────────────────────────────────┐
│ ① 申込一覧     │ ② 選択中の申込 — 詳細           │
│  （左サイドバー）│                                │
│ ┌───────────┐ │ ヘッダー: ID + 加盟店名 + 申込日  │
│ │ APP-003   │ │                                │
│ │ AI審査中   │ │ ③ 審査5ステップ進捗バー          │
│ │ ●         │ │  [1 受付] → [2 書類] → [3 AI]   │
│ ├───────────┤ │  → [4 判定] → [5 承認]          │
│ │ APP-002   │ │                                │
│ │ 書類確認中  │ │ ④ ステップ別の詳細コンテンツ      │
│ ├───────────┤ │                                │
│ │ APP-001   │ │ ⑤ スコープ図                     │
│ │ 自社承認済  │ │ 「自社審査はここまで。                │
│ └───────────┘ │  接続先審査は接続先管理画面へ」     │
│               │                                │
│               │ ⑥ 操作ボタン                     │
│               │  [承認] [却下] [AI再審査]          │
│               │  [接続先審査を開始]                │
└───────────────┴─────────────────────────────────┘
```

### 機能詳細

#### 審査5ステップ

| Step | 名前 | 処理内容 | 自動/手動 |
|:----:|------|---------|:-------:|
| 1 | 申込受付 | 申込データの取り込み + 書類一覧の確認 | 自動 |
| 2 | 書類確認 | 必須書類の揃い確認 + OCR解析 | 自動 |
| 3 | AI審査 | 反社チェック + 財務分析 + サイト分析 + リスクスコア算出 | 自動（AI） |

**AI審査プログレスバー（Step 3 実行中の表示）:**

| 段階 | 表示テキスト | 目安時間 |
|:----:|------------|:-------:|
| 1/5 | 反社チェック... | 5秒 |
| 2/5 | 財務分析... | 10秒 |
| 3/5 | サイト分析... | 30秒 |
| 4/5 | リスクスコア算出... | 10秒 |
| 5/5 | 総合判定... | 5秒 |

- WebSocketで各段階の完了をリアルタイム通知
- 完了した段階は ✅ 表示、実行中は 🔄（アニメーション）、待機中は ⏳
- 全段階完了後、結果を自動表示（承認推薦 / 却下推薦 / 要人間判定）
- タイムアウト: 3分超過で「AI審査がタイムアウトしました。[再実行]」を表示
| 4 | 人間判定 | AI結果を確認し、承認/却下/差戻しを判断 | 手動 |
| 5 | 自社承認 | 最終承認 → 接続先審査への橋渡し | 手動 |

**各ステップの詳細表示:**

| Step | 表示内容 |
|:----:|---------|
| 1 | 申込フォームの入力内容一覧（企業情報・事業内容・決済設定） |
| 2 | 提出書類一覧（ファイル名 / ステータス: ✅受領 / ⚠️不足 / 📄OCR解析中）|
| 3 | AI審査結果（反社チェック / 財務スコア / サイト分析 / 総合リスクスコア + AI推薦） |
| 4 | 人間判定フォーム（承認理由 or 却下理由のテキストエリア） |
| 5 | 自社承認完了 + 「接続先審査を開始」ボタン + 初期接続先のAI推薦表示 |

#### 操作ボタンと確認ダイアログ

| ボタン | 表示条件 | ダイアログ |
|--------|---------|----------|
| 承認 | Step 4 以降 | 「この加盟店を承認しますか？」 |
| 却下 | Step 4 以降 | 「却下理由を入力してください」（必須） |
| AI再審査 | Step 3 完了後 | 「最新データでAI審査を再実行しますか？（約30秒〜2分）」 |
| 接続先審査を開始 | Step 5 承認後 | 「接続先を選択してください」+ AI推薦接続先のリスト + [開始する] |
| 再申込を許可 | 却下後 | 「この申込のデータを引き継いで再申込を許可しますか？」→ 加盟店に再申込リンクをメール送信。P01の各ステップに既存データがプリセットされた状態で開く |

**❓ 未定義事項:**
- [x] ~~書類不足時の自動リマインドメール~~ → **不要**。申込フォーム（P01）で必須書類は提出済み。AI審査後の追加書類要求や運営差戻しはM02の通知テンプレートでカバー
- [x] ~~AI審査の所要時間の表示~~ → **プログレスバー方式（5段階）**。WebSocketで各ステップの完了を通知し、リアルタイムで進捗表示（反社チェック→財務分析→サイト分析→リスクスコア算出→総合判定）
- [x] ~~却下後の再申込フロー~~ → **既存データを引き継ぐ**。却下された申込の入力データを復元した状態で再申込可能
- [x] ~~複数管理者の同時操作~~ → **M02と同じWebSocket + 楽観ロックの併用**
- [x] ~~申込の期限~~ → **なし**。期限による自動却下は行わない

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B 内部: GET /api/v1/applications | 申込一覧 |
| Zone B 内部: GET /api/v1/applications/{id} | 申込詳細 |
| Zone B 内部: POST /api/v1/applications/{id}/review | AI審査実行 |
| Zone B 内部: WebSocket /ws/applications/{id}/review-progress | AI審査5段階の進捗通知 |
| Zone B 内部: PUT /api/v1/applications/{id}/approve | 承認処理 |
| Zone B 内部: PUT /api/v1/applications/{id}/reject | 却下処理 |
| Zone B 内部: POST /api/v1/applications/{id}/allow-reapply | 再申込許可（既存データ引継ぎ + メール送信） |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| merchant_applications | 申込データ |
| review_documents | 提出書類 |
| merchants | 承認後の加盟店レコード作成 |
| exception_queue | AI審査でグレー判定の場合のキュー投入 |
| audit_logs | 操作ログ |

---

## M05: AI監視

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M05 |
| メニューID | ai |
| 画面名 | AI監視 |
| 目的 | 全AIモジュールの稼働状況・精度・自動化率をモニタリングする |
| アクセス権 | super_admin / admin |
| 自動更新 | 60秒ごとにメトリクスをリフレッシュ |

### 表示するAIモジュール（4モジュール）

| モジュール | 主要メトリクス | 精度追跡指標 |
|-----------|-------------|------------|
| 不正検知AI | 日次判定件数 / 自動承認率 / 自動ブロック率 / 保留率 / 偽陽性率(FP率) | 偽陽性率（日次推移） |
| 審査AI | 今月の審査件数 / 自動承認率 / AI推薦→承認率 / 人的審査率 / 平均審査時間 | 人間同意率（日次推移） |
| チャットサポートAI | 今月の対話数 / AI完結率 / エスカレーション率 / 平均応答時間 / CSAT | AI完結率（日次推移） |
| レポートAI | 今月の生成数 / 日次サマリー数 / 月次レポート数 / カスタム分析数 / 平均生成時間 | 生成成功率（日次推移） |

**※ URL巡回AI とルーティングAI は各専用画面（M07, M10）で個別監視**

**各モジュールカードの表示要素:**
- メトリクス（上記の数値）
- 精度トレンドグラフ（直近30日の日次推移。折れ線グラフ）
- モデル情報: バージョン / 最終学習日 / 学習データ件数
- 有効/無効トグルスイッチ（無効化時は確認ダイアログ + audit_logs記録）

### KPI

| KPI | 目標 | 色の条件 |
|-----|:----:|---------|
| 全体自動化率 | 95% | 95%以上=紫(達成)、90-95%=黄、90%未満=赤 |
| 不正検知精度 | FP率 0.5%以下 | 0.5%以下=緑、0.5-1.0%=黄、1.0%超=赤 |

### AI判定 vs 人間判定の一致率分析

カテゴリ別（審査 / 不正検知 / URL巡回）に以下の4パターンを集計表示:

| パターン | 意味 | 色 |
|---------|------|---|
| AI承認 → 人間も承認 | 一致（問題なし） | 緑 |
| AI承認 → 人間が拒否 | AIが甘い | 赤 |
| AI拒否 → 人間が承認 | AIが厳しい | 黄 |
| AI拒否 → 人間も拒否 | 一致（問題なし） | 緑 |

- 表示期間: 今月 / 先月 / 直近3ヶ月の切替
- 一致率が80%を下回るカテゴリは ⚠️ アラート表示
- クリックで不一致案件の個別リスト（どの案件でズレたか）を表示

### Claude API 使用量・コスト

| 表示項目 | 内容 |
|---------|------|
| 月間トークン数 | 入力トークン / 出力トークン（別表示） |
| 月間API呼出回数 | 総呼出回数 |
| 月間コスト | ¥XX,XXX（モジュール別内訳の円グラフ） |
| 日次推移グラフ | 直近30日のコスト推移（折れ線） |
| モジュール別内訳 | 審査AI / 不正検知AI / チャットAI / レポートAI / URL巡回AI / ルーティングAI の6モジュール |

**❓ 未定義事項:**
- [x] ~~各AIモジュールの精度トレンドグラフ~~ → **必要**。日次推移グラフを表示。不正検知AI=偽陽性率、審査AI=人間同意率、チャットAI=AI完結率、レポートAI=生成成功率。日次バッチで集計
- [x] ~~AIモデルのバージョン情報・最終学習日時~~ → **表示する**。各モジュールカードにバージョン / 最終学習日 / 学習データ件数を表示
- [x] ~~AI判定 vs 人間判定の一致率~~ → **表示する（4パターン分析）**。①AI承認→人間承認（一致）、②AI承認→人間拒否（AIが甘い）、③AI拒否→人間承認（AIが厳しい）、④AI拒否→人間拒否（一致）。カテゴリ別（審査/不正検知/URL巡回）に一致率と傾向を表示
- [x] ~~AIモジュールの有効/無効切替~~ → **必要**。各モジュールにトグルスイッチ。無効化時は確認ダイアログ（「このモジュールを無効にすると、該当カテゴリは全件が例外キューに送られます」）+ audit_logs記録
- [x] ~~Claude API の使用量・コスト表示~~ → **必要**。月間トークン数（入力/出力別）/ 月間API呼出回数 / 月間コスト（¥）/ モジュール別内訳。日次推移グラフ付き

---

## M06: 注文管理

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M06 |
| メニューID | orders |
| 画面名 | 注文管理 |
| 目的 | 取引のリアルタイム監視と、過去取引の検索・返金・キャンセル操作を行う |
| アクセス権 | super_admin / admin（全操作）/ reviewer（閲覧のみ、返金・キャンセル不可） |
| URL共有 | フィルタ条件をURLクエリパラメータに反映（例: /admin/orders?tab=search&processor=gmo-pg&status=failed） |

### タブ構成（2タブ）

| タブ | 目的 | 主な利用シーン |
|------|------|-------------|
| リアルタイム | 取引をリアルタイムで監視する | 日常の監視業務・障害時の状況把握 |
| 取引検索 | 過去の取引を検索・返金・キャンセルする | 加盟店からの問い合わせ対応・返金処理 |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「注文管理」                              │
│ [リアルタイム] [取引検索]  ← タブ切替              │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【リアルタイムタブ】                               │
│ ┌──────────────────┬────────────────────────┐   │
│ │ ① 取引フィード    │ ② 取引詳細パネル       │   │
│ │ （LIVE 5秒更新）  │ （選択した取引の詳細）  │   │
│ │ 🔴 LIVE          │  ルーティング判定結果   │   │
│ │ TXN-14523 ¥12,800│  3DS認証結果          │   │
│ │ TXN-14522 ¥3,400 │  接続先レスポンス      │   │
│ │ TXN-14521 ¥89,000│  フェイルオーバー履歴  │   │
│ │ ...              │  タイムライン          │   │
│ ├──────────────────┴────────────────────────┤   │
│ │ ③ 接続先別レスポンス + ④ ブランド別分布     │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【取引検索タブ】                                  │
│ ┌───────────────────────────────────────────┐   │
│ │ ⑤ 検索フォーム                             │   │
│ │ 取引ID / 加盟店 / カード下4桁 / 金額範囲    │   │
│ │ 日時範囲 / ステータス / ブランド / 接続先    │   │
│ ├───────────────────────────────────────────┤   │
│ │ ⑥ 検索結果テーブル                         │   │
│ │ ID | 加盟店 | 金額 | ブランド | ステータス   │   │
│ │ 日時 | 接続先 | 操作: [返金] [キャンセル]    │   │
│ ├──────────────────┬────────────────────────┤   │
│ │ ⑦ 取引詳細       │ ⑧ 返金/キャンセル      │   │
│ │（スライドパネル）  │   操作パネル            │   │
│ └──────────────────┴────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### 【リアルタイムタブ】

##### ① 取引フィード

| 項目 | 仕様 |
|------|------|
| 更新頻度 | **5秒ごと**（WebSocket） |
| LIVE表示 | 🔴 LIVE インジケーター（点滅） |
| 最大表示 | 50件（スクロール可能） |
| フィルタ | ステータス / ブランド / 接続先（URLパラメータに反映） |
| ハイライト | 失敗=赤色、フェイルオーバー=黄色 |

| カラム | 内容 |
|--------|------|
| 取引ID | TXN-YYYYMMDD-NNNNN |
| 加盟店名 | — |
| 金額 | ¥XX,XXX |
| ブランド | VISA / MC / JCB / AMEX / QR |
| 接続先 | 処理した接続先名 |
| ステータス | 成功(緑) / 失敗(赤) / 処理中(黄) / 3DS待ち(青) |
| 時刻 | HH:MM:SS |
| レスポンス | XXXms |
| ルーティング | AI最適化 / ブランドマッピング / 加盟店固定 / フェイルオーバー |

##### ② 取引詳細パネル（行クリックで表示）

| セクション | 内容 |
|-----------|------|
| 基本情報 | 取引ID / 金額 / ブランド / 加盟店名 / カード下4桁 / BIN6桁 |
| ルーティング判定 | 選択された接続先 / 判定理由 / フォールバック候補 / 判定所要時間 |
| 3DS認証 | 認証結果(Y/N/A/U/R) / ECI / CAVV |
| 接続先レスポンス | レスポンスコード / レスポンスタイム / 生のレスポンス（マスク済み） |
| フェイルオーバー | フェイルオーバー回数 / 各試行の結果 |
| タイムライン | リクエスト受信 → ルーティング → 3DS → 決済実行 → レスポンス の各タイムスタンプ |
| 操作 | [取引検索タブで開く] リンク（返金等の操作はそちらで行う） |

##### ③ 接続先別レスポンスタイム

| 表示 | 仕様 |
|------|------|
| グラフ種類 | 横棒グラフ（接続先ごと） |
| データ | 直近1時間の平均レスポンスタイム + 最大値 |
| 色 | 200ms以下=緑、200-500ms=黄、500ms超=赤 |

##### ④ ブランド別・時間帯別分布

| 表示 | 仕様 |
|------|------|
| ブランド別 | 円グラフ（VISA / MC / JCB / AMEX / QR の割合） |
| 時間帯別 | ヒートマップ（0-23時の取引量を色の濃淡で表示） |

#### 【取引検索タブ】

##### ⑤ 検索フォーム

| 検索条件 | 入力方式 |
|---------|---------|
| 取引ID | テキスト入力（部分一致） |
| 加盟店名 | テキスト入力（部分一致）or ドロップダウン選択 |
| カード下4桁 | 4桁数字入力 |
| 金額範囲 | 最小金額 〜 最大金額 |
| 日時範囲 | 開始日時 〜 終了日時（デフォルト: 直近7日） |
| ステータス | チェックボックス（成功 / 失敗 / 返金済 / キャンセル / 3DS失敗） |
| ブランド | チェックボックス（VISA / MC / JCB / AMEX / QR） |
| 接続先 | ドロップダウン（全接続先から選択） |

- 全フィルタ条件がURLクエリパラメータに反映される
- [検索条件をクリア] ボタン
- ページネーション: 1ページ20件（20/50/100件切替可能）

##### ⑥ 検索結果テーブル

| カラム | 内容 | ソート |
|--------|------|:----:|
| 取引ID | TXN-YYYYMMDD-NNNNN | ✅ |
| 加盟店名 | — | ✅ |
| 金額 | ¥XX,XXX | ✅ |
| ブランド | バッジ表示 | ✅ |
| ステータス | 成功(緑) / 失敗(赤) / 返金済(紫) / キャンセル(灰) | ✅ |
| 日時 | YYYY-MM-DD HH:MM:SS | ✅ |
| 接続先 | — | ✅ |
| 操作 | [返金] [キャンセル] ボタン（ロール権限による表示制御） | — |

##### ⑦ 取引詳細（スライドパネル）

リアルタイムタブの②と同じ内容 + 以下を追加:

| 追加セクション | 内容 |
|-------------|------|
| 返金履歴 | この取引に対する返金の履歴（日時 / 金額 / 操作者 / ステータス） |
| 関連取引 | 同一カード下4桁の直近取引5件 |

##### ⑧ 返金/キャンセル操作

| 操作 | 条件 | 確認ダイアログ |
|------|------|-------------|
| 全額返金 | ステータスが「成功」の取引 | 「取引ID: TXN-XXX の全額（¥XX,XXX）を返金しますか？ 処理に1-3営業日かかります」+ [キャンセル] [返金する] |
| 一部返金 | ステータスが「成功」の取引 | 返金金額入力（元金額以下のバリデーション）+ 「¥XX,XXX を返金しますか？」+ [キャンセル] [返金する] |
| キャンセル | ステータスが「処理中」or「3DS待ち」の取引 | 「この取引をキャンセルしますか？」+ [いいえ] [キャンセルする]（赤ボタン） |

**ロール別の操作権限:**

| ロール | 閲覧 | 返金 | キャンセル |
|--------|:---:|:---:|:--------:|
| super_admin | ✅ | ✅ | ✅ |
| admin | ✅ | ✅ | ✅ |
| reviewer | ✅ | ❌ | ❌ |

**❓ 未定義事項:**
- [x] ~~リアルタイムフィードの更新頻度~~ → **5秒ごと（WebSocket）**
- [x] ~~取引の手動キャンセル/返金操作~~ → **取引検索タブで実行可能**。super_admin / admin のみ。reviewer は閲覧のみ
- [x] ~~フィルタしたURLの共有~~ → **URLクエリパラメータにフィルタ条件を反映**。ブックマーク・Slack共有可能
- [x] ~~過去の取引を日時範囲で検索する機能~~ → **取引検索タブとして統合**。リアルタイムタブとタブ切替
- [x] ~~CSV / Excel エクスポート機能~~ → **不要**（取引検索タブで十分。必要に応じて将来追加）

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B 内部: WebSocket /ws/transactions/live | リアルタイム取引フィード（5秒更新） |
| Zone B 内部: GET /api/v1/transactions | 取引検索（フィルタ・ソート・ページネーション） |
| Zone B 内部: GET /api/v1/transactions/{id} | 取引詳細 |
| Zone B 内部: POST /api/v1/transactions/{id}/refund | 返金処理（全額/一部） |
| Zone B 内部: POST /api/v1/transactions/{id}/cancel | キャンセル処理 |
| Zone B 内部: GET /api/v1/transactions/stats | 接続先別レスポンス・ブランド別分布 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| transactions | 取引データ |
| routing_logs | ルーティング判定結果・フェイルオーバー履歴 |
| refunds | 返金履歴 |
| fraud_alerts | 不正検知結果（詳細パネル） |
| processors | 接続先マスタ |
| merchants | 加盟店マスタ |
| audit_logs | 返金・キャンセル操作ログ |

### 画面遷移

| 操作 | 遷移先 |
|------|-------|
| リアルタイムタブの取引クリック → [取引検索タブで開く] | 取引検索タブ（該当取引IDでフィルタ） |
| M01ダッシュボードのグラフ棒クリック | リアルタイムタブ（該当日でフィルタ） |

## M07: 不正検知設定

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M07 |
| メニューID | fraud |
| 画面名 | 不正検知設定 |
| 目的 | 不正検知ルールの管理、AIモデルの閾値調整、ブロック/ホワイトリスト管理 |
| アクセス権 | super_admin / admin |

### タブ構成（5タブ）

#### タブ1: ルール管理

| 機能 | 仕様 |
|------|------|
| ルール一覧 | ID / ルール名 / 種別 / 条件 / アクション / 優先度 / 有効/無効 / 直近30日のヒット数 |
| ルール追加 | [+ ルール追加] → モーダルダイアログで新規ルール作成 |
| ルール編集 | 行クリック → 編集フォーム |

#### ルール追加モーダル

[+ ルール追加] ボタン押下で画面中央にモーダル表示。

| 入力項目 | 入力方式 | 必須 |
|---------|---------|:---:|
| ルール種別 | ドロップダウン（金額閾値 / 速度チェック / 地域制限 / 時間帯+金額 / AI判定スコア / パターン検知 / リスト照合 / カスタム条件）| ✅ |
| ルール名 | テキスト入力 | ✅ |
| 条件設定 — 対象フィールド | ドロップダウン（金額 / カード発行国 / BIN / AIスコア / 取引回数 / 時間帯 / 初回取引フラグ）| ✅ |
| 条件設定 — 演算子 | ドロップダウン（＞ / ≧ / ＝ / ≠ / ＜ / 含む / 含まない）| ✅ |
| 条件設定 — 値 | テキスト入力（数値 or 文字列）| ✅ |
| AND条件追加 | [+ AND条件を追加] で複数条件を組み合わせ可能 | — |
| 検知時のアクション | ラジオボタン3択（自動ブロック / 例外キュー送り / フラグのみ）デフォルト: 例外キュー送り | ✅ |
| 優先順位 | 数値入力（1〜99。小さいほど先に評価）| ✅ |
| 適用スコープ | ドロップダウン（グローバル / 加盟店指定）| — |
| テストモード | トグルスイッチ（ON: 実際のブロックは行わず検知ログにのみ記録）| — |

**フッター:** [キャンセル] [ルールを作成] ボタン
| 有効/無効切替 | トグルスイッチ（即時反映 + 確認ダイアログ） |
| 優先度変更 | ドラッグ&ドロップで並べ替え |
| シミュレーション | [シミュレーション実行] → 過去30日の取引データに対して変更後ルールを適用 → ブロック増減件数 + 影響加盟店を表示 |
| 承認フロー | adminがルール変更を申請 → super_adminが確認・承認 → 本番反映。super_adminは直接変更可能 |

**デフォルトルール（8種）:**

| ID | ルール名 | 種別 | 条件 | アクション |
|----|---------|------|------|----------|
| FR-001 | 高額取引チェック | 金額閾値 | 金額 > ¥500,000 | 例外キュー送り |
| FR-002 | 短時間連続取引 | 速度チェック | 同一カード 5分以内に3件以上 | 自動ブロック |
| FR-003 | 海外カード制限 | 地域制限 | 発行国 ≠ JP かつ 金額 > ¥100,000 | 例外キュー送り |
| FR-004 | 深夜帯高額 | 時間帯+金額 | 0:00〜6:00 かつ 金額 > ¥200,000 | 例外キュー送り |
| FR-005 | デバイスフィンガープリント | デバイス | 同一デバイスから異なるカード3枚以上 | 自動ブロック |
| FR-006 | AIスコアチェック | AIスコア | 不正スコア > 0.7 | 自動ブロック |
| FR-007 | AIスコア（グレー） | AIスコア | 不正スコア 0.4〜0.7 | 例外キュー送り |
| FR-008 | BINブロックリスト | リスト照合 | BIN6桁がブロックリストに存在 | 自動ブロック |

#### タブ2: AIモデル設定

| 機能 | 仕様 |
|------|------|
| 閾値スライダー | ブロック閾値（デフォルト: 0.7）/ レビュー閾値（デフォルト: 0.4）をスライダーで調整 |
| 特徴量重要度 | XGBoost の特徴量重要度上位10件をバーチャートで表示 |
| テストモード | シャドーモード ON/OFF（判定するが実際にはブロックしない） |
| モデル情報 | モデルバージョン / 最終学習日 / 学習データ件数 / AUC-ROC |
| 自動再学習 | スケジュール: 毎週日曜 AM3:00 / 状態表示（次回実行日時 / 前回実行結果） |
| モデル切替 | 新モデル準備完了時に通知バナー表示。精度比較（旧 vs 新）+ [本番に切替] [却下] ボタン |

**自動再学習の安全フロー:**

| Step | 処理 | 本番への影響 |
|:----:|------|:----------:|
| 1 | 毎週日曜 AM3:00に自動で再学習実行 | なし |
| 2 | 新モデルをシャドーモードで1週間並行稼働 | なし（判定結果は記録のみ） |
| 3 | 精度比較結果を管理画面に通知（偽陽性率の改善/悪化） | なし |
| 4 | 人間が [本番に切替] or [却下] を判断 | 切替時のみ反映 |

※ 自動で本番切替はしない。必ず人間が確認してからスイッチ

#### タブ3: ブロック/ホワイトリスト

| 機能 | 仕様 |
|------|------|
| リスト種別 | BINブロック / IPブロック / デバイスブロック / IPホワイト / BINホワイト |
| 追加 | [+ 追加] → 値入力 + 理由 + 期限（永久 or 日時指定） |
| 一括追加 | CSV アップロードで一括登録 |
| 検索 | 値で部分一致検索 |
| 削除 | 確認ダイアログ付き |

#### タブ4: 検知ログ

| 機能 | 仕様 |
|------|------|
| ログ一覧 | 日時 / 取引ID / 加盟店名 / 金額 / 不正スコア / トリガーされたルール / アクション(ブロック/レビュー/通過) |
| フィルタ | 期間 / アクション種別 / スコア範囲 |
| 詳細 | 行クリック → 判定の詳細（スコア内訳・トリガーされた全ルール・タイムライン） |

#### タブ5: 加盟店別設定

加盟店ごとにグローバルルールの閾値をオーバーライドする機能。業態に合わせた柔軟な設定で健全な決済を止めない。

| 機能 | 仕様 |
|------|------|
| 加盟店選択 | テキスト検索付き加盟店セレクター（ID・名前で検索可能） |
| オーバーライド一覧 | この加盟店に適用されているカスタム設定の一覧 |
| 設定追加 | [+ カスタム設定を追加] → ルール選択 → カスタム閾値入力 |
| 設定削除 | カスタム設定を削除 → グローバルルールに戻る |

**カスタマイズ可能な項目:**

| ルール | グローバル値 | カスタム例（高額店舗） | カスタム例（少額大量店） |
|--------|:----------:|:-------------------:|:--------------------:|
| 高額取引チェック閾値 | ¥500,000 | ¥2,000,000 に引上げ | ¥300,000 に引下げ |
| 短時間連続取引 | 5分/3件 | 5分/3件（変更なし） | 5分/10件 に緩和 |
| 海外カード制限 | ¥100,000 | ¥500,000 に引上げ | ¥50,000 に引下げ |
| 深夜帯高額 | ¥200,000 | ¥1,000,000 に引上げ | ¥200,000（変更なし） |
| AIスコア ブロック閾値 | 0.7 | 0.8 に緩和 | 0.7（変更なし） |
| AIスコア レビュー閾値 | 0.4 | 0.5 に緩和 | 0.3 に厳格化 |

**表示:**
- グローバル値とカスタム値を並べて表示（差分が一目でわかる）
- カスタム設定がある場合は ⚠️ バッジで「カスタム適用中」を表示
- 設定変更時はシミュレーション実行可能（該当加盟店の過去取引データに対して）

**❓ 未定義事項:**
- [x] ~~ルール変更時のテスト実行機能~~ → **必要**。ルール編集画面に [シミュレーション実行] ボタン。過去30日の取引データに対して変更後のルールを適用し、「ブロック増加/減少件数」「影響を受ける加盟店」を表示してから本番反映
- [x] ~~ルール変更の承認フロー~~ → **admin → super_admin の2段階承認**。adminがルール変更を申請 → super_adminが確認・承認 → 本番反映。super_adminは直接変更可能
- [x] ~~XGBoost モデルの再学習トリガー~~ → **自動スケジュール（毎週日曜 AM3:00）+ シャドーモード + 人間切替**。再学習後は新モデルをシャドーモード（判定するが本番に影響なし）で1週間並行稼働。精度比較結果を管理画面に通知し、人間が [本番に切替] を判断。自動切替はしない
- [x] ~~加盟店別にルールをカスタマイズする機能~~ → **必要**。加盟店ごとにルールの閾値をオーバーライド可能（例: 高額取引店は金額閾値を引き上げ）。M03スライドパネル or M07に「加盟店別設定」タブで管理
- [x] ~~誤検知報告フロー~~ → **軽量に実装**。加盟店画面（S02）のブロック取引に [正当な取引として報告] ボタン → 例外キューに投入 → 運営確認。ただし主な対策は加盟店別ルールカスタマイズで誤検知自体を防ぐ方針

**設計方針:** 全体的に「健全な決済を止めない」ことを最優先とする。がちがちにしすぎず、加盟店の業態に合わせた柔軟なルール設定で対応する

---

## M08: 精算・入金

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M08 |
| メニューID | settlement |
| 画面名 | 精算・入金 |
| 目的 | 精算バッチの実行状況確認、入金エラーの対応 |
| アクセス権 | super_admin / admin |

### 機能

| 機能 | 仕様 |
|------|------|
| 月次切替 | ドロップダウンで対象月を選択 |
| 精算バッチ実行 | [精算バッチ実行] ボタン → 確認ダイアログ → バッチ処理開始 |
| バッチ一覧 | バッチID / 対象期間 / 接続先 / 総取引額 / 手数料 / 精算額 / ステータス / 実行日時 |
| エラー詳細 | エラーのあるバッチを展開 → エラー内容 + 対象加盟店 + 操作ボタン |
| 手動入金 | エラー案件に対して [手動入金実行] ボタン + 確認ダイアログ |
| エスカレーション | 解決できないエラーを [エスカレーション] → 例外キューに投入 |
| リザーブKPI | リザーブ総額 / 今月解放予定 / 来月解放予定 / 新規留保（今月）の4カード |
| リザーブ検索 | 加盟店ID・名前でインクリメンタル検索 / 接続先フィルタ / 種別フィルタ（留保/解放） |
| リザーブ一覧 | 加盟店×接続先ごとのリザーブ率・期間・残高・次回解放額・解放予定日をテーブル表示 |
| 加盟店別精算内訳 | 加盟店ごとの売上・手数料・CB差引・リザーブ留保・リザーブ解放・入金額 |

**❓ 未定義事項:**
- [x] ~~精算バッチの自動実行スケジュール~~ → **開発時に詳細設計**。接続先（流し先）によってスケジュールが異なるため、接続先別に設定可能な設計とする
- [x] ~~精算レポートのPDFエクスポート~~ → **不要**
- [x] ~~加盟店別の精算詳細~~ → **必要**。加盟店別の入金内訳を表示。**ローリングリザーブ（デポジット）設定も必要**：接続先ごとにリザーブ率（例: 10%）とリザーブ期間（例: 180日）を設定し、留保額・解放予定額を表示
- [x] ~~入金サイクル~~ → **支払い設計後に詳細決定**。接続先別の入金サイクル（締め日・支払日）は支払いフローの詳細設計時に決定
- [x] ~~手動入金の承認フロー~~ → **adminで実行可能**（super_admin承認は不要）。audit_logsに記録

---

## M09: 接続先管理

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M09 |
| メニューID | processors |
| 画面名 | 接続先管理 |
| 目的 | 接続先（決済会社）の管理、加盟店ごとの接続先審査フローを進行する |
| アクセス権 | super_admin / admin |
| 責任範囲 | Phase 2: 接続先審査（自社審査後の外部プロセッサーとのやり取り） |

### タブ構成（4タブ）

#### タブ1: 接続先一覧

| 表示 | 内容 |
|------|------|
| テーブル | 接続先名 / 種別 / ステータス / 対応ブランド / アクティブ加盟店数 / 直近成功率 / 平均レスポンス |
| クリック | 接続先詳細（稼働統計・接続設定・API設定） |

#### タブ2: 審査フロー管理（7ステップ）

| Step | 名前 | 操作 | 確認ダイアログ |
|:----:|------|------|-------------|
| 1 | 審査申請 | [審査申請を送信] | 「接続先に審査を申請しますか？」 |
| 2 | 書類送付 | [書類を送付] | 「以下の書類を送付しますか？」+ 書類一覧 |
| 3 | 接続先審査中 | — | 接続先の審査結果を待つ（ステータス自動更新） |
| 4 | 追加書類対応 | [追加書類を要求] / [追加書類を送付] | — |
| 5 | 条件確定 | 条件入力フォーム + [条件を登録] | 手数料率・入金サイクル等の入力 |
| 6 | 契約書送付 | [契約書を生成・送付] | 条件確定後に自動生成 |
| 7 | 決済開始 | [決済開始] | 「この加盟店の決済を開始しますか？」 |

**条件入力フォーム（Step 5）:**

| 項目 | 型 | 例 |
|------|---|---|
| ブランド別手数料率 | VISA: X.XX%, MC: X.XX%, JCB: X.XX% | VISA: 3.25% |
| 入金サイクル | 選択（月2回 / 月末 / 週次） | 月2回 |
| CB手数料 | ¥X,XXX/件 | ¥1,500/件 |
| 取引上限 | ¥X,XXX,XXX/件 | ¥1,000,000/件 |
| 個別条件 | テキストエリア | — |

#### タブ3: 完了履歴

| 表示 | 内容 |
|------|------|
| テーブル | 加盟店名 / 接続先 / 審査開始日 / 完了日 / 結果(承認/却下) / 所要日数 |

#### タブ4: 資料管理

| 機能 | 仕様 |
|------|------|
| 書類一覧 | 加盟店別の提出書類一覧（種別 / ステータス / アップロード日） |
| アップロード | ドラッグ&ドロップでファイルアップロード |
| ダウンロード | 個別DL + 一括DL（ZIP） |

**❓ 未定義事項:**
- [x] ~~接続先のAPI設定~~ → **不要**。接続先はコアシステム（CDE内）で接続するため、管理画面側にはAPI設定画面は不要
- [x] ~~接続先の手数料率の定期見直しリマインド~~ → **不要**。接続先ごとのカードブランド制限があり、加盟店審査通過後に個別設定されるため一括設定はない
- [x] ~~接続先との契約更新フロー~~ → **不要**。管理画面での管理対象外
- [x] ~~新規接続先の追加登録フロー~~ → **マスタ登録のみ**。プロセッサーマスタ（接続先名・対応ブランド・ステータス等）の新規作成・編集は可能。詳細設計は開発時

---

## M10: ルーティング

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M10 |
| メニューID | routing |
| 画面名 | ルーティング |
| 目的 | AIルーティングの設定、ルール管理、接続先別の分配状況を確認する |
| アクセス権 | super_admin / admin |

### 機能

| 機能 | 仕様 |
|------|------|
| 加盟店選択 | テキスト検索付き加盟店セレクター（ID・名前でインクリメンタル検索）。選択時に承認済み接続先の表示が変わる。「グローバル設定」を選ぶと全体ルール編集 |
| ルール一覧 | 9種のルールを優先順位付きで表示 + 有効/無効トグル |
| 判定フロー図 | リクエスト → ルール適用 → AI最適化 → 接続先選択 のフロー図 |
| 接続先別分布 | 円グラフ（各接続先への振り分け割合） |
| フェイルオーバー設定 | 最大リトライ回数 / タイムアウト閾値 / フェイルオーバー候補の優先順位 |

**ルーティングルール（9種）:**

| 優先度 | ルール | 説明 |
|:-----:|--------|------|
| 1 | ブランドマッピング | ブランド → 対応接続先の固定マッピング |
| 2 | 加盟店固定 | 特定加盟店 → 特定接続先の固定ルール |
| 3 | 金額閾値 | 金額帯ごとの接続先振り分け |
| 4 | 時間帯ルール | 時間帯ごとの接続先振り分け |
| 5 | コスト最適化 | 手数料が最も安い接続先を選択 |
| 6 | 成功率重視 | 成功率が最も高い接続先を選択 |
| 7 | 負荷分散 | 接続先間で均等に分散 |
| 8 | AI動的最適化 | AIがリアルタイムで最適な接続先を選択 |
| 9 | フェイルオーバー | 前の接続先が失敗した場合の次候補 |

**❓ 未定義事項:**
- [x] ~~ルール変更のシミュレーション機能~~ → **必要**。M07と同様、過去30日の取引データでテスト実行。ルール変更前後の接続先振り分け差分・コスト差分・成功率差分を表示
- [x] ~~ルーティングログの検索・分析画面~~ → **M10にタブ追加**（M07の検知ログと同じ設計）。日時/取引ID/加盟店/ブランド/選択接続先/判定理由/フェイルオーバー有無でフィルタ。接続先別の振り分け比率・コスト推移のグラフ付き
- [x] ~~特定の接続先をメンテナンスモードにする操作~~ → **必須**。接続先ごとにメンテナンスモードON/OFFトグル。ON時はルーティング対象から自動除外。M01ダッシュボードのヘルス表示に🔵メンテナンス反映。確認ダイアログ + audit_logs記録

#### 一括ライン変更 🆕 v1.1

接続先が障害のとき、運営が手動で該当接続先を使っている全加盟店/サイトを別の接続先に一括で切り替える機能。

**操作フロー:**
```
1. [一括ライン変更] ボタン押下
2. 「変更元の接続先」をドロップダウンから選択
3. 「変更先の接続先」をドロップダウンから選択
4. 影響範囲プレビュー表示:
   - 影響加盟店数: XX社
   - 影響サイト数: XX件
   - 影響リカーリング設定数: XX件
   - 対象加盟店/サイト一覧（テーブル）
5. [リカーリング決済のラインも同時変更] チェックボックス
6. 確認ダイアログ:
   「⚠️ 接続先A → 接続先B に XX件のルーティングを一括変更します。
    この操作は即時反映されます。」
   + 理由入力（必須）
   + [キャンセル] [一括変更を実行]
7. 実行後: 成功件数 / 失敗件数を表示 + [元に戻す] ボタン
```

| 項目 | 仕様 |
|------|------|
| 復元機能 | 一括変更実行後24時間以内に [元に戻す] ボタンで変更前の状態に復元可能 |
| ログ | routing_change_logs に記録（変更者 / 変更日時 / 変更元 / 変更先 / 影響件数 / 理由） |
| サイト別 | サイト単位でのルーティングルールがある場合、そちらも変更対象に含む |

### 参照するDBテーブル 🆕 v1.1追記

| テーブル | 用途 |
|---------|------|
| sites | サイト別のルーティング（加盟店選択時にサイト一覧表示） |

---

## M11: レポート

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M11 |
| メニューID | report |
| 画面名 | レポート |
| 目的 | 各種レポートの生成・定期配信設定・過去レポートのダウンロード |
| アクセス権 | super_admin / admin |

### 機能

| 機能 | 仕様 |
|------|------|
| レポート生成 | [+ レポート生成] → テンプレート選択 → パラメータ入力 → AI生成 |
| テンプレート一覧 | 6種のレポートテンプレート |
| 定期配信スケジュール | 各テンプレートの定期実行設定（日次 / 週次 / 月次）+ 配信先メール |
| 生成済みレポート | 過去のレポート一覧 + ダウンロード（PDF / CSV） |
| AI要約 | 各レポートにAIが自然言語の要約を自動付与 |

**レポートテンプレート（6種）:**

| # | テンプレート名 | 内容 | デフォルト実行 |
|---|-------------|------|:----------:|
| 1 | 日次精算レポート | 当日の取引サマリー + 精算金額 | 毎日 23:00 |
| 2 | 月次サマリー | 月間のKPI + トレンド分析 | 毎月1日 |
| 3 | 加盟店別レポート | 指定加盟店の取引詳細 | オンデマンド |
| 4 | 接続先別レポート | 接続先ごとの成功率・コスト分析 | 月次 |
| 5 | チャージバックレポート | CB発生状況 + 原因分析 | 月次 |
| 6 | 不正検知レポート | 不正検知の統計 + ルール効果分析 | 月次 |

**❓ 未定義事項:**
- [x] ~~カスタムレポートの作成機能~~ → **必要**。テンプレートの項目（取引/精算/CB/接続先等）を自由に組み合わせてカスタムレポートを作成可能。保存して定期配信にも設定可
- [x] ~~レポートの配信先をSlackチャンネルに送る機能~~ → **必要**。配信先にメール + Slackチャンネルを選択可能。Slack Webhook URLを設定画面で登録
- [x] ~~レポートの自動生成失敗時のリトライ・通知~~ → **通知が必要**。自動生成失敗時はadminにメール+Slack通知。リトライは自動では行わず、通知を受けて手動で再実行

---

## M12: ユーザー管理

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M12 |
| メニューID | users |
| 画面名 | ユーザー管理 |
| 目的 | 運営スタッフの登録・ロール設定・担当カテゴリ割当・MFA管理 |
| アクセス権 | super_admin のみ（admin は閲覧のみ） |

### 機能

| 機能 | 仕様 |
|------|------|
| ユーザー一覧 | 名前 / メール / ロール / 担当カテゴリ / ステータス / 最終ログイン / MFA |
| 新規登録 | [+ 新規スタッフ登録] → 登録フォーム |
| 編集 | 行クリック → ロール変更・カテゴリ変更・ステータス変更 |
| カテゴリ割当 | reviewer の場合、4カテゴリ（審査/不正検知/URL巡回/精算）をチェックボックスで複数割当 |
| MFA管理 | MFA 有効/無効 + リセット |
| 無効化 | ユーザーを無効化（ログイン不可にする。削除はしない） |

**登録フォーム:**

| 項目 | 型 | 必須 |
|------|---|:---:|
| 名前 | テキスト | ✅ |
| メールアドレス | email | ✅ |
| ロール | 選択（super_admin / admin / reviewer） | ✅ |
| 担当カテゴリ | チェックボックス（reviewer の場合のみ表示） | reviewer 時必須 |
| 初期パスワード | 自動生成 + メール送信 | — |

**❓ 未定義事項:**
- [x] ~~パスワードポリシー~~ → **PCI DSS v4.0 Req 8.3.6準拠**。12文字以上 / 英大文字+小文字+数字+特殊文字 / 過去5回再利用禁止 / 90日有効期限
- [x] ~~ログイン試行回数制限~~ → **5回失敗で30分ロック**（PCI DSS v4.0 Req 8.3.4）。ブルートフォース対策: 10回/分で自動ブロック
- [x] ~~セッション管理~~ → **あり**。同時ログイン数: 3デバイスまで / セッションタイムアウト: 8時間（操作なしで自動ログアウト）
- [x] ~~招待制にするか~~ → **招待制**。メールで招待リンクを送る方式。既存のメール送信基盤（審査通知・精算通知等）を共用するため追加コストなし。招待リンクの有効期限: 72時間

---

## M13: システム設定

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M13 |
| メニューID | settings |
| 画面名 | システム設定 |
| 目的 | システム全体の設定変更（決済手段・通知・セキュリティ等） |
| アクセス権 | super_admin のみ |

### タブ構成（8タブ）← v1.1で3タブ追加

| タブ | 内容 |
|------|------|
| 決済手段 | 各決済手段（VISA/MC/JCB/AMEX/QR）の有効/無効トグル |
| 接続先管理 | 接続先のグローバル設定（タイムアウト / リトライ回数） |
| 通知設定 | 通知マトリクス（8イベント × 3チャネル: メール / Slack / 管理画面） |
| API設定 | 内部API のキー管理 / レートリミット設定 |
| セキュリティ | MFA強制 / IP制限 / セッション設定 |
| エラーコード一覧 🆕 | エラーコードマスターの閲覧・編集 |
| お知らせ管理 🆕 | 加盟店向けお知らせの作成・配信・管理 |
| 監査ログ 🆕 | 管理画面の操作ログ検索 |

#### エラーコード一覧タブ 🆕 v1.1

| 機能 | 仕様 |
|------|------|
| テーブル | エラーコード / カテゴリ / 日本語文言 / 対処法 / API対応 / リンク対応 / 有効/無効 |
| 検索 | エラーコード / カテゴリ / キーワード |
| 編集 | 行クリック → 文言・対処法の編集（エラーコード自体は変更不可） |
| 新規追加 | [+ エラーコード追加] → コード / カテゴリ / 文言 / 対処法を入力 |
| CSV出力 | エラーコード一覧のCSVダウンロード |

#### お知らせ管理タブ 🆕 v1.1

| 機能 | 仕様 |
|------|------|
| お知らせ一覧 | タイトル / 種別 / 優先度 / 公開状態 / 公開日 / 有効期限 |
| 新規作成 | [+ お知らせ作成] → タイトル / 本文（リッチテキスト）/ 種別 / 優先度 / 配信先 / 公開日時 / 有効期限 |
| 種別 | 障害情報（赤）/ メンテナンス（黄）/ 機能リリース（青）/ お知らせ（灰）|
| 配信先 | 全加盟店 / 特定加盟店（検索して複数選択）|
| 下書き保存 | 公開日時をNULLにして保存 = 下書き状態 |
| 即時公開 | [公開する] ボタンで即時公開 |
| 予約公開 | 公開日時を未来に設定して保存 → 時刻到来時に自動公開 |

#### 監査ログタブ 🆕 v1.1

| 機能 | 仕様 |
|------|------|
| テーブル | 日時 / 操作者 / ロール / 操作種別 / 対象 / 変更前 / 変更後 / IPアドレス |
| 検索 | 操作者 / 操作種別 / 期間 / 対象画面 |
| エクスポート | CSV出力 |

**通知マトリクス（8イベント）:**

| イベント | メール | Slack | 管理画面 |
|---------|:-----:|:-----:|:------:|
| 例外キュー新規 | ☐ | ☑ | ☑ |
| 例外キュー滞留(2h) | ☑ | ☑ | ☑ |
| 不正検知ブロック | ☐ | ☑ | ☑ |
| 接続先障害 | ☑ | ☑ | ☑ |
| 精算バッチエラー | ☑ | ☑ | ☑ |
| URL巡回アラート | ☐ | ☑ | ☑ |
| 新規申込 | ☐ | ☑ | ☑ |
| CB受領 | ☑ | ☑ | ☑ |

**❓ 未定義事項:**
- [x] ~~設定変更の監査ログ~~ → **必須**。全設定変更をaudit_logsに記録（変更者/変更日時/変更前の値/変更後の値）。システム設定画面内に監査ログ閲覧タブ
- [x] ~~設定変更の承認フロー~~ → **必須**。セキュリティ系設定（パスワードポリシー/IP制限/2FA設定等）はadmin申請 → super_admin承認。通常設定はadminが直接変更可能
- [x] ~~メンテナンスモード~~ → **必要**。管理画面・加盟店画面をメンテナンス表示に切替。**決済処理（Zone A/コアシステム）は停止しない**。メンテナンスバナー表示+新規操作の一時停止のみ
- [x] ~~バックアップ設定~~ → **必須**。DB / S3 の自動バックアップスケジュール設定・実行履歴・手動バックアップ実行ボタン。詳細はインフラ設計時に決定

---

# 加盟店管理画面

---

## S01: ダッシュボード

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S01 |
| メニューID | m_dashboard |
| 画面名 | ダッシュボード |
| 目的 | 加盟店が自社の売上・取引状況を一目で把握する |
| アクセス権 | merchant_owner / merchant_admin / merchant_viewer |
| データ範囲 | 自社のデータのみ表示（マルチテナント） |

### 機能

| 機能 | 仕様 |
|------|------|
| サイト切替 🆕 | ヘッダーのサイトセレクターで切替。「全サイト合算」と「サイト個別」を選択可 |
| お知らせ 🆕 | 運営からのお知らせを最新3件表示（種別バッジ付き）。[すべて見る]でモーダル表示 |
| KPI（4つ） | 今週の売上 / 決済成功率 / 本日の取引数 / 次回入金予定額 |
| 週間トレンド | 直近7日の売上推移グラフ |
| 決済手段別 | 円グラフ（VISA / MC / JCB / その他の割合） |
| AIインサイト | AIが加盟店のデータを分析して3件の提案を表示 |

**AIインサイトの例:**
- 「今週の売上は先週比+12%です。特にVISAカードの利用が伸びています」
- 「CB率が0.05%に上昇しています。3Dセキュア必須化を検討してください」
- 「火曜日と金曜日の取引が集中しています。サーバー負荷に注意してください」

**❓ 未定義事項:**
- [x] ~~KPIの期間切替~~ → **切替あり**。今日 / 今週 / 今月のトグル（M01ダッシュボードと同じUI）
- [x] ~~AIインサイトの更新頻度~~ → **1日1回**。日次バッチで更新。前日までのデータを元にAIサマリーを生成
- [x] ~~審査中の加盟店の表示~~ → **「現在審査中です」の案内表示**。KPI・グラフ領域はプレースホルダーで「審査完了後にデータが表示されます」と案内。審査ステータスの進捗バー（M04と連動）を表示

---

## S02: 取引一覧

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S02 |
| メニューID | m_transactions |
| 画面名 | 取引一覧 |
| 目的 | 自社の取引を検索・閲覧し、返金操作を行う |
| アクセス権 | merchant_owner / merchant_admin（返金操作可）/ merchant_viewer（閲覧のみ） |

### 機能

| 機能 | 仕様 |
|------|------|
| テーブル | 取引ID / 金額 / ブランド / ステータス / カード下4桁 / 日時 |
| 検索 | 取引ID / カード下4桁 / 金額範囲 / 期間 / ステータス |
| 返金操作 | [返金] ボタン → 返金金額入力 → 確認ダイアログ → 実行 |
| 詳細表示 | 行クリック → 取引詳細パネル（3DS結果・レスポンス等） |
| 誤検知報告 | ステータスが「ブロック」の取引に [正当な取引として報告] ボタン → 理由入力 → 運営の例外キューに投入 |

**返金の確認ダイアログ:**
```
返金を実行しますか？
取引ID: TXN-20260211-14523
元の金額: ¥12,800
返金金額: ¥12,800（全額返金 / 一部返金を選択可）
※ 返金処理には1-3営業日かかります

[キャンセル] [返金を実行する]
```

**❓ 未定義事項:**
- [x] ~~一部返金の金額入力バリデーション~~ → **要検討項目として先送り**。開発時に詳細設計（元金額以下・複数回返金時の累計チェック等）
- [x] ~~返金理由の入力は必要か~~ → **必要**。返金実行時に理由入力を必須とする（選択式+自由記述）
- [x] ~~返金の承認フロー~~ → **merchant_adminが直接実行可能**。merchant_ownerの承認は不要。audit_logsに記録
- [x] ~~取引のCSVエクスポート~~ → **あり（項目を絞る）**。出力項目: 取引ID / 日時 / 金額 / ステータス / ブランド / 返金額。カード番号等の機密情報は含まない

---

## S03: 売上レポート

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S03 |
| メニューID | m_report |
| 画面名 | 売上レポート |
| 目的 | 日次/月次の売上データを確認し、CSV/PDFで出力する |
| アクセス権 | merchant_owner / merchant_admin / merchant_viewer |

### 機能

| 機能 | 仕様 |
|------|------|
| 期間選択 | 今月 / 先月 / カスタム（日付範囲指定） |
| 日別グラフ | 棒グラフ（日別の売上推移） |
| ブランド別内訳 | テーブル（ブランド / 取引数 / 売上額 / 手数料 / 差引額） |
| 入金予定 | 次回入金日 + 入金予定額 |
| 取引明細 | テーブル（日時 / 取引ID / 金額 / ブランド / カード下4桁 / ステータス） |
| エクスポート | [📥 CSV] [📄 PDF出力] |

**❓ 未定義事項:**
- [x] ~~前月比・前年比の表示~~ → **不要**
- [x] ~~レポートの自動メール配信設定~~ → **要件として保留**。締め日が接続先によって異なるため、支払い設計確定後に詳細決定

---

## S04: 入金確認

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S04 |
| メニューID | m_payout |
| 画面名 | 入金確認 |
| 目的 | 入金予定・入金実績を確認する |
| アクセス権 | merchant_owner / merchant_admin / merchant_viewer |

### 機能

| 機能 | 仕様 |
|------|------|
| 次回入金プレビュー | 入金予定日 / 対象期間 / 総取引額 / 手数料 / リザーブ留保 / CB差引 / 入金予定額 |
| 入金履歴 | テーブル（入金日 / 対象期間 / 入金額 / リザーブ留保 / リザーブ解放 / ステータス / 明細PDFリンク） |
| 入金履歴検索 | 精算期間テキスト検索 / ステータスフィルタ / 日付範囲 / CSV出力 |
| 明細PDF | 各入金の詳細明細をPDFでダウンロード |

### タブ構成（2タブ）

| タブ | 目的 |
|------|------|
| 入金履歴 | 入金予定・入金実績を確認する |
| リザーブ（デポジット） | ローリングリザーブの残高・条件・留保/解放履歴を確認する |

#### リザーブ（デポジット）タブ

| 機能 | 仕様 |
|------|------|
| リザーブサマリー | KPI 4つ（現在の残高 / 今月解放予定 / 来月解放予定 / 今月新規留保） |
| 適用条件 | 接続先ごとのリザーブ率・期間・残高・次回解放額を表示 |
| 履歴検索 | 種別フィルタ（留保/解放）/ 日付範囲 |
| 履歴テーブル | 日付 / 種別（留保/解放）/ 接続先 / 対象精算 / 金額 / 残高 |

**❓ 未定義事項:**
- [x] ~~入金予定額の計算ロジック~~ → **精算設計後に詳細決定**。手数料率・CB差し引き・ローリングリザーブの計算ロジックは支払いフロー確定後
- [x] ~~入金遅延時の通知・表示~~ → **不要**

---

## S05: API設定

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S05 |
| メニューID | m_api |
| 画面名 | API設定 |
| 目的 | APIキーの管理・Webhook設定・テスト決済の実行 |
| アクセス権 | merchant_owner / merchant_admin（merchant_viewer はアクセス不可） |

### 機能

| 機能 | 仕様 |
|------|------|
| 環境切替 | 本番 / テスト のトグル |
| APIキー表示 | キーのマスク表示 + [表示] ボタン（5秒後自動マスク） |
| APIキー再発行 | [再発行] → 確認ダイアログ（「旧キーは即時無効になります」） |
| Webhook URL | URL入力 + テスト送信ボタン |
| Webhookイベント | 通知対象イベントのチェックボックス選択 |
| テスト決済 | [テスト決済を実行] → 金額・ブランド入力 → 実行 → 結果表示 |

**Webhookイベント一覧:**

| イベント | 説明 |
|---------|------|
| payment.succeeded | 決済成功時 |
| payment.failed | 決済失敗時 |
| refund.completed | 返金完了時 |
| chargeback.received | CB受領時 |
| payout.completed | 入金完了時 |

**❓ 未定義事項:**
- [x] ~~APIキーのスコープ設定~~ → **要検討**。開発フェーズで詳細設計
- [x] ~~Webhook のリトライポリシー~~ → **要検討**。開発フェーズで詳細設計
- [x] ~~API使用量の表示~~ → **要検討**。開発フェーズで詳細設計
- [x] ~~テスト決済のシナリオ選択~~ → **要検討**。開発フェーズで詳細設計

---

## S06: AIサポート

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S06 |
| メニューID | m_chat |
| 画面名 | AIサポート |
| 目的 | チャットボットで加盟店の質問に回答し、操作を代行する |
| アクセス権 | merchant_owner / merchant_admin / merchant_viewer |

### 機能

| 機能 | 仕様 |
|------|------|
| チャットUI | 左側にメッセージ履歴、右側にクイックアクション |
| AI応答 | Claude API（チャットサポートAI + Tool 10本） |
| クイックアクション | 6つの定型質問ボタン |
| 操作代行 | 返金処理・Webhook URL変更 等は確認ダイアログ付きで実行 |
| エスカレーション | AIが対応できない場合 → 人間オペレーターに自動転送 |

**クイックアクション（6つ）:**
1. 「昨日の売上は？」
2. 「今月のレポートを出して」
3. 「決済成功率は？」
4. 「Webhook URLを変更したい」
5. 「テスト決済をしたい」
6. 「APIキーを再発行したい」

**AIが使えるTool（10本）:**

| Tool | 用途 | 確認ダイアログ |
|------|------|:----------:|
| get_transaction_summary | 取引サマリー取得 | — |
| get_daily_report | 日次レポート取得 | — |
| search_transactions | 取引検索 | — |
| get_payout_schedule | 入金予定取得 | — |
| update_webhook_url | Webhook URL変更 | ✅ |
| get_webhook_status | Webhook状態確認 | — |
| get_api_keys | APIキー情報取得 | — |
| regenerate_api_key | APIキー再発行 | ✅ |
| execute_test_payment | テスト決済実行 | ✅ |
| escalate_to_human | 人間にエスカレーション | — |

**❓ 未定義事項:**
- [x] ~~チャット履歴の保存期間~~ → **2年**。チャージバック争議期間（最大540日）をカバー。2年経過後は自動アーカイブ（圧縮保管、必要時に復元可能）
- [x] ~~エスカレーション時の通知先~~ → **Slack・メール両方選択可能**。加盟店ごとの設定で通知先を選択
- [x] ~~ファイルアップロード対応~~ → **あり**。スクリーンショット等の画像ファイル送信に対応
- [x] ~~営業時間外の対応方針~~ → **AIで一次対応**。営業時間外もAIが回答。エスカレーションが必要な場合は「営業時間内に担当者から回答します」と案内し、キューに積む

---

## S07: ユーザー管理

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S07 |
| メニューID | m_users |
| 画面名 | ユーザー管理 |
| 目的 | 加盟店内のスタッフを管理する |
| アクセス権 | merchant_owner のみ（merchant_admin は閲覧のみ） |

### 機能

| 機能 | 仕様 |
|------|------|
| ユーザー一覧 | 名前 / メール / ロール / ステータス / 最終ログイン |
| 招待 | [+ スタッフを招待] → メール + ロール選択 → 招待メール送信 |
| 権限マトリクス | 7機能 × 4ロール の権限表を表示 |
| ロール変更 | ドロップダウンで変更 |
| 無効化 | ユーザーを無効化 |

**権限マトリクス:**

| 機能 | owner | admin | viewer |
|------|:-----:|:-----:|:------:|
| ダッシュボード閲覧 | ✅ | ✅ | ✅ |
| 取引閲覧 | ✅ | ✅ | ✅ |
| 返金操作 | ✅ | ✅ | ❌ |
| API設定 | ✅ | ❌ | ❌ |
| Webhook設定 | ✅ | ✅ | ❌ |
| ユーザー管理 | ✅ | ❌ | ❌ |
| アカウント設定 | ✅ | 一部 | ❌ |

---

## S08: アカウント設定

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S08 |
| メニューID | m_account |
| 画面名 | アカウント設定 |
| 目的 | 会社情報・振込先口座・セキュリティ等の各種設定 |
| アクセス権 | merchant_owner（全設定）/ merchant_admin（一部設定） |

### タブ構成（9タブ）← v1.1で2タブ追加

| タブ | 内容 | owner | admin |
|------|------|:-----:|:-----:|
| 会社情報 | 法人名・住所・代表者・連絡先 | 編集可 | 閲覧のみ |
| 振込先口座 | 銀行名・支店・口座番号 + 変更申請フロー | 編集可 | 閲覧のみ |
| サイト管理 🆕 | サイト一覧 / サイト追加申請 / サイト設定 | ✅ | 閲覧のみ |
| APIキー | 本番/テストキーの表示（S05へのショートカット） | ✅ | ❌ |
| セキュリティ | MFA設定 / パスワード変更 / ログイン履歴 | ✅ | 自分のみ |
| メンバー管理 | S07へのショートカット | ✅ | 閲覧のみ |
| 通知設定 | メール通知の ON/OFF（取引通知・入金通知・CB通知等） | ✅ | ✅ |
| 契約情報 | 契約プラン・手数料率・入金サイクルの閲覧 | 閲覧のみ | 閲覧のみ |
| エラーコード 🆕 | 決済エラーコード一覧の閲覧（対処法付き） | ✅ | ✅ |

#### サイト管理タブ 🆕 v1.1

| 機能 | 仕様 |
|------|------|
| サイト一覧 | サイト名 / URL / ステータス / 決済手段 / 手数料率 / 作成日 |
| サイト詳細 | 行クリック → サイト設定（サイト名・URL・決済手段等の編集） |
| サイト追加申請 | [+ サイトを追加] → 申請フォーム → 運営M04に申請投入 |
| 申請ステータス | 申請中のサイト追加申請の進捗表示 |

**サイト追加申請フォーム:**

| 項目 | 型 | 必須 |
|------|---|:---:|
| サイト名 | テキスト | ✅ |
| サイトURL | URL | ✅ |
| 業種 | 選択（8種） | ✅ |
| ビジネスモデル | 選択（4種） | ✅ |
| サービス説明 | テキストエリア | ✅ |
| 希望決済手段 | チェックボックス | ✅ |
| 月間予想売上 | 数値 | ✅ |

**申請フロー:**
```
1. 加盟店がフォーム入力 → [申請する]
2. M04 申込・登録管理に「サイト追加申請」として投入
3. AI審査（サイト確認・反社チェック）
4. 運営承認 → 接続先審査
5. 承認後、sites テーブルにレコード追加 → サイトセレクターに表示
```

#### エラーコードタブ 🆕 v1.1

| 機能 | 仕様 |
|------|------|
| テーブル | エラーコード / カテゴリ / エラー文言 / 対処法 |
| 検索 | エラーコード / キーワード |
| フィルタ | カテゴリ / API対応 / リンク対応 |
| 閲覧のみ | 加盟店側はマスターデータの閲覧のみ（編集不可） |

**口座変更申請フロー:**
1. 加盟店が新口座情報を入力
2. [変更申請を送信] → 確認ダイアログ
3. 運営側の例外キュー（精算カテゴリ）に投入
4. 運営が確認・承認
5. 口座情報が更新

**❓ 未定義事項:**
- [x] ~~会社情報の変更に運営の承認は必要か~~ → **必要**。会社情報変更は申請制。変更内容によっては書類再提出が必要（登記簿等）。申請 → 運営確認 → 承認/差戻し
- [x] ~~契約プランの変更申請機能~~ → **不要**。手数料交渉は営業の個別対応、決済手段追加はM03の接続先審査で対応済み
- [x] ~~アカウント解約（退会）フロー~~ → **申請のみ**。加盟店画面から解約申請を送信 → 運営（本部）が対応。即時解約ではなく、未精算の処理完了後に解約

---

# 公開画面

---

## P01: 加盟店申込フォーム

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | P01 |
| メニューID | — |
| 画面名 | 加盟店申込フォーム |
| 目的 | 新規加盟店がオンラインで申込を行う |
| アクセス権 | 一般公開（認証不要） |
| バージョン | 標準版（wireframes_v2.jsx）+ 3D版（merchant_apply_3d.jsx） |

### 5ステップ + 完了画面

| Step | 名前 | 入力項目 |
|:----:|------|---------|
| 1 | 企業情報 | 法人名 / 法人番号 / 代表者名 / 設立年月 / 資本金 / 従業員数 / 所在地 / 担当者名 / 担当者メール / 担当者電話 / URL |
| 2 | 事業内容 | 業種(8種選択) / ビジネスモデル(4種選択) / 月間予想売上 / 平均単価 / 商品説明 / カード決済経験有無 |
| 3 | 決済設定 | 利用決済手段(6種チェック) / 入金サイクル(選択) / 振込先銀行名 / 支店名 / 口座種別 / 口座番号 / 口座名義 |
| 4 | 書類提出 | 登記簿謄本 / 本人確認書類 / 決算書(2期分) / 特商法スクショ / 古物商許可証(任意) |
| 5 | 確認・申込 | 全入力内容のサマリー + 利用規約チェック + [申込を完了する] |
| 完了 | 受付完了 | 申込番号表示 + AI審査5ステップの進捗アニメーション |

### バリデーション

| 項目 | バリデーションルール |
|------|-------------------|
| 法人番号 | 13桁の数字 / チェックデジット検証 |
| メール | RFC 5322 準拠 |
| 電話番号 | 日本の電話番号形式 |
| URL | https:// で始まること / アクセス可能であること |
| 資本金 | 数値（0以上） |
| ファイル | 対応形式: PDF / JPG / PNG、最大サイズ: 10MB/ファイル |

### インタラクション

| 機能 | 仕様 |
|------|------|
| プログレスバー | 完了済み=緑チェック、アクティブ=青、未到達=灰 |
| ステップ遷移 | [次へ →] [← 戻る] ボタン |
| ステップジャンプ | 完了済みステップはクリックで直接ジャンプ可能 |
| 一時保存 | 各ステップ完了時にLocalStorageに自動保存（ブラウザを閉じても復帰可能） |
| AIヒント | 各ステップに 🤖 マークでAI審査のポイントを表示 |
| ドラッグ&ドロップ | Step 4 の書類アップロードはD&D対応 |

**❓ 未定義事項:**
- [x] ~~入力途中での保存・再開~~ → **サーバー保存あり**。ステップごとに自動保存（下書き状態）。再アクセス時に途中から再開可能。負荷軽減のため保存は画面遷移時のみ（リアルタイム保存ではない）
- [x] ~~同一法人番号での重複申込チェック~~ → **必要**。法人番号入力時にリアルタイムで重複チェック。既存申込がある場合は「既に申込済みです」と表示し、再申込の場合はM04の再申込フローへ誘導
- [x] ~~業種「その他」を選択した場合の自由記述~~ → **必須**。「その他」選択時に自由記述フィールドを表示し、入力を必須とする
- [x] ~~ファイルアップロードのウイルスチェック~~ → **必須**。アップロード時にウイルススキャンを実行。検知時はアップロードを拒否しエラー表示
- [x] ~~完了画面のAI審査進捗アニメーション~~ → **リアルタイム更新あり（WebSocket）**。申込完了後、AI審査の各ステップ（反社チェック→サイト確認→決算書解析→総合判定）の進捗をリアルタイム表示

---

## S09: 決済リンク管理 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S09 |
| メニューID | m_payment_links |
| 画面名 | 決済リンク管理 |
| 目的 | URL決済（スイフトパス）のリンク生成・管理・利用状況確認 |
| アクセス権 | merchant_owner / merchant_admin |
| データ範囲 | 選択中サイトのデータのみ |

### タブ構成（3タブ）

| タブ | 内容 |
|------|------|
| 新規作成 | 決済リンクを新規生成 |
| リンク一覧 | 生成済みリンクの検索・管理 |
| 利用状況 | リンクの利用実績・統計 |

#### ① 新規作成タブ

**決済タイプ選択:**
```
3つのカードから選択:
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  💴 固定金額  │  │  ✏️ 金額入力型 │  │  📋 金額選択型│
│  指定額で決済  │  │ 顧客が金額入力 │  │ 選択肢から選ぶ│
└─────────────┘  └─────────────┘  └─────────────┘
```

**設定フォーム:**

| 項目 | 型 | 必須 | 備考 |
|------|---|:---:|------|
| 商品名 | テキスト | ✅ | リンクページに表示 |
| 決済金額 | 数値 | ※ | 固定金額のみ必須 |
| 金額選択肢 | JSONB | ※ | 金額選択型のみ。最大5つまで |
| 注文IDプレフィックス | テキスト | ❌ | 自動採番の接頭辞 |
| ユーザーID入力 | ON/OFF | ❌ | 顧客にユーザーIDの入力を求めるか |
| フリー項目 | 複数テキスト | ❌ | 最大3件まで。項目名+入力タイプ |
| 有効期限 | 日時 | ❌ | NULLで無期限 |
| 利用可能回数 | 数値 | ❌ | NULLで無制限 |

**生成結果:**
```
✅ 決済リンクが生成されました！
URL: https://pay.aipayment.jp/l/abc123xyz
[📋 コピー]  [📧 メールで送る]  [QRコード表示]
```

#### ② リンク一覧タブ

| 機能 | 仕様 |
|------|------|
| テーブル | リンクID / 商品名 / タイプ / 金額 / ステータス / 利用回数 / 作成日 / 有効期限 |
| 検索 | 商品名 / リンクID / ステータス / 期間 |
| 操作 | [URLコピー] [QR表示] [有効/無効切替] [編集] [削除] |
| ステータス | 有効（緑）/ 無効（灰）/ 期限切れ（赤）/ 上限到達（黄） |

#### ③ 利用状況タブ

| 機能 | 仕様 |
|------|------|
| KPI | 総リンク数 / アクティブリンク数 / 総利用回数 / 総売上額 |
| リンク別実績 | テーブル（リンクID / 商品名 / 利用回数 / 売上額 / 成功率 / 最終利用日） |
| 期間フィルタ | 今月 / 先月 / カスタム期間 |

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B: POST /api/v1/payment-links | リンク新規生成 |
| Zone B: GET /api/v1/payment-links | リンク一覧・検索 |
| Zone B: PUT /api/v1/payment-links/{id} | リンク編集・ステータス変更 |
| Zone B: DELETE /api/v1/payment-links/{id} | リンク削除 |
| Zone B: GET /api/v1/payment-links/stats | 利用状況統計 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| payment_links | 決済リンク設定・管理 |
| transactions | リンク経由の取引実績 |
| sites | サイト別フィルタ |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「決済リンク管理」 [サイト切替: ▼]        │
│ [新規作成] [リンク一覧] [利用状況]  ← タブ切替     │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【新規作成タブ】                                  │
│ ┌───────────────────────────────────────────┐   │
│ │ ① 決済タイプ選択（3カード）                │   │
│ │ [固定金額] [金額入力型] [金額選択型]         │   │
│ ├───────────────────────────────────────────┤   │
│ │ ② 設定フォーム                             │   │
│ │ 商品名 / 金額 / ユーザーID / フリー項目     │   │
│ │ 有効期限 / 利用可能回数                     │   │
│ │ [プレビュー] [決済リンクを生成]              │   │
│ ├───────────────────────────────────────────┤   │
│ │ ③ 生成結果（URL・QR・コピー・メール送信）   │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【リンク一覧タブ】                                │
│ ┌───────────────────────────────────────────┐   │
│ │ ④ 検索バー + フィルタ                       │   │
│ │ ⑤ リンクテーブル                            │   │
│ │ リンクID | 商品名 | タイプ | 金額 | 利用回数  │   │
│ │ ステータス | 作成日 | 操作                   │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【利用状況タブ】                                  │
│ ⑥ KPI + リンク別実績テーブル + 期間フィルタ     │
└─────────────────────────────────────────────────┘
```

### 機能詳細（補完）

#### ② 設定フォーム（追加詳細）

**QRコード生成仕様:**

| 項目 | 仕様 |
|------|------|
| 生成タイミング | リンク生成と同時に自動生成 |
| サイズ | 300×300px（ダウンロード時は1000×1000px） |
| 形式 | PNG |
| 内容 | リンクURL（https://pay.aipayment.jp/l/{link_code}） |
| ダウンロード | [QR画像をダウンロード] ボタン |

**プレビュー機能:**

| 項目 | 仕様 |
|------|------|
| 表示 | [プレビュー] ボタンで P02 決済ページの見た目をモーダル表示 |
| 内容 | 商品名・金額・フリー項目のレイアウト確認（実際の決済は不可） |

#### ⑤ リンクテーブル（カラム詳細）

| カラム | 内容 | ソート |
|--------|------|:----:|
| リンクID | LNK-XXXXXXXX | ✅ |
| 商品名 | — | ✅ |
| タイプ | バッジ（固定/入力/選択） | ✅ |
| 金額 | ¥XX,XXX（入力型は「顧客入力」表示） | ✅ |
| ステータス | バッジ（有効=緑 / 無効=灰 / 期限切れ=赤 / 上限到達=黄） | ✅ |
| 利用回数 | XX / XX回（制限ありの場合）or XX回（無制限） | ✅ |
| 作成日 | YYYY-MM-DD | ✅ |
| 有効期限 | YYYY-MM-DD or 無期限 | ✅ |
| 操作 | [📋URL] [QR] [有効/無効] [✏️編集] [🗑削除] | — |

### バリデーション

| 項目 | ルール |
|------|-------|
| 商品名 | 必須。1〜100文字 |
| 決済金額（固定金額型） | 必須。1円〜999,999円。整数のみ |
| 金額選択肢（選択型） | 2〜5個。各1円〜999,999円。重複不可 |
| 金額入力型の上限額 | 設定する場合: 1円〜999,999円 |
| 注文IDプレフィックス | 半角英数字のみ。1〜10文字 |
| フリー項目（項目名） | 1〜30文字。最大3件 |
| 有効期限 | 設定する場合: 現在より未来の日時 |
| 利用可能回数 | 設定する場合: 1〜99,999回。整数のみ |

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| リンク生成 | 「以下の内容で決済リンクを生成しますか？」+ 商品名・金額・タイプのサマリー + [キャンセル] [生成する] |
| リンク無効化 | 「リンク LNK-XXXXX を無効にしますか？ このリンクでの決済ができなくなります」+ [キャンセル] [無効にする] |
| リンク削除 | 「リンク LNK-XXXXX を削除しますか？ この操作は取り消せません」+ [キャンセル] [削除する]（赤ボタン） |

### ロール別権限

| 操作 | merchant_owner | merchant_admin | merchant_viewer |
|------|:--------------:|:--------------:|:---------------:|
| リンク一覧閲覧 | ✅ | ✅ | ✅ |
| 利用状況閲覧 | ✅ | ✅ | ✅ |
| リンク新規作成 | ✅ | ✅ | ❌ |
| リンク編集 | ✅ | ✅ | ❌ |
| リンク有効/無効切替 | ✅ | ✅ | ❌ |
| リンク削除 | ✅ | ❌ | ❌ |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ③ 生成結果 [プレビュー] | P02 決済ページ（プレビューモード） | link_code |
| ⑤ リンクテーブル → 取引詳細 | S02 取引一覧 | payment_link_id でフィルタ |

## S10: 継続・分割決済管理 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S10 |
| メニューID | m_subscriptions |
| 画面名 | 継続・分割決済管理 |
| 目的 | 継続（リカーリング）・分割決済の商品設定・ユーザー管理 |
| アクセス権 | merchant_owner / merchant_admin |
| データ範囲 | 選択中サイトのデータのみ |

### タブ構成（3タブ）

| タブ | 内容 |
|------|------|
| 商品設定 | 継続/分割決済の商品プラン管理 |
| ユーザー管理 | 課金中ユーザーの検索・停止・カード変更 |
| 決済履歴 | 自動決済の実行履歴・リトライ状況 |

#### ① 商品設定タブ

| 機能 | 仕様 |
|------|------|
| プラン一覧 | プラン名 / タイプ(継続/分割) / 金額 / サイクル / ユーザー数 / ステータス |
| [+ プラン作成] | プランタイプ選択 → 設定フォーム |
| 編集 | 行クリック → 設定編集（※既存ユーザーには影響しない） |
| アーカイブ | プランをアーカイブ（新規登録停止。既存ユーザーの課金は継続） |

**継続決済プラン 設定フォーム:**

| 項目 | 型 | 必須 | 備考 |
|------|---|:---:|------|
| プラン名 | テキスト | ✅ | |
| 初回決済金額 | 数値 | ✅ | 初月のみの金額（0でトライアル可） |
| 自動決済金額 | 数値 | ✅ | 2回目以降の金額 |
| 課金サイクル | 選択 | ✅ | 指定間隔（N日ごと）/ 月額（毎月N日） |
| サイクル日数 | 数値 | ※ | 指定間隔の場合のみ |
| 課金日 | 数値(1-28) | ※ | 月額の場合のみ |

**分割決済プラン 設定フォーム:**

| 項目 | 型 | 必須 | 備考 |
|------|---|:---:|------|
| プラン名 | テキスト | ✅ | |
| 商品総額 | 数値 | ✅ | |
| 分割回数 | 数値(2-36) | ✅ | |
| 初回金額 | 自動計算 | — | 総額 ÷ 回数（端数は初回に加算） |
| 自動決済金額 | 自動計算 | — | 総額 ÷ 回数 |

#### ② ユーザー管理タブ

| 機能 | 仕様 |
|------|------|
| テーブル | ユーザーID / メール / プラン名 / ステータス / カード下4桁 / 次回決済日 / 失敗回数 |
| 検索 | ユーザーID / メール / プラン / ステータス |
| フィルタ | ステータス（課金中/一時停止/停止/完了/自動停止） |
| 課金停止 | [停止] → 確認ダイアログ「この操作は取り消せません。ユーザーの課金を永久停止します。」 |
| カード変更URL | [カード変更URL発行] → URL生成（有効期限24h）→ URLコピー → メール送信 |
| 詳細 | 行クリック → 決済履歴・リトライ履歴の詳細表示 |

**ステータスバッジ:**
| ステータス | 色 | 説明 |
|-----------|---|------|
| 課金中 | 🟢 緑 | 正常に課金中 |
| 一時停止 | 🟡 黄 | 手動で一時停止中 |
| 停止 | ⚫ 灰 | 手動で永久停止 |
| 完了 | 🔵 青 | 分割払い完了 |
| 自動停止 | 🔴 赤 | 3回連続失敗で自動停止 |

#### ③ 決済履歴タブ

| 機能 | 仕様 |
|------|------|
| テーブル | 実行日 / ユーザーID / プラン / 金額 / 結果 / リトライ回 / エラーコード |
| 検索 | ユーザーID / 期間 / 結果（成功/失敗） |
| 統計 | 今月の自動決済: 成功XX件 / 失敗XX件 / リトライ中XX件 |

**リトライロジック（ビジネスルール）:**
```
1回目失敗 → 10日後にリトライ（consecutive_failures = 1）
2回目失敗 → さらに10日後にリトライ（consecutive_failures = 2）
3回目失敗 → 自動停止（consecutive_failures = 3 → status = 'failed_stopped'）
※ 自動停止後の再開は不可
※ 停止時に加盟店にメール通知
```

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B: POST /api/v1/subscription-plans | プラン作成 |
| Zone B: GET /api/v1/subscription-plans | プラン一覧 |
| Zone B: PUT /api/v1/subscription-plans/{id} | プラン編集 |
| Zone B: GET /api/v1/subscription-users | ユーザー一覧 |
| Zone B: PUT /api/v1/subscription-users/{id}/stop | ユーザー課金停止 |
| Zone B: POST /api/v1/subscription-users/{id}/card-change-url | カード変更URL生成 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| subscription_plans | プラン設定 |
| subscription_users | ユーザー管理 |
| transactions | 決済履歴（subscription_user_id で紐付け） |
| sites | サイト別フィルタ |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「継続・分割決済管理」 [サイト切替: ▼]    │
│ [商品設定] [ユーザー管理] [決済履歴]  ← タブ切替   │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【商品設定タブ】                                  │
│ ┌───────────────────────────────────────────┐   │
│ │ ① プラン一覧テーブル                       │   │
│ │ プラン名 | タイプ | 金額 | サイクル |        │   │
│ │ ユーザー数 | ステータス | [編集] [アーカイブ] │   │
│ ├───────────────────────────────────────────┤   │
│ │ ② [＋ プラン作成] → スライドパネル          │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【ユーザー管理タブ】                              │
│ ┌───────────────────────────────────────────┐   │
│ │ ③ 検索バー + ステータスフィルタ             │   │
│ │ ④ ユーザーテーブル                         │   │
│ │ ユーザーID | メール | プラン | ステータス |   │
│ │ 次回決済日 | 失敗回数 | 操作                 │   │
│ ├───────────────────────────────────────────┤   │
│ │ ⑤ ユーザー詳細パネル（行クリック）          │   │
│ │ 契約情報 + 決済履歴 + リトライ状況          │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【決済履歴タブ】                                  │
│ ⑥ 統計サマリー + 自動決済ログテーブル            │
└─────────────────────────────────────────────────┘
```

### 機能詳細（補完）

#### ① プラン一覧テーブル（カラム詳細）

| カラム | 内容 | ソート |
|--------|------|:----:|
| プランID | PLN-XXXXXXXX | ✅ |
| プラン名 | — | ✅ |
| タイプ | バッジ（継続=青 / 分割=紫） | ✅ |
| 金額 | 初回 ¥XX → 以降 ¥XX / 月 | ✅ |
| サイクル | 月額N日 / N日ごと / 分割N回 | — |
| ユーザー数 | アクティブ数 / 全登録数 | ✅ |
| ステータス | バッジ（有効=緑 / アーカイブ=灰） | ✅ |
| 操作 | [✏️編集] [📦アーカイブ] | — |

#### ⑤ ユーザー詳細パネル（スライドパネル）

| セクション | 内容 |
|-----------|------|
| 契約情報 | ユーザーID / メール / プラン名 / タイプ / 契約開始日 / ステータス |
| 課金スケジュール | 次回決済日 / サイクル / 残り回数（分割の場合）/ 合計支払済み額 |
| カード情報 | ブランド / 下4桁 / 有効期限 / [カード変更URL発行] |
| 決済履歴 | 時系列リスト（日時/金額/結果/エラーコード） |
| リトライ状況 | 現在の連続失敗回数 / 次回リトライ日 / リトライ履歴 |
| 操作 | [一時停止] [再開] [永久停止] |

**一時停止 / 再開フロー:**
```
課金中 → [一時停止] → 一時停止中（自動決済スキップ、次回決済日が延期される）
一時停止中 → [再開] → 課金中（次回決済日を再計算）
※ 一時停止中の期間は課金されない
※ 一時停止の最大期間: 90日（超過で自動停止に移行）
```

### バリデーション

| 項目 | ルール |
|------|-------|
| プラン名 | 必須。1〜100文字 |
| 初回決済金額 | 必須。0円（トライアル）〜999,999円。整数のみ |
| 自動決済金額 | 必須。1円〜999,999円。整数のみ |
| 課金日（月額型） | 1〜28の整数。29〜31は指定不可（月による日数差の問題回避） |
| サイクル日数（間隔型） | 1〜365の整数 |
| 分割回数 | 2〜36の整数 |
| 商品総額（分割型） | 必須。分割回数×1円以上（1回あたり1円以上になること） |
| カード変更URL有効期限 | 自動: 発行から24時間 |

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| プランアーカイブ | 「プラン「〇〇」をアーカイブしますか？ 新規登録は停止されます。既存ユーザーの課金は継続します」+ [キャンセル] [アーカイブする] |
| ユーザー一時停止 | 「ユーザー XXX の課金を一時停止しますか？ 自動決済がスキップされます。最大90日間停止可能です」+ [キャンセル] [一時停止する] |
| ユーザー永久停止 | 「ユーザー XXX の課金を永久停止しますか？ ⚠️ この操作は取り消せません」+ [キャンセル] [永久停止する]（赤ボタン） |
| カード変更URL発行 | 「カード変更用URLを発行しますか？ URLは24時間有効です」+ [キャンセル] [発行する] |

### ロール別権限

| 操作 | merchant_owner | merchant_admin | merchant_viewer |
|------|:--------------:|:--------------:|:---------------:|
| プラン一覧閲覧 | ✅ | ✅ | ✅ |
| プラン作成・編集 | ✅ | ✅ | ❌ |
| プランアーカイブ | ✅ | ❌ | ❌ |
| ユーザー一覧閲覧 | ✅ | ✅ | ✅ |
| ユーザー一時停止・再開 | ✅ | ✅ | ❌ |
| ユーザー永久停止 | ✅ | ❌ | ❌ |
| カード変更URL発行 | ✅ | ✅ | ❌ |
| 決済履歴閲覧 | ✅ | ✅ | ✅ |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ④ ユーザーテーブル [詳細] | ⑤ ユーザー詳細パネル | subscription_user_id |
| ⑤ 決済履歴 → 取引詳細 | S02 取引一覧 | transaction_id |
| S11 顧客詳細 → サブスク | S10 ユーザー管理タブ | subscription_user_id |

---

## S11: 顧客管理 🆕 v1.2

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | S11 |
| メニューID | m_customers |
| 画面名 | 顧客管理 |
| 目的 | 自社サイトで決済した顧客のプロファイル・取引パターンを分析し、リピーター育成・問い合わせ対応に活用する（簡易CRM） |
| アクセス権 | merchant_owner / merchant_admin / merchant_viewer（閲覧のみ） |
| データ範囲 | 選択中サイトの顧客のみ（サイト切替セレクター連動） |

### タブ構成（3タブ）

| タブ | 目的 | 主な利用シーン |
|------|------|-------------|
| 顧客一覧 | 自社サイトの顧客を検索・閲覧 | 問い合わせ対応・顧客確認 |
| 顧客詳細 | 個別顧客の取引履歴・サブスク状態 | 個別対応・取引確認 |
| 顧客分析 | 自社の顧客統計・傾向分析 | マーケティング・レポート |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「顧客管理」 [サイト切替: ECサイトA ▼]   │
│ [顧客一覧] [顧客詳細] [顧客分析]  ← タブ切替     │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【顧客一覧タブ】                                  │
│ ┌───────────────────────────────────────────┐   │
│ │ ① 検索バー + フィルタ                       │   │
│ ├───────────────────────────────────────────┤   │
│ │ ② 顧客テーブル                             │   │
│ │ 顧客ID | メール | カード | 取引回数 | LTV   │   │
│ │ リピート | サブスク | 最終取引 | [詳細]      │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【顧客詳細（スライドパネル）】                      │
│ ┌────────────────┬──────────────────────────┐   │
│ │ ③ プロファイル   │ ④ 取引タイムライン       │   │
│ │ 基本情報        │ 直近の取引一覧           │   │
│ │ カード一覧      │ 返金・CB履歴            │   │
│ │ サブスク状態    │ 月別利用グラフ           │   │
│ │ メモ           │                          │   │
│ ├────────────────┴──────────────────────────┤   │
│ │ ⑤ [メモ追加] [タグ編集] [取引一覧で開く]    │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【顧客分析タブ】                                  │
│ ⑥ KPI + リピート率 + LTV分布 + セグメント分析   │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### 【顧客一覧タブ】

##### ① 検索バー + フィルタ

| 検索条件 | 入力方式 |
|---------|---------|
| フリー検索 | メール / 名前 / 顧客IDを一括検索（テキスト入力） |
| カード下4桁 | 4桁数字入力 |
| 取引回数 | 最小 〜 最大 |
| LTV範囲 | 最小金額 〜 最大金額 |
| 最終取引日 | 期間指定 |
| サブスク状態 | チェックボックス（課金中/停止/なし） |
| タグ | ドロップダウン（VIP / リピーター / 要確認 等） |

##### ② 顧客テーブル

| カラム | 内容 | ソート |
|--------|------|:----:|
| 顧客ID | CUS-XXXXXXXX | ✅ |
| メール | マスク表示（t***@example.com）※ ownerのみ全表示可 | ✅ |
| カード | 下4桁 + ブランドアイコン | — |
| 取引回数 | 総取引件数 | ✅ |
| LTV | 累計決済金額 | ✅ |
| リピート | バッジ（初回 / リピーター / ロイヤル） | ✅ |
| サブスク | バッジ（課金中/停止/なし） | ✅ |
| 最終取引 | 日時 | ✅ |
| タグ | 付与済みタグ表示 | — |
| 操作 | [詳細] | — |

**リピートバッジの基準:**
| バッジ | 条件 |
|-------|------|
| 初回 | 取引1回のみ |
| リピーター | 取引2〜10回 |
| ロイヤル | 取引11回以上 or LTV ¥100,000以上 |

#### 【顧客詳細（スライドパネル）】

##### ③ プロファイル（左側）

| セクション | 内容 |
|-----------|------|
| 基本情報 | 顧客ID / メール / 名前（カード名義）/ 初回取引日 / 最終取引日 / 取引回数 / LTV |
| カード一覧 | 登録カード（ブランド / 下4桁 / 最終使用日）※ 加盟店にはトークンのみ公開、フルカード番号は見えない |
| サブスクリプション | 契約中のプラン一覧（プラン名 / ステータス / 次回決済日）→ S10へリンク |
| タグ | 自社で付与したタグ（VIP / リピーター / 要確認 等） |
| メモ | メモ一覧（タイムスタンプ付き、追記可能） |

##### ④ 取引タイムライン（右側）

| 機能 | 仕様 |
|------|------|
| タイムライン | 全取引を時系列で表示（新しい順） |
| 取引カード | 日時 / 金額 / ブランド / ステータス |
| フィルタ | ステータス / 期間 |
| 返金・CB | 返金・CBがあればバッジ表示 |
| 月別利用グラフ | 棒グラフ（直近6ヶ月の月別取引額） |
| 統計サマリー | 成功率 / 平均単価 / 月平均取引回数 |

##### ⑤ 操作ボタン

| 操作 | 仕様 | 権限 |
|------|------|------|
| メモ追加 | テキスト入力 → タイムスタンプ付き保存 | owner / admin |
| タグ編集 | タグの追加・削除（定義済みタグ + 自由入力） | owner / admin |
| 取引一覧で開く | S02にこの顧客のカード下4桁でフィルタして遷移 | 全ロール |
| CSVエクスポート | この顧客の取引履歴をCSV出力 | owner / admin |

#### 【顧客分析タブ】

##### ⑥ 分析ダッシュボード

| KPI | 説明 |
|-----|------|
| 総顧客数 | ユニーク顧客数 |
| アクティブ顧客 | 直近30日以内に取引がある顧客数 |
| 平均LTV | 顧客あたりの累計決済額の平均 |
| リピート率 | 2回以上取引がある顧客の割合 |
| 月間新規顧客数 | 今月初めて取引した顧客数 |

| 分析チャート | 説明 |
|------------|------|
| セグメント分布 | 円グラフ（初回 / リピーター / ロイヤル） |
| 月別新規 vs リピーター | 積み上げ棒グラフ |
| リピート率推移 | 折れ線グラフ（直近12ヶ月） |
| LTV分布 | ヒストグラム |
| 取引頻度分布 | 棒グラフ（1回 / 2-5回 / 6-10回 / 11回以上） |

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B: GET /api/v1/customers | 顧客一覧・検索 |
| Zone B: GET /api/v1/customers/{id} | 顧客詳細 |
| Zone B: GET /api/v1/customers/{id}/transactions | 取引履歴 |
| Zone B: PUT /api/v1/customers/{id}/tags | タグ更新 |
| Zone B: POST /api/v1/customers/{id}/notes | メモ追加 |
| Zone B: GET /api/v1/customers/analytics | 顧客分析統計 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| customers | 顧客プロファイル |
| customer_cards | カード情報（トークンのみ） |
| customer_notes | メモ |
| transactions | 取引履歴 |
| subscription_users | サブスク状態 |
| sites | サイト別フィルタ |

### バリデーション

| 項目 | ルール |
|------|-------|
| フリー検索 | 2文字以上で検索開始 |
| カード下4桁 | 半角数字4桁のみ |
| 取引回数（範囲） | 最小 ≤ 最大。0以上の整数 |
| LTV範囲 | 最小 ≤ 最大。0以上の整数。単位：円 |
| タグ入力 | 1タグあたり最大20文字。1顧客あたり最大10タグ。重複不可 |
| メモ入力 | 最大1,000文字。空文字は不可 |

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| タグ削除 | 「タグ「VIP」を削除しますか？」+ [キャンセル] [削除] |
| CSVエクスポート | 「顧客 CUS-XXXXX の取引履歴（XX件）をCSV出力しますか？」+ [キャンセル] [ダウンロード] |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ② 顧客テーブル [詳細] | 顧客詳細スライドパネル | customer_id |
| ⑤ [取引一覧で開く] | S02 取引一覧 | card_last4（カード下4桁でフィルタ） |
| ③ サブスクリプション [S10で開く] | S10 継続・分割決済管理 | subscription_user_id |

---

## M14: リカーリング管理 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M14 |
| メニューID | recurring |
| 画面名 | リカーリング管理 |
| 目的 | 全加盟店の継続/分割決済を横断で監視・管理する（運営向け） |
| アクセス権 | super_admin / admin |

### タブ構成（4タブ）

| タブ | 目的 | 主な利用シーン |
|------|------|-------------|
| 概況 | KPI・アラート・本日の実行予定 | 朝の確認・異常検知 |
| プラン検索 | 全加盟店のプランを横断検索 | 問い合わせ対応・設定確認 |
| ユーザー検索 | 全加盟店のユーザーを横断検索 | 不正調査・個別対応 |
| バッチログ | リカーリングエンジンの実行履歴 | 障害調査・実行確認 |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「リカーリング管理」                      │
│ [概況] [プラン検索] [ユーザー検索] [バッチログ]     │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【概況タブ】                                      │
│ ┌───────────────────────────────────────────┐   │
│ │ ① KPIカード（4つ横並び）                   │   │
│ │ [アクティブプラン] [課金中ユーザー]          │   │
│ │ [本日の実行予定] [リトライ中]               │   │
│ ├──────────────────┬────────────────────────┤   │
│ │ ② アラート        │ ③ 本日の実行予定       │   │
│ │ 自動停止急増      │ 時間帯別の処理件数     │   │
│ │ 失敗率上昇        │ プラン別の処理一覧     │   │
│ └──────────────────┴────────────────────────┘   │
│                                                 │
│ 【プラン検索タブ】                                │
│ ④ 検索フォーム + プランテーブル + 詳細パネル     │
│                                                 │
│ 【ユーザー検索タブ】                              │
│ ⑤ 検索フォーム + ユーザーテーブル + 詳細パネル   │
│                                                 │
│ 【バッチログタブ】                                │
│ ⑥ ログテーブル + エラー詳細パネル               │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### 【概況タブ】

##### ① KPIカード

| KPI | 表示形式 | 閾値アラート |
|-----|---------|------------|
| アクティブプラン数 | 数値 + 前月比 | — |
| 課金中ユーザー数 | 数値 + 前月比 | — |
| 本日の実行予定件数 | 数値 + 実行済み/未実行 内訳 | — |
| リトライ中件数 | 数値（赤色で強調） | 50件以上で赤背景 |

##### ② アラート

| アラート | 条件 | 表示 |
|---------|------|------|
| 自動停止急増 | 直近24hの自動停止が前日比200%以上 | 🔴 赤バナー + 件数 |
| 失敗率上昇 | 直近バッチの失敗率が10%以上 | 🟡 黄バナー + 失敗率 |
| バッチ遅延 | 予定時刻から30分以上遅延 | 🟡 黄バナー + 遅延時間 |
| バッチ未実行 | 予定時刻から2時間以上未実行 | 🔴 赤バナー |

##### ③ 本日の実行予定

| カラム | 内容 |
|--------|------|
| 実行予定時刻 | HH:MM |
| 加盟店名 | — |
| プラン名 | — |
| 対象ユーザー数 | — |
| ステータス | 待機中 / 実行中 / 完了 / エラー |

#### 【プラン検索タブ】

##### ④ プラン横断検索

**検索条件:**

| 条件 | 入力方式 |
|------|---------|
| 加盟店名 | テキスト（部分一致） |
| サイト名 | テキスト（部分一致） |
| プラン名 | テキスト（部分一致） |
| タイプ | チェックボックス（継続 / 分割） |
| ステータス | チェックボックス（有効 / アーカイブ） |

**検索結果テーブル:**

| カラム | 内容 | ソート |
|--------|------|:----:|
| プランID | PLN-XXXXXXXX | ✅ |
| 加盟店名 | — | ✅ |
| サイト名 | — | ✅ |
| プラン名 | — | ✅ |
| タイプ | バッジ（継続/分割） | ✅ |
| 金額 | 初回 / 継続 | ✅ |
| ユーザー数 | アクティブ / 全登録 | ✅ |
| ステータス | バッジ | ✅ |
| 作成日 | — | ✅ |

#### 【ユーザー検索タブ】

##### ⑤ ユーザー横断検索

**検索条件:**

| 条件 | 入力方式 |
|------|---------|
| 加盟店名 | テキスト（部分一致） |
| メールアドレス | テキスト（部分一致） |
| ユーザーID | テキスト（完全一致） |
| ステータス | チェックボックス（課金中/一時停止/停止/完了/自動停止） |
| 連続失敗回数 | 最小〜最大 |

**検索結果テーブル:**

| カラム | 内容 | ソート |
|--------|------|:----:|
| ユーザーID | — | ✅ |
| メール | マスク表示 | ✅ |
| 加盟店名 | — | ✅ |
| プラン名 | — | ✅ |
| ステータス | バッジ | ✅ |
| 次回決済日 | — | ✅ |
| 連続失敗回数 | 赤色で強調（1以上） | ✅ |
| 操作 | [詳細] [強制停止] | — |

#### 【バッチログタブ】

##### ⑥ バッチ実行ログ

| カラム | 内容 | ソート |
|--------|------|:----:|
| 実行日時 | — | ✅ |
| バッチID | — | ✅ |
| 処理件数 | — | ✅ |
| 成功 | 件数（緑） | ✅ |
| 失敗 | 件数（赤） | ✅ |
| リトライ登録 | 件数（黄） | ✅ |
| 処理時間 | XX秒 | ✅ |
| ステータス | 完了 / エラーあり / 中断 | ✅ |
| 操作 | [詳細] | — |

**バッチ詳細パネル（行クリック）:**

| セクション | 内容 |
|-----------|------|
| サマリー | 実行時刻 / 処理件数 / 成功率 / 処理時間 |
| 失敗一覧 | ユーザーID / 加盟店名 / エラーコード / エラー詳細 |
| エラー分布 | エラーコード別の件数棒グラフ |

### バリデーション

| 項目 | ルール |
|------|-------|
| 連続失敗回数（範囲） | 最小 ≤ 最大。0〜99の整数 |
| 強制停止理由 | 必須。最大500文字 |

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| ユーザー強制停止 | 「ユーザー XXX の課金を強制停止しますか？ ⚠️ この操作は加盟店側で取り消せません。運営のみ復旧操作が可能です」+ 理由入力（必須）+ [キャンセル] [強制停止する]（赤ボタン） |

### ロール別権限

| 操作 | super_admin | admin | reviewer |
|------|:-----------:|:-----:|:--------:|
| 概況・KPI閲覧 | ✅ | ✅ | ✅ |
| プラン横断検索 | ✅ | ✅ | ✅ |
| ユーザー横断検索 | ✅ | ✅ | ✅ |
| バッチログ閲覧 | ✅ | ✅ | ✅ |
| ユーザー強制停止 | ✅ | ✅ | ❌ |

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B 内部: GET /api/v1/admin/recurring/dashboard | 概況KPI・アラート |
| Zone B 内部: GET /api/v1/admin/recurring/schedule | 本日の実行予定 |
| Zone B 内部: GET /api/v1/admin/subscription-plans | プラン横断検索 |
| Zone B 内部: GET /api/v1/admin/subscription-users | ユーザー横断検索 |
| Zone B 内部: PUT /api/v1/admin/subscription-users/{id}/force-stop | 強制停止 |
| Zone B 内部: GET /api/v1/admin/recurring-batch-logs | バッチ実行ログ |
| Zone B 内部: GET /api/v1/admin/recurring-batch-logs/{id} | バッチ詳細 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| subscription_plans | 全加盟店のプラン |
| subscription_users | 全加盟店のユーザー |
| transactions | 自動決済の結果 |
| merchants | 加盟店情報 |
| sites | サイト情報 |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ⑤ [詳細] | ユーザー詳細パネル | subscription_user_id |
| ⑤ ユーザー → 取引 | M06 注文管理 | subscription_user_id でフィルタ |
| ④ プラン → 加盟店 | M03 加盟店管理 | merchant_id |

---

## M15: 代理店管理 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M15 |
| メニューID | agents |
| 画面名 | 代理店管理 |
| 目的 | 代理店（セールスパートナー）の登録・条件設定・報酬管理 |
| アクセス権 | super_admin / admin |

### タブ構成（4タブ）

| タブ | 内容 | 主な利用シーン |
|------|------|-------------|
| 代理店一覧 | 登録済み代理店の検索・閲覧 | 代理店の状況確認 |
| 代理店登録 | 新規代理店の登録 | 新規パートナー契約時 |
| 条件設定 | 代理店ごとの紹介料率・契約条件 | 条件変更・確認 |
| 報酬管理 | 月次報酬の計算・確認・支払い管理 | 月次精算業務 |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「代理店管理」                            │
│ [代理店一覧] [代理店登録] [条件設定] [報酬管理]     │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【代理店一覧タブ】                                │
│ ┌───────────────────────────────────────────┐   │
│ │ ① 検索バー + ステータスフィルタ             │   │
│ │ ② 代理店テーブル                           │   │
│ │ コード | 代理店名 | 代表者 | 加盟店数 |      │   │
│ │ ステータス | 登録日 | [詳細] [停止] [解約]   │   │
│ ├───────────────────────────────────────────┤   │
│ │ ③ 代理店詳細パネル（行クリック）            │   │
│ │ 基本情報 + 紹介加盟店一覧 + 報酬サマリー    │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【代理店登録タブ】                                │
│ ④ 登録フォーム                                 │
│                                                 │
│ 【条件設定タブ】                                  │
│ ⑤ 代理店選択 → 料率設定パネル                  │
│                                                 │
│ 【報酬管理タブ】                                  │
│ ⑥ 月次報酬テーブル + 一括計算 + 承認・支払い    │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### 【代理店一覧タブ】

##### ① 検索バー + フィルタ

| 検索条件 | 入力方式 |
|---------|---------|
| 代理店名 / コード | テキスト（部分一致） |
| ステータス | チェックボックス（有効 / 停止 / 解約） |

##### ② 代理店テーブル

| カラム | 内容 | ソート |
|--------|------|:----:|
| 代理店コード | AGT-XXXX | ✅ |
| 代理店名 | — | ✅ |
| 代表者名 | — | — |
| 紹介加盟店数 | 稼働中 / 全紹介数 | ✅ |
| 基本料率 | X.X% | ✅ |
| ステータス | バッジ（有効=緑 / 停止=黄 / 解約=灰） | ✅ |
| 登録日 | YYYY-MM-DD | ✅ |
| 操作 | [詳細] [停止] [解約] | — |

##### ③ 代理店詳細パネル（スライドパネル）

| セクション | 内容 |
|-----------|------|
| 基本情報 | 代理店コード / 名前 / 代表者 / メール / 電話 / 住所 / 登録日 / ステータス |
| 紹介加盟店一覧 | テーブル（加盟店名 / ステータス / 紹介日 / 月間取引額 / 適用料率） |
| 報酬サマリー | 直近6ヶ月の報酬推移グラフ + 累計報酬額 |
| ユーザー一覧 | 代理店スタッフ一覧（名前 / ロール / 最終ログイン） |

#### 【代理店登録タブ】

##### ④ 登録フォーム

| 項目 | 型 | 必須 | バリデーション |
|------|---|:---:|-------------|
| 代理店名 | テキスト | ✅ | 1〜100文字 |
| 代表者名 | テキスト | ✅ | 1〜50文字 |
| メール | email | ✅ | メール形式。重複チェック |
| 電話番号 | 電話 | ❌ | 半角数字・ハイフンのみ。10〜15桁 |
| 住所 | テキスト | ❌ | 最大200文字 |
| 基本紹介料率(%) | 数値 | ✅ | 0.1〜50.0%。小数点第1位まで |
| 契約条件メモ | テキストエリア | ❌ | 最大2,000文字 |

**登録完了後の自動処理:**
```
1. agent_code（AGT-XXXX）自動採番
2. agent_admin ロールの初期ユーザーアカウント自動作成
3. メールでログイン情報通知（パスワード設定URL付き、有効期限72h）
```

#### 【条件設定タブ】

##### ⑤ 料率設定パネル

| 機能 | 仕様 |
|------|------|
| 代理店選択 | ドロップダウンで代理店を選択 |
| 基本料率 | 表示・編集（この代理店のデフォルト報酬率） |
| 個別加盟店料率 | テーブル（加盟店名 / 基本料率適用 / 個別料率）+ [個別設定] |
| 契約期間 | 開始日 / 終了日（NULLで無期限） |
| 契約条件メモ | 自由記述エリア |

**個別料率の優先順位:**
```
個別料率（agent_merchants.commission_rate）が設定されている場合 → 個別料率を適用
NULLの場合 → 基本料率（agents.default_commission_rate）を適用
```

#### 【報酬管理タブ】

##### ⑥ 月次報酬テーブル

| カラム | 内容 | ソート |
|--------|------|:----:|
| 対象月 | YYYY年MM月 | ✅ |
| 代理店名 | — | ✅ |
| 対象加盟店数 | — | ✅ |
| 取引総額 | ¥XX,XXX,XXX | ✅ |
| 報酬額 | ¥XX,XXX | ✅ |
| ステータス | バッジ（未計算=灰 / 計算済=黄 / 確定=青 / 支払済=緑） | ✅ |
| 操作 | [承認] [支払完了] [詳細] | — |

**一括操作ボタン:**

| ボタン | 仕様 |
|--------|------|
| [今月の報酬を計算] | 全代理店の当月報酬を一括計算。バックグラウンドジョブで実行、完了後に通知 |
| [CSV出力] | 表示中の報酬データをCSV出力 |

**報酬ステータス遷移:**
```
未計算 → [報酬を計算] → 計算済 → [承認] → 確定 → [支払完了] → 支払済
※ 計算済から再計算も可能（上書き）
※ 確定後の金額変更は不可
```

### バリデーション

| 項目 | ルール |
|------|-------|
| 代理店名 | 必須。1〜100文字 |
| メールアドレス | 必須。メール形式。既存代理店と重複不可 |
| 基本紹介料率 | 必須。0.1〜50.0%。小数点第1位まで |
| 個別料率 | 0.1〜50.0%。基本料率より高い場合は警告表示（エラーではない） |
| 契約開始日 | 設定する場合: 終了日より前 |
| 電話番号 | 半角数字・ハイフンのみ |

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| 代理店登録 | 「以下の内容で代理店を登録しますか？ 登録と同時に管理者アカウントが作成され、メールで通知されます」+ 入力サマリー + [キャンセル] [登録する] |
| 代理店停止 | 「代理店 AGT-XXXX を停止しますか？ 停止中は代理店ポータルにログインできなくなります。紹介加盟店の決済には影響しません」+ [キャンセル] [停止する]（黄ボタン） |
| 代理店解約 | 「代理店 AGT-XXXX を解約しますか？ ⚠️ 紹介加盟店との紐付けが解除されます。未払い報酬がある場合は先に精算してください」+ [キャンセル] [解約する]（赤ボタン） |
| 報酬承認 | 「YYYY年MM月分の報酬 ¥XX,XXX を確定しますか？ 確定後は金額を変更できません」+ [キャンセル] [確定する] |
| 支払完了 | 「支払い完了にしますか？ ステータスが「支払済」に更新されます」+ [キャンセル] [完了にする] |
| 一括計算 | 「全代理店のYYYY年MM月分の報酬を一括計算しますか？ 既に計算済みのデータは上書きされます」+ [キャンセル] [計算開始] |

### ロール別権限

| 操作 | super_admin | admin | reviewer |
|------|:-----------:|:-----:|:--------:|
| 代理店一覧閲覧 | ✅ | ✅ | ✅ |
| 代理店詳細閲覧 | ✅ | ✅ | ✅ |
| 代理店登録 | ✅ | ✅ | ❌ |
| 代理店停止・解約 | ✅ | ❌ | ❌ |
| 条件設定（料率変更） | ✅ | ✅ | ❌ |
| 報酬計算 | ✅ | ✅ | ❌ |
| 報酬承認 | ✅ | ❌ | ❌ |
| 支払完了 | ✅ | ❌ | ❌ |
| CSV出力 | ✅ | ✅ | ✅ |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| agents | 代理店情報 |
| agent_users | 代理店ユーザー |
| agent_merchants | 代理店×加盟店紐付け |
| agent_commissions | 報酬計算・支払い |
| merchants | 紹介加盟店の情報 |
| transactions | 報酬計算の元データ |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ③ 紹介加盟店一覧 → 加盟店クリック | M03 加盟店管理 | merchant_id |
| ⑥ 報酬詳細 → 加盟店別内訳 | M03 加盟店管理 | merchant_id |
| D04 紹介申請 → M04 | M04 申込・登録管理 | application_id |

---

## M16: 顧客管理 🆕 v1.2

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | M16 |
| メニューID | customers |
| 画面名 | 顧客管理 |
| 目的 | 全加盟店の決済顧客を横断で検索・分析し、不正対応・問い合わせ対応を効率化する（簡易CRM） |
| アクセス権 | super_admin / admin（全操作）/ reviewer（閲覧のみ） |

### タブ構成（3タブ）

| タブ | 目的 | 主な利用シーン |
|------|------|-------------|
| 顧客検索 | カード下4桁・メール等で顧客を特定する | 加盟店からの問い合わせ・不正調査 |
| 顧客詳細 | 顧客のプロファイルと全取引履歴を確認 | 取引パターン分析・CB対応 |
| 顧客分析 | 全体の顧客統計・セグメント別分析 | レポート・傾向把握 |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「顧客管理」                              │
│ [顧客検索] [顧客詳細] [顧客分析]  ← タブ切替      │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【顧客検索タブ】                                  │
│ ┌───────────────────────────────────────────┐   │
│ │ ① 検索フォーム                             │   │
│ │ メール / カード下4桁 / 電話 / 名前          │   │
│ │ 加盟店 / サイト / 期間 / 取引回数範囲       │   │
│ ├───────────────────────────────────────────┤   │
│ │ ② 検索結果テーブル                         │   │
│ │ 顧客ID | メール | カード | 取引回数 | LTV   │   │
│ │ 最終取引 | サブスク状態 | リスク | [詳細]    │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【顧客詳細タブ（スライドパネル）】                   │
│ ┌────────────────┬──────────────────────────┐   │
│ │ ③ プロファイル   │ ④ 取引履歴              │   │
│ │ 基本情報        │ 全取引のタイムライン      │   │
│ │ カード情報      │ CB/返金の履歴            │   │
│ │ リスクスコア    │ サブスクリプション状態    │   │
│ │ メモ           │ 不正検知アラート          │   │
│ ├────────────────┴──────────────────────────┤   │
│ │ ⑤ 操作: [ブロック] [ホワイトリスト] [メモ]   │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【顧客分析タブ】                                  │
│ ⑥ KPI + セグメント分析 + リピート率推移          │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### 【顧客検索タブ】

##### ① 検索フォーム

| 検索条件 | 入力方式 |
|---------|---------|
| 顧客ID | テキスト入力（完全一致） |
| メールアドレス | テキスト入力（部分一致） |
| カード下4桁 | 4桁数字入力 |
| BIN6桁 | 6桁数字入力（発行元特定用） |
| 電話番号 | テキスト入力 |
| 名前（カード名義） | テキスト入力（部分一致） |
| 加盟店 | ドロップダウン選択 |
| サイト | ドロップダウン（加盟店選択後に絞込） |
| 取引回数 | 最小 〜 最大 |
| LTV範囲 | 最小金額 〜 最大金額 |
| 最終取引日 | 期間指定 |
| リスクレベル | チェックボックス（低/中/高/ブロック済） |
| サブスク状態 | チェックボックス（課金中/停止/なし） |

##### ② 検索結果テーブル

| カラム | 内容 | ソート |
|--------|------|:----:|
| 顧客ID | CUS-XXXXXXXX（自動採番） | ✅ |
| メール | マスク表示（t***@example.com）※ クリックで全表示 | ✅ |
| カード | 下4桁 + ブランドアイコン | ✅ |
| 加盟店 | 最も取引が多い加盟店名 | ✅ |
| 取引回数 | 総取引件数 | ✅ |
| LTV | 累計決済金額（¥XX,XXX） | ✅ |
| 最終取引 | 日時 | ✅ |
| サブスク | バッジ（課金中/停止/なし） | ✅ |
| リスク | バッジ（低=緑/中=黄/高=赤/ブロック=黒） | ✅ |
| 操作 | [詳細] | — |

#### 【顧客詳細タブ】（行クリック or [詳細] で右スライドパネル表示）

##### ③ プロファイル（左側）

| セクション | 内容 |
|-----------|------|
| 基本情報 | 顧客ID / メール / 電話 / 名前（カード名義）/ 初回取引日 / 最終取引日 |
| カード情報 | 登録カード一覧（ブランド / 下4桁 / 有効期限 / 登録日 / 最終使用日）※ カード番号本体はCDE内、ここにはトークンのみ |
| リスクスコア | AIリスクスコア（0-100）+ 手動設定のリスクレベル + 不正検知アラート件数 |
| サブスクリプション | 契約中のプラン一覧（プラン名 / 加盟店 / ステータス / 次回決済日） |
| タグ | 運営が付与したタグ（VIP / 要注意 / CB常習 等、自由入力） |
| メモ | 運営メモ（自由記述、複数件追記可能、タイムスタンプ付き） |

##### ④ 取引履歴（右側）

| 機能 | 仕様 |
|------|------|
| タイムライン表示 | 全取引を時系列で表示（新しい順） |
| 取引カード | 日時 / 加盟店 / サイト / 金額 / ブランド / ステータス / 接続先 |
| フィルタ | ステータス（成功/失敗/返金/CB）/ 加盟店 / 期間 |
| CB/返金履歴 | チャージバック・返金の一覧（日時 / 金額 / 理由 / ステータス） |
| 不正検知アラート | この顧客に関するM07の不正検知アラート一覧 |
| 統計サマリー | 総取引数 / 成功率 / 平均単価 / CB率 / 月別推移ミニグラフ |

##### ⑤ 操作ボタン

| 操作 | 仕様 |
|------|------|
| ブロック | この顧客のカードをM07ブロックリストに追加。確認ダイアログ + 理由入力必須 |
| ホワイトリスト | この顧客をM07ホワイトリストに追加（誤検知対策）。確認ダイアログ |
| メモ追加 | テキスト入力 → タイムスタンプ付きで保存。過去メモ一覧も表示 |
| タグ編集 | タグの追加・削除 |
| 取引検索で開く | M06注文管理にこの顧客のカード下4桁でフィルタして遷移 |

#### 【顧客分析タブ】

##### ⑥ 全体統計

| KPI | 説明 |
|-----|------|
| 総顧客数 | ユニーク顧客数（カード下4桁+メールで名寄せ） |
| アクティブ顧客 | 直近30日以内に取引がある顧客数 |
| 平均LTV | 顧客あたりの累計決済額の平均 |
| リピート率 | 2回以上取引がある顧客の割合 |

| 分析チャート | 説明 |
|------------|------|
| セグメント分布 | 円グラフ（1回のみ / 2-5回 / 6-20回 / 21回以上） |
| 月別新規顧客数 | 棒グラフ（直近12ヶ月） |
| リピート率推移 | 折れ線グラフ（直近12ヶ月） |
| LTV分布 | ヒストグラム（金額帯ごとの顧客数） |
| 加盟店別顧客数 | 横棒グラフ（上位10加盟店） |

### 顧客の名寄せルール

決済システムでは顧客の「アカウント」が明示的に存在しないため、以下のルールで名寄せを行う:

```
名寄せキー（優先順）:
1. 加盟店が送信した user_identifier（加盟店側のユーザーID）
2. メールアドレス（完全一致）
3. カード下4桁 + カード有効期限（同一カード判定）

※ 同一人物でもカードが異なる場合は別顧客としてカウント
※ 加盟店のuser_identifierがある場合はそれを最優先で使用
※ 名寄せは加盟店（サイト）ごとに独立（加盟店Aと加盟店Bで同じメールでも別顧客）
```

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B 内部: GET /api/v1/admin/customers | 顧客検索 |
| Zone B 内部: GET /api/v1/admin/customers/{id} | 顧客詳細 |
| Zone B 内部: GET /api/v1/admin/customers/{id}/transactions | 顧客の取引履歴 |
| Zone B 内部: PUT /api/v1/admin/customers/{id}/tags | タグ更新 |
| Zone B 内部: POST /api/v1/admin/customers/{id}/notes | メモ追加 |
| Zone B 内部: POST /api/v1/admin/customers/{id}/block | ブロック |
| Zone B 内部: POST /api/v1/admin/customers/{id}/whitelist | ホワイトリスト追加 |
| Zone B 内部: GET /api/v1/admin/customers/analytics | 顧客分析統計 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| customers | 顧客プロファイル |
| customer_cards | 顧客のカード情報（トークン） |
| customer_notes | 運営メモ |
| transactions | 取引履歴 |
| subscription_users | サブスクリプション状態 |
| fraud_alerts | 不正検知アラート |
| block_list / white_list | ブロック/ホワイトリスト |
| merchants / sites | 加盟店・サイト情報 |

### バリデーション

| 項目 | ルール |
|------|-------|
| カード下4桁 | 半角数字4桁のみ。3桁以下は検索不可 |
| BIN6桁 | 半角数字6桁のみ。5桁以下は検索不可 |
| メールアドレス | 2文字以上で部分一致検索開始 |
| 電話番号 | 半角数字・ハイフンのみ。3文字以上で検索可 |
| 取引回数（範囲） | 最小 ≤ 最大。0以上の整数。最大値は99,999 |
| LTV範囲 | 最小 ≤ 最大。0以上の整数。単位：円 |
| 最終取引日（期間） | 開始日 ≤ 終了日。未来日は不可 |
| タグ入力 | 1タグあたり最大20文字。1顧客あたり最大10タグ。重複不可 |
| メモ入力 | 最大1,000文字。空文字は不可 |
| ブロック理由 | 必須。最大500文字 |

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| ブロック | 「顧客 CUS-XXXXX のカード（VISA *4242）をブロックリストに追加しますか？ この操作により、同カードでの今後の決済が全て拒否されます」+ 理由入力（必須）+ [キャンセル] [ブロックする]（赤ボタン）|
| ホワイトリスト追加 | 「顧客 CUS-XXXXX をホワイトリストに追加しますか？ 不正検知ルールの適用対象外になります」+ [キャンセル] [追加する] |
| タグ削除 | 「タグ「VIP」を削除しますか？」+ [キャンセル] [削除] |

### ロール別権限

| 操作 | super_admin | admin | reviewer |
|------|:-----------:|:-----:|:--------:|
| 顧客検索・一覧閲覧 | ✅ | ✅ | ✅ |
| 顧客詳細閲覧 | ✅ | ✅ | ✅ |
| メール全表示（マスク解除） | ✅ | ✅ | ❌ |
| メモ追加 | ✅ | ✅ | ❌ |
| タグ編集 | ✅ | ✅ | ❌ |
| ブロック | ✅ | ✅ | ❌ |
| ホワイトリスト追加 | ✅ | ✅ | ❌ |
| 顧客分析閲覧 | ✅ | ✅ | ✅ |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ② 検索結果 [詳細] | 顧客詳細パネル | customer_id |
| ⑤ [取引検索で開く] | M06 注文管理 取引検索タブ | card_last4（カード下4桁でフィルタ） |
| ⑤ [ブロック] → 完了後 | M07 不正検知設定 | block_list に該当カード追加済み |
| ③ サブスクリプション [詳細] | M14 リカーリング管理 | subscription_user_id |
| M06 関連取引 → 顧客 | M16 顧客詳細 | customer_id |

# 代理店管理画面 🆕 v1.1

> 代理店（セールスパートナー）が紹介した加盟店の状況確認・報酬確認を行う専用画面。

---

## D01: ダッシュボード 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | D01 |
| メニューID | d_dashboard |
| 画面名 | ダッシュボード |
| 目的 | 紹介加盟店のKPIと報酬サマリーを一目で確認する |
| アクセス権 | agent_admin / agent_viewer |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「ダッシュボード」                        │
├─────────────────────────────────────────────────┤
│ ① KPIカード（4つ横並び）                         │
│ [紹介加盟店数] [今月取引額] [今月報酬見込] [先月確定]│
├────────────────────┬────────────────────────────┤
│ ② 加盟店ステータス  │ ③ 月別報酬推移            │
│ （円グラフ）        │ （棒グラフ・直近6ヶ月）     │
├────────────────────┴────────────────────────────┤
│ ④ 最新の紹介加盟店（直近5件テーブル）              │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### ① KPIカード

| KPI | 表示形式 | データソース |
|-----|---------|------------|
| 紹介加盟店数（稼働中） | 数値 + 前月比 | agent_merchants WHERE status='active' |
| 今月の取引総額 | ¥XX,XXX + 前月比 | transactions（紹介加盟店分の当月合計） |
| 今月の報酬見込み | ¥XX,XXX | 取引総額 × 適用料率（リアルタイム試算） |
| 先月の報酬確定額 | ¥XX,XXX + ステータスバッジ | agent_commissions（前月分） |

#### ② 加盟店ステータス

| 表示 | 仕様 |
|------|------|
| グラフ種類 | 円グラフ（ドーナツ型） |
| セグメント | 稼働中（緑）/ 審査中（黄）/ 停止中（灰） |
| 中央表示 | 合計加盟店数 |
| クリック | 各セグメントクリック → D02に該当ステータスでフィルタして遷移 |

#### ③ 月別報酬推移

| 表示 | 仕様 |
|------|------|
| グラフ種類 | 棒グラフ |
| 期間 | 直近6ヶ月 |
| 棒の色分け | 確定済み=青 / 未確定=青（薄）/ 支払済=緑 |
| ホバー | 月の報酬額・ステータスをツールチップ表示 |

#### ④ 最新の紹介加盟店

| カラム | 内容 |
|--------|------|
| 加盟店名 | — |
| 法人名 | — |
| ステータス | バッジ（審査中/稼働中/停止中） |
| 紹介日 | YYYY-MM-DD |
| 月間取引額 | ¥XX,XXX（直近30日） |

表示件数: 直近5件。[もっと見る →] で D02 へ遷移。

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B: GET /api/v1/agent/dashboard/kpi | KPIデータ |
| Zone B: GET /api/v1/agent/dashboard/merchant-status | 加盟店ステータス集計 |
| Zone B: GET /api/v1/agent/dashboard/commission-trend | 報酬推移 |
| Zone B: GET /api/v1/agent/merchants?limit=5&sort=created_at:desc | 最新紹介加盟店 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| agent_merchants | 紹介加盟店の紐付け |
| merchants | 加盟店情報 |
| transactions | 取引額集計 |
| agent_commissions | 報酬データ |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ② 加盟店ステータス（セグメントクリック） | D02 加盟店一覧 | status フィルタ |
| ④ [もっと見る →] | D02 加盟店一覧 | — |
| ④ 加盟店名クリック | D02 加盟店詳細 | merchant_id |

---

## D02: 加盟店一覧 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | D02 |
| メニューID | d_merchants |
| 画面名 | 加盟店一覧 |
| 目的 | 自分が紹介した加盟店の状況を確認する |
| アクセス権 | agent_admin / agent_viewer |
| データ範囲 | **自分が紹介した加盟店のみ**（他代理店の加盟店は見えない） |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「加盟店一覧」                           │
├─────────────────────────────────────────────────┤
│ ① 検索バー + フィルタ                             │
├─────────────────────────────────────────────────┤
│ ② 加盟店テーブル                                 │
│ 加盟店名 | 法人名 | ステータス | 月間取引額 |       │
│ 紹介日 | 適用料率 | [詳細]                         │
├──────────────────┬──────────────────────────────┤
│ ③ 加盟店サマリー   │（スライドパネル・行クリック）  │
│ 月間売上推移       │ 取引統計                     │
└──────────────────┴──────────────────────────────┘
```

### 機能詳細

#### ① 検索バー + フィルタ

| 検索条件 | 入力方式 |
|---------|---------|
| 加盟店名 / 法人名 | テキスト入力（部分一致） |
| ステータス | チェックボックス（稼働中 / 審査中 / 停止中） |

#### ② 加盟店テーブル

| カラム | 内容 | ソート |
|--------|------|:----:|
| 加盟店名 | — | ✅ |
| 法人名 | — | ✅ |
| ステータス | バッジ（稼働中=緑 / 審査中=黄 / 停止中=灰） | ✅ |
| 月間取引額 | ¥XX,XXX（直近30日） | ✅ |
| 紹介日 | YYYY-MM-DD | ✅ |
| 適用料率 | X.X% | ✅ |
| 操作 | [詳細] | — |

ページネーション: 1ページ20件。

#### ③ 加盟店サマリー（スライドパネル）

| セクション | 内容 |
|-----------|------|
| 基本情報 | 加盟店名 / 法人名 / 業種 / 紹介日 / ステータス |
| 月間売上推移 | 棒グラフ（直近6ヶ月の月間取引額） |
| 取引統計 | 今月取引件数 / 今月取引額 / 成功率 / 平均単価 |
| 報酬情報 | 適用料率 / 今月の報酬見込み額 |

※ 代理店は加盟店の **手数料率・接続先設定・個別取引明細** は閲覧不可。月間サマリーのみ参照可能。

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B: GET /api/v1/agent/merchants | 紹介加盟店一覧 |
| Zone B: GET /api/v1/agent/merchants/{id}/summary | 加盟店サマリー |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| agent_merchants | 紹介加盟店の紐付け |
| merchants | 加盟店基本情報 |
| transactions | 取引サマリー集計 |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ② [詳細] / 行クリック | ③ 加盟店サマリーパネル | merchant_id |

---

## D03: 報告書 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | D03 |
| メニューID | d_reports |
| 画面名 | 報告書 |
| 目的 | 月次の代理店報酬明細を確認・ダウンロードする |
| アクセス権 | agent_admin / agent_viewer |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「報告書」                               │
├─────────────────────────────────────────────────┤
│ ① 報告書一覧テーブル                              │
│ 対象月 | 加盟店数 | 取引総額 | 報酬額 | ステータス  │
│ [📄PDF] [📥CSV] [詳細]                           │
├─────────────────────────────────────────────────┤
│ ② 報酬明細（スライドパネル・行クリック）            │
│ 加盟店ごとの内訳テーブル                          │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### ① 報告書一覧テーブル

| カラム | 内容 | ソート |
|--------|------|:----:|
| 対象月 | YYYY年MM月 | ✅ |
| 対象加盟店数 | 報酬対象の加盟店数 | ✅ |
| 取引総額 | ¥XX,XXX,XXX | ✅ |
| 報酬額 | ¥XX,XXX | ✅ |
| ステータス | バッジ（計算中=黄 / 確定=青 / 支払済=緑） | ✅ |
| 操作 | [📄 PDF] [📥 CSV] [詳細] | — |

デフォルトソート: 対象月の降順（最新月が上）。
ページネーション: 1ページ12件（1年分）。

#### ② 報酬明細（スライドパネル）

行クリック or [詳細] で右パネルに月次明細を表示。

**ヘッダー情報:**
| 項目 | 内容 |
|------|------|
| 対象月 | YYYY年MM月 |
| ステータス | バッジ |
| 取引総額 | ¥XX,XXX,XXX |
| 報酬合計 | ¥XX,XXX |

**加盟店別内訳テーブル:**

| カラム | 内容 |
|--------|------|
| 加盟店名 | — |
| 取引件数 | — |
| 取引金額 | ¥XX,XXX |
| 適用料率 | X.X% |
| 報酬額 | ¥XX,XXX |

**PDF出力仕様:**
| 項目 | 仕様 |
|------|------|
| ファイル名 | 報酬明細_YYYYMM_代理店名.pdf |
| 内容 | ヘッダー（代理店情報・対象月）+ 加盟店別明細テーブル + 合計行 |
| フッター | 発行日 / ページ番号 |

**CSV出力仕様:**
| 項目 | 仕様 |
|------|------|
| ファイル名 | 報酬明細_YYYYMM.csv |
| 文字コード | UTF-8（BOM付き） |
| カラム | 対象月, 加盟店名, 法人名, 取引件数, 取引金額, 適用料率, 報酬額 |

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| PDF出力 | ダイアログなし（即時ダウンロード開始） |
| CSV出力 | ダイアログなし（即時ダウンロード開始） |

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B: GET /api/v1/agent/reports | 報告書一覧 |
| Zone B: GET /api/v1/agent/reports/{year_month}/detail | 月次明細 |
| Zone B: GET /api/v1/agent/reports/{year_month}/pdf | PDF出力 |
| Zone B: GET /api/v1/agent/reports/{year_month}/csv | CSV出力 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| agent_commissions | 報酬データ |
| agent_merchants | 紹介加盟店の紐付け |
| merchants | 加盟店名 |
| transactions | 取引集計 |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| ① [詳細] / 行クリック | ② 報酬明細パネル | year_month |

---

## D04: 申込紹介 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | D04 |
| メニューID | d_referral |
| 画面名 | 申込紹介 |
| 目的 | 新規加盟店の紹介申請を行う |
| アクセス権 | agent_admin のみ（agent_viewer はこの画面にアクセス不可） |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「申込紹介」                              │
├─────────────────────────────────────────────────┤
│ ① 紹介申請フォーム                                │
│ 法人名 / 代表者 / 担当者 / メール / 電話 / URL     │
│ 業種 / 月間予想売上 / 備考                         │
│ [紹介申請を送信]                                  │
├─────────────────────────────────────────────────┤
│ ② 申請履歴テーブル                                │
│ 法人名 | 申請日 | ステータス | 結果 | メモ         │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### ① 紹介申請フォーム

| 項目 | 型 | 必須 | バリデーション |
|------|---|:---:|-------------|
| 法人名 | テキスト | ✅ | 1〜100文字 |
| 代表者名 | テキスト | ✅ | 1〜50文字 |
| 担当者名 | テキスト | ✅ | 1〜50文字 |
| 担当者メール | email | ✅ | メール形式。重複チェック（同じメールで申請中がないか） |
| 担当者電話 | 電話 | ✅ | 半角数字・ハイフンのみ。10〜15桁 |
| サイトURL | URL | ✅ | URL形式（https:// で始まること） |
| 業種 | 選択 | ✅ | 選択肢: EC物販 / デジタルコンテンツ / サービス / SaaS / 旅行・宿泊 / 飲食 / 教育 / その他 |
| 月間予想売上 | 数値 | ✅ | 1万円以上。整数のみ |
| 備考 | テキストエリア | ❌ | 最大1,000文字 |

**申請フロー:**
```
1. 代理店がフォーム入力 → [紹介申請を送信]
2. M04 申込・登録管理に「代理店紹介」として投入（agent_id 自動付与）
3. 運営が確認 → 加盟店候補に申込フォーム（P01）のURLを送信
4. 加盟店がP01で正式申込 → 通常の審査フロー
5. 承認後、agent_merchants に紐付けレコード自動作成
```

#### ② 申請履歴テーブル

| カラム | 内容 | ソート |
|--------|------|:----:|
| 法人名 | — | ✅ |
| 担当者名 | — | — |
| サイトURL | リンク表示 | — |
| 申請日 | YYYY-MM-DD | ✅ |
| ステータス | バッジ（申請中=黄 / 運営確認中=青 / P01送信済=紫 / 審査中=青 / 承認=緑 / 否認=赤） | ✅ |
| 運営メモ | 運営からのコメント（あれば表示） | — |

デフォルトソート: 申請日の降順。

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| 紹介申請送信 | 「以下の内容で紹介申請を送信しますか？」+ 入力内容サマリー + [キャンセル] [送信する] |

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B: POST /api/v1/agent/referrals | 紹介申請送信 |
| Zone B: GET /api/v1/agent/referrals | 申請履歴一覧 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| applications | 紹介申請（type='agent_referral'） |
| agent_merchants | 承認後の紐付け |

### 画面遷移

| 遷移元 | 遷移先 | パラメータ |
|--------|--------|----------|
| 送信完了 | ② 申請履歴（最新が上に追加） | — |

---

## D05: アカウント設定 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | D05 |
| メニューID | d_account |
| 画面名 | アカウント設定 |
| 目的 | 代理店情報・スタッフ管理・セキュリティ設定 |
| アクセス権 | agent_admin（全設定）/ agent_viewer（自分のセキュリティのみ） |

### タブ構成（3タブ）

| タブ | 内容 | admin | viewer |
|------|------|:-----:|:------:|
| 代理店情報 | 代理店名・代表者・連絡先（閲覧のみ。変更は運営に連絡） | 閲覧 | 閲覧 |
| スタッフ管理 | ユーザー一覧 / 招待 / ロール変更 / 無効化 | ✅ | ❌（タブ非表示） |
| セキュリティ | パスワード変更 / MFA設定 / ログイン履歴 | ✅ | 自分のみ |

### UIエリア構成

```
┌─────────────────────────────────────────────────┐
│ ヘッダー: 「アカウント設定」                        │
│ [代理店情報] [スタッフ管理] [セキュリティ]          │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【代理店情報タブ】                                │
│ ┌───────────────────────────────────────────┐   │
│ │ ① 代理店基本情報（閲覧のみ）               │   │
│ │ 代理店ID / 代理店名 / 代表者 / 住所 / 電話  │   │
│ │ 担当者メール / 契約日 / ステータス           │   │
│ │ ※変更は運営へお問い合わせ                   │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【スタッフ管理タブ】（admin のみ表示）             │
│ ┌───────────────────────────────────────────┐   │
│ │ ② スタッフ一覧テーブル                     │   │
│ │ 名前 | メール | ロール | ステータス | [編集]  │   │
│ ├───────────────────────────────────────────┤   │
│ │ ③ [＋ スタッフ招待]                        │   │
│ │ メール / ロール選択 → 招待メール送信         │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ 【セキュリティタブ】                              │
│ ┌───────────────────────────────────────────┐   │
│ │ ④ パスワード変更フォーム                    │   │
│ │ ⑤ MFA設定（有効/無効 + QRコード）          │   │
│ │ ⑥ ログイン履歴（直近20件）                 │   │
│ └───────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

### 機能詳細

#### 【代理店情報タブ】

##### ① 代理店基本情報

| 表示項目 | 内容 |
|---------|------|
| 代理店ID | AGT-XXXX |
| 代理店名 | — |
| 代表者名 | — |
| 住所 | — |
| 電話番号 | — |
| 担当者メール | — |
| 契約日 | — |
| 契約ステータス | 有効 / 停止 |
| 適用料率 | 紹介加盟店に対する報酬料率 |

※ 全項目 **閲覧のみ**。変更が必要な場合は「運営へお問い合わせください」と表示。

#### 【スタッフ管理タブ】

##### ② スタッフ一覧テーブル

| カラム | 内容 |
|--------|------|
| 名前 | — |
| メールアドレス | — |
| ロール | agent_admin / agent_viewer |
| ステータス | 有効 / 無効 / 招待中 |
| 最終ログイン | 日時 |
| 操作 | [ロール変更] [無効化] |

##### ③ スタッフ招待

| 項目 | 型 | 必須 | バリデーション |
|------|---|:---:|-------------|
| メールアドレス | email | ✅ | メール形式。既に登録済みの場合エラー |
| ロール | 選択 | ✅ | agent_admin / agent_viewer |

招待メールが送信され、受信者がリンクからパスワード設定後に利用開始。

#### 【セキュリティタブ】

##### ④ パスワード変更

| 項目 | バリデーション |
|------|-------------|
| 現在のパスワード | 必須。一致チェック |
| 新しいパスワード | 12文字以上 / 英大文字+小文字+数字+特殊文字 / 過去5回再利用禁止 / 現在のパスワードと異なること（PCI DSS v4.0 Req 8.3.6準拠） |
| 新しいパスワード（確認） | 新しいパスワードと一致 |

##### ⑤ MFA設定

| 機能 | 仕様 |
|------|------|
| 現在の状態 | 有効 / 無効（バッジ表示） |
| 有効化 | QRコード表示 → TOTP アプリで読み取り → 6桁コード入力で確認 |
| 無効化 | 現在のパスワード入力 + 確認ダイアログ |
| リカバリーコード | MFA有効化時に8桁×5個のリカバリーコードを表示（一度きり） |

##### ⑥ ログイン履歴

| カラム | 内容 |
|--------|------|
| 日時 | — |
| IPアドレス | — |
| デバイス | ブラウザ / OS |
| 結果 | 成功 / 失敗 |
| 場所 | IPから推定した都市名 |

直近20件表示。不審なログインがある場合は赤色ハイライト。

### 確認ダイアログ

| 操作 | ダイアログ内容 |
|------|-------------|
| スタッフ無効化 | 「〇〇さんのアカウントを無効化しますか？ 無効化するとログインできなくなります」+ [キャンセル] [無効化する]（赤ボタン） |
| ロール変更 | 「〇〇さんのロールを admin → viewer に変更しますか？」+ [キャンセル] [変更する] |
| MFA無効化 | 「MFAを無効化しますか？ セキュリティが低下します」+ 現在のパスワード入力 + [キャンセル] [無効化する]（赤ボタン） |

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone B: GET /api/v1/agent/profile | 代理店基本情報取得 |
| Zone B: GET /api/v1/agent/users | スタッフ一覧 |
| Zone B: POST /api/v1/agent/users/invite | スタッフ招待 |
| Zone B: PUT /api/v1/agent/users/{id}/role | ロール変更 |
| Zone B: PUT /api/v1/agent/users/{id}/disable | スタッフ無効化 |
| Zone B: PUT /api/v1/agent/security/password | パスワード変更 |
| Zone B: POST /api/v1/agent/security/mfa/enable | MFA有効化 |
| Zone B: POST /api/v1/agent/security/mfa/disable | MFA無効化 |
| Zone B: GET /api/v1/agent/security/login-history | ログイン履歴 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| agents | 代理店基本情報 |
| agent_users | スタッフ情報 |
| login_history | ログイン履歴 |

---

## P02: 決済ページ 🆕 v1.1

### 画面概要

| 項目 | 内容 |
|------|------|
| 画面ID | P02 |
| メニューID | — |
| 画面名 | 決済ページ |
| 目的 | URL決済リンクからアクセスする決済入力ページ |
| アクセス権 | 一般公開（認証不要） |
| URL形式 | https://pay.aipayment.jp/l/{link_code} |

### 機能

| 機能 | 仕様 |
|------|------|
| 商品情報表示 | 商品名 / 金額 / 加盟店名（サイト名） |
| 金額入力 | 金額入力型の場合、顧客が金額を入力 |
| 金額選択 | 金額選択型の場合、ドロップダウンから選択 |
| カード情報入力 | カード番号 / 有効期限 / セキュリティコード / カード名義（CDE内iframeで処理） |
| フリー項目入力 | リンク設定で定義されたフリー項目の入力 |
| ユーザーID入力 | リンク設定でONの場合、ユーザーIDの入力欄表示 |
| 3Dセキュア | 対応カードブランドの場合、3DS認証フローへリダイレクト |
| 決済実行 | [お支払い] → 決済処理 → 完了画面 |
| エラー表示 | リンク無効 / 期限切れ / 上限到達 → エラーメッセージ表示 |

**画面レイアウト:**
```
┌────────────────────────────────────┐
│  🔒 安全なお支払い                    │
│                                    │
│  ┌──────────────────────────────┐  │
│  │  商品名: プレミアムプラン        │  │
│  │  金額: ¥9,800               │  │
│  │  お支払い先: 〇〇ショップ       │  │
│  └──────────────────────────────┘  │
│                                    │
│  カード番号  ___________________   │
│  有効期限    __/__  CVC ___       │
│  カード名義  ___________________   │
│                                    │
│  [  💳 ¥9,800 を支払う  ]          │
│                                    │
│  🔒 SSL暗号化通信 │ PCI DSS準拠    │
└────────────────────────────────────┘
```

**バリデーション:**

| 項目 | ルール |
|------|-------|
| カード番号 | Luhnアルゴリズムチェック / ブランド判定（VISA:4xxx / MC:5xxx / JCB:35xx） |
| 有効期限 | 未来日であること |
| CVC | 3桁（AMEXは4桁） |
| 金額入力（金額入力型） | 1円以上 / 整数のみ / 上限額チェック |
| リンク有効性 | link_code存在 / status=active / 期限内 / 利用回数内 |

### 使用するAPI

| API | 用途 |
|-----|------|
| Zone A: GET /api/v1/payment-links/{link_code}/info | リンク情報取得（商品名・金額等） |
| Zone A: POST /api/v1/payment-links/{link_code}/pay | リンク決済実行 |
| CDE: POST /api/v1/tokens | カードトークン化 |

### 参照するDBテーブル

| テーブル | 用途 |
|---------|------|
| payment_links | リンク情報の取得・利用回数更新 |
| transactions | 決済レコード作成 |
| sites | サイト情報（表示用） |

### UIエリア構成（画面フロー全体）

```
┌──────────── P02 画面フロー ────────────┐
│                                        │
│  ① リンクアクセス                       │
│  ↓                                     │
│  [有効?] ─ NO → ⑦ エラー画面          │
│  ↓ YES                                 │
│  ② 商品情報 + カード入力画面            │
│  ↓ [お支払い]                          │
│  ③ 処理中スピナー（ボタン無効化）       │
│  ↓                                     │
│  [3DS必要?] ─ YES → ④ 3DS認証画面     │
│  ↓ NO                   ↓ 結果        │
│  [成功?]─ YES → ⑤ 完了画面            │
│  ↓ NO                                  │
│  ⑥ 決済エラー画面（リトライ可）         │
│                                        │
└────────────────────────────────────────┘
```

### 機能詳細（補完）

#### ③ 処理中状態

| 項目 | 仕様 |
|------|------|
| 表示 | [お支払い] ボタンがスピナー表示に切替 + テキスト「処理中…」 |
| ボタン無効化 | 二重送信防止。ボタン・入力フォーム全てdisabled |
| タイムアウト | 30秒以内に応答がない場合 → ⑥エラー画面（「処理がタイムアウトしました。決済結果はメールでご確認ください」） |
| ブラウザバック抑止 | 処理中はbeforeunload警告表示 |

#### ④ 3Dセキュア認証フロー

| ステップ | 仕様 |
|---------|------|
| 3DS判定 | カードブランド + 接続先の3DS設定に基づき自動判定 |
| 遷移方式 | iframe内でカード発行元の認証ページを表示（ポップアップではない） |
| 認証成功 | iframe閉じ → ⑤完了画面に遷移 |
| 認証失敗 | iframe閉じ → ⑥エラー画面（「カード認証に失敗しました」） |
| 認証キャンセル | ユーザーがブラウザバックや認証画面を閉じた場合 → ②入力画面に戻す（「認証がキャンセルされました。再度お試しください」メッセージ表示） |
| タイムアウト | 5分以内に認証完了しない場合 → ⑥エラー画面 |

#### ⑤ 決済完了画面

```
┌────────────────────────────────────┐
│                                    │
│           ✅ お支払い完了            │
│                                    │
│  ┌──────────────────────────────┐  │
│  │  商品名: プレミアムプラン        │  │
│  │  お支払い金額: ¥9,800         │  │
│  │  注文番号: ORD-20260213-0042  │  │
│  │  日時: 2026/02/13 14:30      │  │
│  │  カード: VISA **** 4242       │  │
│  └──────────────────────────────┘  │
│                                    │
│  ※ 決済完了メールを送信しました      │
│     （ユーザーID入力ありの場合のみ）  │
│                                    │
│  [ページを閉じる]                    │
│                                    │
│  🔒 SSL暗号化通信 │ PCI DSS準拠    │
└────────────────────────────────────┘
```

| 表示項目 | 仕様 |
|---------|------|
| 商品名 | リンク設定の商品名 |
| お支払い金額 | 実際に決済された金額（税込） |
| 注文番号 | transaction の order_id |
| 日時 | 決済完了日時（JST） |
| カード | ブランド + 下4桁 |
| 完了通知メール | ユーザーID入力ありでメールが取得できた場合のみ送信 |

#### ⑥ 決済エラー画面

```
┌────────────────────────────────────┐
│                                    │
│         ❌ お支払いに失敗しました      │
│                                    │
│  エラー内容:                        │
│  「カードの利用限度額を超えています」  │
│                                    │
│  [もう一度試す]  [ページを閉じる]     │
│                                    │
│  🔒 SSL暗号化通信 │ PCI DSS準拠    │
└────────────────────────────────────┘
```

**エラー表示パターン:**

| エラー種別 | ユーザー向けメッセージ | リトライ可 |
|-----------|---------------------|:--------:|
| カード番号不正 | 「カード番号が正しくありません」 | ✅ |
| 有効期限切れ | 「カードの有効期限が切れています」 | ✅ |
| CVC不一致 | 「セキュリティコードが正しくありません」 | ✅ |
| 残高不足 | 「カードの利用限度額を超えています」 | ✅ |
| カード利用制限 | 「このカードはご利用いただけません」 | ✅ |
| 3DS認証失敗 | 「カード認証に失敗しました」 | ✅ |
| 3DSキャンセル | 「認証がキャンセルされました」 | ✅ |
| 処理タイムアウト | 「処理がタイムアウトしました。決済結果はメールでご確認ください」 | ❌ |
| システムエラー | 「一時的なエラーが発生しました。しばらくしてからお試しください」 | ✅ |
| 接続先エラー | 「決済処理中にエラーが発生しました」 | ✅ |

※ セキュリティ上、エラーの詳細な技術情報はユーザーに表示しない。
※ [もう一度試す] は ②入力画面に戻す（入力値はクリア）。

#### ⑦ リンクエラー画面（決済前のエラー）

| エラー種別 | ユーザー向けメッセージ |
|-----------|---------------------|
| リンク無効（不存在） | 「この決済リンクは無効です」 |
| リンク無効化済み | 「この決済リンクは利用停止されています」 |
| 有効期限切れ | 「この決済リンクの有効期限が過ぎています」 |
| 利用回数上限到達 | 「この決済リンクの利用可能回数に達しました」 |

※ リンクエラー画面にはカード入力フォームは表示しない。「お支払い先にお問い合わせください」のメッセージのみ。

### バリデーション（補完）

| 項目 | ルール |
|------|-------|
| カード番号 | Luhnアルゴリズムチェック / ブランド判定（VISA:4xxx / MC:5xxx / JCB:35xx / AMEX:34xx,37xx）/ 13〜19桁 |
| 有効期限 | MM/YY形式。未来日であること。月は01〜12 |
| CVC | 半角数字のみ。3桁（AMEXは4桁） |
| カード名義 | 半角英大文字・スペースのみ。2〜50文字 |
| 金額入力（金額入力型） | 1円以上 / 整数のみ / 上限額チェック（設定時） |
| ユーザーID（任意） | 1〜100文字。半角英数字・ハイフン・アンダースコア |
| フリー項目 | 各項目のtype に応じたバリデーション（テキスト: 最大200文字 / 数値: 整数 / メール: 形式チェック） |

### セキュリティ仕様

| 項目 | 仕様 |
|------|------|
| カード情報のスコープ | CDE（カードデータ環境）内のiframeで入力・トークン化。P02のJSからカード番号に直接アクセス不可 |
| トークン化フロー | iframe内でCDE APIにカード情報送信 → token取得 → P02のJS に token を postMessage → token で決済APIコール |
| HTTPS必須 | P02 は HTTPS のみ。HTTP アクセスは自動リダイレクト |
| CORS | CDE iframe は pay.aipayment.jp ドメインからのみ許可 |
| Rate Limit | 同一IP: 10回/分、同一リンク: 30回/時 |

### 画面遷移

| 遷移元 | 遷移先 | 条件 |
|--------|--------|------|
| リンクURL アクセス | ② 入力画面 | リンク有効時 |
| リンクURL アクセス | ⑦ リンクエラー画面 | リンク無効時 |
| ② [お支払い] | ③ 処理中 → ④ 3DS or ⑤ 完了 | — |
| ④ 3DS認証 成功 | ⑤ 完了画面 | — |
| ④ 3DS認証 失敗/キャンセル | ⑥ エラー画面 or ② 入力画面 | — |
| ⑥ [もう一度試す] | ② 入力画面 | リトライ可のエラー時 |
| S09 [プレビュー] | ② 入力画面（プレビューモード） | 決済ボタン無効 |

---

# 全画面 未定義事項サマリー

> 全36画面の個別未定義事項は**全て解決済み**です。
> 以下は全画面を通じて共通的に検討が必要な項目です。

### 共通の未定義事項

| # | カテゴリ | 未定義事項 | ステータス |
|---|---------|----------|:-----:|
| 1 | 認証 | パスワードポリシー（文字数・複雑性・有効期限） | ✅ M12で解決（12文字以上/英大小数字記号/90日有効期限 — PCI DSS v4.0 Req 8.3.6準拠） |
| 2 | 認証 | セッションタイムアウト時間 | ✅ M12で解決（8時間） |
| 3 | 認証 | 同時ログイン制限 | ✅ M12で解決（3デバイスまで） |
| 4 | UI | ダークモード対応の要否 | 🟢 未決定（低優先度） |
| 5 | UI | レスポンシブ対応（スマホ・タブレット）の範囲 | 🟡 未決定 |
| 6 | UI | 多言語対応（日本語のみ? 英語も?） | 🟡 未決定 |
| 7 | 通知 | リアルタイム通知の実装方式（WebSocket / SSE / ポーリング） | 🟡 WebSocket採用（M06リアルタイム/P01進捗で確定）、通知全体の統一は開発時 |
| 8 | データ | CSVエクスポートの共通仕様（文字コード・日付形式） | 🟡 未決定 |
| 9 | データ | ページネーションのデフォルト件数 | 🟢 未決定（低優先度） |
| 10 | セキュリティ | CSRF対策 | 🔴 開発時に実装（フレームワーク標準） |
| 11 | セキュリティ | XSS対策（入力サニタイズ） | 🔴 開発時に実装（フレームワーク標準） |
| 12 | セキュリティ | 操作ログ（audit_logs）の共通仕様 | ✅ 各画面で個別に定義済み |
| 13 | エラー | API失敗時の共通エラー表示仕様 | 🔴 開発時に詳細設計 |
| 14 | エラー | ネットワーク切断時のオフラインUI | 🟡 未決定 |

### 先送り・要検討事項まとめ

| 画面 | 項目 | ステータス |
|------|------|----------|
| M08 | 精算バッチの接続先別スケジュール | 開発時に詳細設計 |
| M08 | 入金サイクル（締め日・支払日） | 支払い設計後に決定 |
| S03 | レポートの自動メール配信設定 | 支払い設計後に決定 |
| S04 | 入金予定額の計算ロジック | 精算設計後に決定 |
| S05 | APIキースコープ / Webhookリトライ / API使用量 / テスト決済 | 開発フェーズで詳細設計 |
| S02 | 一部返金の金額バリデーション | 開発時に詳細設計 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-13 | v1.3 ローリングリザーブ（デポジット）機能追加。S04にリザーブタブ（残高/条件/履歴+検索）、M03加盟店詳細にリザーブ設定、M08にリザーブ検索+加盟店別テーブル追加 |
| 2026-02-13 | v1.2 新規12画面の全詳細仕様を補完完了。S09/S10/M14/M15/P02のUIレイアウト・バリデーション・確認ダイアログ・ロール権限・画面遷移を追加。M16/S11のバリデーション・遷移補完。D01-D05の全セクション詳細化。仕様書2,426行→3,934行（+1,508行） |
| 2026-02-13 | v1.2 顧客管理（簡易CRM）画面追加。M16顧客管理（運営向け横断検索/分析）+ S11顧客管理（加盟店向けCRM）。DB3テーブル追加（customers/customer_cards/customer_notes）+ 3ENUM。画面数32→34→36（P03代理店申込+AIチャット追加） |
| 2026-02-13 | v1.1 AQUAGATES照合による追加要件8件反映。画面数22→32。新規10画面（M14/M15/S09/S10/D01-D05/P02）追加。既存6画面修正（M03/M10/M13/S01/S08/M04）。共通仕様にマルチサイト・代理店ロール追加 |
| 2026-02-12 | v1.0 初版作成（全22画面の機能詳細仕様書） |
| 2026-02-12 | M01〜M07 未定義事項39件 全解決 |
| 2026-02-12 | M08〜M13 / S01〜S08 / P01 未定義事項 全解決（全22画面完了） |
