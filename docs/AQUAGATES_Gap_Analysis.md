# AQUAGATES vs AIpayment ギャップ分析レポート（確定版）

**作成日: 2026-02-13**
**目的: 現行システム（AQUAGATES）の機能を洗い出し、AIpaymentに不足している要件を特定・追加する**

---

## 回答結果サマリー

| 質問 | 回答 | 影響度 |
|------|------|--------|
| Q1 代理店管理 | ✅ **必要** | 🔴 大（新規画面群 + DB追加） |
| Q2 マルチサイト対応 | ✅ **必要** | 🔴 大（DB構造変更 + 全画面影響） |
| Q3 CSV一括決済 | ❌ 不要 | — |
| Q4 カード共有グループ | ❌ 不要 | — |
| Q5 一括ライン変更 | ✅ **必要** | 🟡 中（M10に機能追加） |

---

## 追加要件一覧（全8件）

| # | 要件 | 種別 | 影響範囲 | 優先度 |
|---|------|------|---------|--------|
| 1 | URL決済（スイフトパス） | 新規画面 | 加盟店画面 + DB + Zone A | A |
| 2 | 継続決済/分割決済管理 | 新規画面 + 機能 | マスター + 加盟店 + DB + Zone A | A |
| 3 | エラーコード一覧画面 | 画面追加 | マスター + 加盟店 | C |
| 4 | お知らせ管理 | 新規画面 | マスター + 加盟店ダッシュ | B |
| 5 | サイト追加申請 | 画面追加 | 加盟店画面（Q2と連動） | B |
| 6 | 代理店管理 | 新規画面群 | マスター + 新規代理店画面 + DB | A |
| 7 | マルチサイト対応 | 設計変更 | DB構造 + 全画面 | A |
| 8 | 一括ライン変更 | 機能追加 | M10 ルーティング画面 | B |

**優先度**: A=基盤に影響（先にやるべき） / B=中規模 / C=軽い追加

---

## 追加要件 詳細

---

### 要件1: URL決済（スイフトパス）

**概要:** 加盟店が管理画面から決済リンクを生成し、顧客にURLを送って決済してもらう仕組み。

**AQUAGATESの仕様:**
- 4種類: 一括決済 / 分割・継続 / 金額入力型 / 金額選択型
- 設定項目: サイト名・決済額・商品名・注文ID・ユーザー識別ID・フリー項目・有効期限・利用可能回数
- 生成したURLの検索・有効/無効切替が可能
- 管理画面からコピーしたURLのみ有効（ブラウザにペーストしたURLは再利用不可）

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 新規画面 | S09: 決済リンク管理（加盟店側） |
| 画面構成 | 3タブ: 新規作成 / リンク一覧・検索 / 利用状況 |
| 新規作成タブ | 決済タイプ選択（一括/金額入力型/金額選択型）→ 設定フォーム → URL生成 |
| ※分割・継続 | 要件2（継続決済管理）と統合 |
| リンク一覧タブ | 検索・フィルタ・有効/無効切替・URLコピー |
| DB追加 | payment_links テーブル |
| API追加 | Zone B: リンク生成・検索・ステータス変更 / Zone A: リンク決済処理 |

---

### 要件2: 継続決済（リカーリング）/ 分割決済 管理

**概要:** 月額課金・分割払いの設定・管理・ユーザー管理機能。

**AQUAGATESの仕様:**
- 継続決済: 初回金額・自動決済金額・決済日種別（指定間隔 or 月額）・サイクル日数
- 分割決済: 商品金額・決済回数 → 初回金額と自動決済金額を自動計算
- ユーザー検索 + 停止処理（返金とは別に停止が必要）
- カード変更URL発行
- リトライ: 失敗→10日後再トライ→3回連続失敗で自動停止→再開不可

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 新規画面（加盟店） | S10: 継続・分割決済管理 |
| 画面構成 | 3タブ: 商品設定 / ユーザー管理 / 決済履歴 |
| 商品設定タブ | 新規作成（継続/分割）・一覧・編集・停止 |
| ユーザー管理タブ | ユーザー検索・課金停止・カード変更URL発行 |
| 新規画面（マスター） | M14: リカーリング管理 |
| マスター画面構成 | 全加盟店の継続/分割決済を横断検索・監視 |
| DB追加 | subscription_plans / subscription_users / installment_plans テーブル |
| Zone A追加 | リカーリングエンジン（スケジューラー + リトライジョブ） |
| ビジネスルール | リトライ: 失敗→10日後→3回失敗で自動停止 / 停止後再開不可 |
| カード変更 | トークン方式のカード変更URL（CDE内で処理） |

---

### 要件3: エラーコード一覧画面

**概要:** 決済失敗時のエラーコードと原因・対処法を一覧表示。

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 追加先 | M13 システム設定に「エラーコード」タブ追加 |
| 加盟店側 | S08 アカウント設定に「エラーコード」タブ追加 or S06 AIチャットで回答 |
| 表示内容 | エラーコード / カテゴリ / 日本語文言 / 対処法 / API対応 / リンク決済対応 |
| DB | error_codes マスターテーブル（既存のAPI Contract定義を流用） |

---

### 要件4: お知らせ管理

**概要:** 運営から加盟店への告知（障害情報・メンテナンス・お知らせ）を管理・配信。

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| マスター側 | M13 システム設定に「お知らせ管理」タブ追加（作成・検索・編集・削除） |
| 加盟店側 | S01 ダッシュボードに「お知らせ」セクション追加 |
| DB追加 | announcements テーブル（title / body / type / published_at / expires_at） |
| お知らせ種別 | 障害情報 / メンテナンス / 機能リリース / お知らせ |
| 配信先 | 全加盟店 or 特定加盟店（タグ指定） |

---

### 要件5: サイト追加申請

**概要:** 既存加盟店が管理画面から新しいサイト/サービスの審査依頼を提出する。

**AIpaymentへの追加（要件7 マルチサイトと連動）:**

| 項目 | 内容 |
|------|------|
| 加盟店側 | S08 アカウント設定に「サイト追加申請」ボタン追加 → 申請フォーム |
| マスター側 | M04 申込・登録管理で「サイト追加申請」も一覧に表示 |
| フォーム内容 | サイト名・サイトURL・担当者・事業内容・決済手段（P01の簡略版） |
| フロー | 申請 → AI審査 → 運営承認 → 接続先審査 → 決済開始（既存フローを流用） |

---

### 要件6: 代理店管理

**概要:** 代理店（セールスパートナー）経由で加盟店を獲得するモデルの管理機能。

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 新規画面（マスター） | M15: 代理店管理 |
| マスター画面構成 | 3タブ: 代理店一覧・検索 / 代理店登録 / 条件設定 |
| 代理店一覧 | 代理店名・コード・担当者・紹介加盟店数・ステータス |
| 条件設定 | 代理店ごとの手数料率（紹介料）・契約条件 |
| 新規画面群（代理店側） | D01〜D05（代理店専用管理画面） |
| D01 ダッシュボード | 紹介加盟店のKPI・報酬サマリー |
| D02 加盟店一覧 | 自分が紹介した加盟店の状況確認 |
| D03 報告書 | 代理店報告書（明細書）の閲覧・DL |
| D04 申込紹介 | 新規加盟店の紹介申請フォーム |
| D05 アカウント設定 | 代理店情報・スタッフ管理 |
| DB追加 | agents / agent_users / agent_merchants / agent_commissions テーブル |
| ロール追加 | agent_admin / agent_viewer（代理店側ロール2種） |

---

### 要件7: マルチサイト対応

**概要:** 1加盟店が複数のECサイト/サービスを運営するケースに対応。サイト単位で設定を管理。

**AIpaymentへの変更:**

| 項目 | 内容 |
|------|------|
| DB変更 | **sites テーブル新規追加**（merchant_id に紐づく） |
| 影響テーブル | transactions / merchant_processors / routing_rules / subscriptions → site_id カラム追加 |
| サイト設定項目 | サイト名 / URL / 決済手段 / 手数料率（サイト別） / 入金サイクル / ステータス |
| マスター画面影響 | M03: 加盟店詳細にサイト一覧追加 / M06: サイト別フィルタ / M10: サイト別ルーティング |
| 加盟店画面影響 | 全画面にサイト切替セレクターを追加（ヘッダー） |
| サイト単位の管理 | 手数料率・入金サイクル・接続先はサイト単位 |
| 加盟店単位の管理 | 会社情報・口座情報・ユーザー管理は加盟店単位のまま |
| 一括停止 | マスター側でサイト一括停止が可能 |
| 口座一括変更 | マスター側で複数サイトの口座を一括変更が可能 |

**設計方針:**
```
merchants (1) ─── (N) sites (1) ─── (N) transactions
                      │
                      ├── (N) merchant_processors（サイト×接続先）
                      ├── (N) routing_rules（サイト別ルーティング）
                      ├── (N) payment_links（サイト別決済リンク）
                      └── (N) subscription_plans（サイト別継続決済商品）
```

---

### 要件8: 一括ライン変更

**概要:** 接続先が障害のとき、運営が手動で該当接続先を使っている全加盟店/サイトを別の接続先に一括切替する。

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 追加先 | M10 ルーティング画面に「一括変更」セクション追加 |
| 操作 | 接続先Aを選択 → 切替先の接続先Bを選択 → 影響加盟店/サイト数を表示 → 確認ダイアログ → 実行 |
| リカーリング | リカーリング決済のライン変更も同時実行のオプション |
| ログ | 一括変更の実行ログ（誰が・いつ・何件切替えたか）を記録 |
| 復元 | 「元に戻す」ボタンで一括切替前の状態に復元可能 |

---

## 画面数の変更

### 変更前（22画面）
- マスター管理: M01〜M13（13画面）
- 加盟店管理: S01〜S08（8画面）
- 公開画面: P01（1画面）

### 変更後（30画面 + 代理店5画面 = 35画面）
- マスター管理: M01〜M15（15画面） ← **+2（M14リカーリング管理 / M15代理店管理）**
- 加盟店管理: S01〜S10（10画面） ← **+2（S09決済リンク管理 / S10継続・分割決済管理）**
- 代理店管理: D01〜D05（5画面） ← **新規5画面**
- 公開画面: P01〜P02（2画面） ← **+1（P02決済ページ）**
- 既存画面の修正: M03, M04, M10, M13, S01, S08（6画面に機能追加）

---

## DB影響サマリー

### 新規テーブル（10テーブル）
| テーブル | 用途 | 関連要件 |
|----------|------|---------|
| sites | サイト情報（加盟店配下） | #7 |
| payment_links | 決済リンク設定 | #1 |
| subscription_plans | 継続決済の商品設定 | #2 |
| subscription_users | 継続決済のユーザー | #2 |
| installment_plans | 分割決済プラン | #2 |
| announcements | お知らせ | #4 |
| agents | 代理店情報 | #6 |
| agent_users | 代理店ユーザー | #6 |
| agent_merchants | 代理店×加盟店の紐付け | #6 |
| agent_commissions | 代理店報酬 | #6 |

### 既存テーブルの変更
| テーブル | 変更内容 | 関連要件 |
|----------|---------|---------|
| transactions | site_id カラム追加 | #7 |
| merchant_processors | site_id カラム追加 | #7 |
| routing_rules | site_id カラム追加 | #7 |
| merchants | agent_id カラム追加 | #6 |
| error_codes（新規 or マスター） | エラーコードマスター | #3 |

---

## 推奨する進め方

### Phase 1: 基盤設計（先にやるべき）
1. **マルチサイト対応のDB設計**（要件7）← 他の全要件に影響するため最優先
2. **継続/分割決済のDB設計**（要件2）← Zone Aの設計にも影響

### Phase 2: 画面追加
3. **S09 決済リンク管理**（要件1）
4. **S10 継続・分割決済管理**（要件2）
5. **M14 リカーリング管理**（要件2）
6. **M15 代理店管理 + D01〜D05**（要件6）

### Phase 3: 既存画面の修正
7. **M10 一括ライン変更**（要件8）
8. **M13 エラーコード + お知らせ**（要件3, 4）
9. **S01 お知らせ表示 + S08 サイト追加**（要件4, 5）
10. **全画面にサイト切替セレクター**（要件7）

---

## ✅ カバー済み（変更不要）— 15件

| # | AQUAGATES機能 | AIpayment対応画面 |
|---|-------------|-----------------|
| 1 | 決済検索 | M06 注文管理 |
| 2 | 返金処理 | M06 注文管理 |
| 3 | 日別/月別集計 | M11 レポート + S03 売上レポート |
| 4 | 支払明細書 | S04 入金管理 |
| 5 | 不正検知ルール管理 | M07 不正検知設定 |
| 6 | ブロック/禁止リスト | M07 タブ3 |
| 7 | スタッフ管理（マスター） | M12 ユーザー管理 |
| 8 | スタッフ管理（加盟店） | S07 ユーザー管理 |
| 9 | 加盟店登録/検索 | M03 + M04 |
| 10 | 加盟店情報確認/変更 | S08 アカウント設定 |
| 11 | 口座情報変更 | S08 振込先口座タブ |
| 12 | パスワード変更 | 共通ログイン |
| 13 | 2段階認証 | MFA |
| 14 | 操作ログ | M13 監査ログ |
| 15 | ダッシュボード | M01 / S01 |

## ❌ 不要と判断（3件）

| 機能 | 理由 |
|------|------|
| CSV一括決済 | API経由で十分 |
| カード共有グループ | 不要と判断 |
| クイック検索等 | AQUAGATES側でも不要とされた機能 |

## 特に注意すべきビジネスルールの差異

### 返金処理
- **AQUAGATES**: 返金しても手数料は取消にならない。一部返金は不可。
- **AIpayment**: 返金ポリシーが未定義。一部返金の可否、手数料の扱いを決める必要あり。

### パスワードポリシー
- **AQUAGATES**: 12〜32文字、英大文字+小文字+数字+記号必須、過去4回不可、90日更新、6回失敗でロック（30分）
- **AIpayment**: 8文字以上/英数字混合（M12で定義済み）→ AQUAGATESの方が厳しい。PCI DSS準拠なら強化が必要。

### 継続決済のリトライロジック
- **AQUAGATES**: 失敗→10日後再トライ→失敗→10日後再トライ→3回連続失敗で自動停止。停止後の再開不可。
- **AIpayment**: 未設計。
