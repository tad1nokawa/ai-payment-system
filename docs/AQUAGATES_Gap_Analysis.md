# AQUAGATES vs AIpayment ギャップ分析レポート（確定版）

**作成日: 2026-02-13**
**目的: 現行システム（AQUAGATES）の機能を洗い出し、AIpaymentに不足している要件を特定・追加する**

---

## 回答結果サマリー

| 質問 | 回答 | 影響度 |
|------|------|--------|
| Q1 代理店管理 | ✅ **必要** | 🔴 大（新規画面群 + DB追加） |
| Q2 マルチサイト対応 | ✅ **必要** | 🔴 大（DB構造変更 + 全画面影響） |
| Q3 CSV一括決済 | ✅ **必要** | 🟡 中（S10 CSV決済タブで実装済み） |
| Q4 カード共有グループ | ❌ 不要 | — |
| Q5 一括ライン変更 | ✅ **必要** | 🟡 中（M10に機能追加） |

---

## 追加要件一覧（全10件）

| # | 要件 | 種別 | 影響範囲 | 優先度 |
|---|------|------|---------|--------|
| 1 | URL決済（スイフトパス） | 新規画面 | 加盟店画面 + DB + Zone A | A |
| 2 | 継続決済/分割決済管理 | 新規画面 + 機能 | マスター + 加盟店 + DB + Zone A | A |
| 3 | エラーコード一覧画面 | 画面追加 | マスター + 加盟店 | C |
| 4 | お知らせ管理 | 新規画面 | マスター + 加盟店ダッシュ | B |
| 5 | サイト追加申請 | 画面追加 | 加盟店画面（Q2と連動） | B |
| 6 | 代理店管理 | 新規画面群 | マスター + 新規代理店画面 + DB | A |
| 7 | マルチサイト対応 | 設計変更 | DB構造 + 全画面 | A |
| 8 | 一括ライン変更 | 機能追加 | M10 ルーティング画面 | B |
| 9 | 決済制限候補の自動検知 | 機能追加 | M07 不正検知 + DB + Zone A↔B連携 | B |
| 10 | デポジット管理（チャージバック留保金） | 機能追加 | M08 精算管理 + M02 例外キュー + DB | A |

**優先度**: A=基盤に影響（先にやるべき） / B=中規模 / C=軽い追加

---

## 追加要件 詳細

---

### 要件1: URL決済（スイフトパス）

**概要:** 加盟店が管理画面から決済リンクを生成し、顧客にURLを送って決済してもらう仕組み。

**AQUAGATESの仕様:**
- 4種類: 一括決済 / 分割・継続 / 金額入力型 / 金額選択型
- 設定項目: サイト名・決済額・商品名・注文ID・ユーザー識別ID・フリー項目・有効期限・利用可能回数
- 生成したURLの検索・有効/無効切替が可能
- 管理画面からコピーしたURLのみ有効（ブラウザにペーストしたURLは再利用不可）

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 新規画面 | S09: 決済リンク管理（加盟店側） |
| 画面構成 | 3タブ: 新規作成 / リンク一覧・検索 / 利用状況 |
| 新規作成タブ | 決済タイプ選択（一括/金額入力型/金額選択型）→ 設定フォーム → URL生成 |
| ※分割・継続 | 要件2（継続決済管理）と統合 |
| リンク一覧タブ | 検索・フィルタ・有効/無効切替・URLコピー |
| DB追加 | payment_links テーブル |
| API追加 | Zone B: リンク生成・検索・ステータス変更 / Zone A: リンク決済処理 |

---

### 要件2: 継続決済（リカーリング）/ 分割決済 管理

**概要:** 月額課金・分割払いの設定・管理・ユーザー管理機能。

**AQUAGATESの仕様:**
- 継続決済: 初回金額・自動決済金額・決済日種別（指定間隔 or 月額）・サイクル日数
- 分割決済: 商品金額・決済回数 → 初回金額と自動決済金額を自動計算
- ユーザー検索 + 停止処理（返金とは別に停止が必要）
- カード変更URL発行
- リトライ: 失敗→10日後再トライ→3回連続失敗で自動停止→再開不可

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 新規画面（加盟店） | S10: 継続・分割決済管理 |
| 画面構成 | 3タブ: 商品設定 / ユーザー管理 / 決済履歴 |
| 商品設定タブ | 新規作成（継続/分割）・一覧・編集・停止 |
| ユーザー管理タブ | ユーザー検索・課金停止・カード変更URL発行 |
| 新規画面（マスター） | M14: リカーリング管理 |
| マスター画面構成 | 全加盟店の継続/分割決済を横断検索・監視 |
| DB追加 | subscription_plans / subscription_users / installment_plans テーブル |
| Zone A追加 | リカーリングエンジン（スケジューラー + リトライジョブ） |
| ビジネスルール | リトライ: 失敗→10日後→3回失敗で自動停止 / 停止後再開不可 |
| カード変更 | トークン方式のカード変更URL（CDE内で処理） |

---

### 要件3: エラーコード一覧画面

**概要:** 決済失敗時のエラーコードと原因・対処法を一覧表示。

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 追加先 | M13 システム設定に「エラーコード」タブ追加 |
| 加盟店側 | S08 アカウント設定に「エラーコード」タブ追加 or S06 AIチャットで回答 |
| 表示内容 | エラーコード / カテゴリ / 日本語文言 / 対処法 / API対応 / リンク決済対応 |
| DB | error_codes マスターテーブル（既存のAPI Contract定義を流用） |

---

### 要件4: お知らせ管理

**概要:** 運営から加盟店への告知（障害情報・メンテナンス・お知らせ）を管理・配信。

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| マスター側 | M13 システム設定に「お知らせ管理」タブ追加（作成・検索・編集・削除） |
| 加盟店側 | S01 ダッシュボードに「お知らせ」セクション追加 |
| DB追加 | announcements テーブル（title / body / type / published_at / expires_at） |
| お知らせ種別 | 障害情報 / メンテナンス / 機能リリース / お知らせ |
| 配信先 | 全加盟店 or 特定加盟店（タグ指定） |

---

### 要件5: サイト追加申請

**概要:** 既存加盟店が管理画面から新しいサイト/サービスの審査依頼を提出する。

**AIpaymentへの追加（要件7 マルチサイトと連動）:**

| 項目 | 内容 |
|------|------|
| 加盟店側 | S08 アカウント設定に「サイト追加申請」ボタン追加 → 申請フォーム |
| マスター側 | M04 申込・登録管理で「サイト追加申請」も一覧に表示 |
| フォーム内容 | サイト名・サイトURL・担当者・事業内容・決済手段（P01の簡略版） |
| フロー | 申請 → AI審査 → 運営承認 → 接続先審査 → 決済開始（既存フローを流用） |

---

### 要件6: 代理店管理

**概要:** 代理店（セールスパートナー）経由で加盟店を獲得するモデルの管理機能。

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 新規画面（マスター） | M15: 代理店管理 |
| マスター画面構成 | 3タブ: 代理店一覧・検索 / 代理店登録 / 条件設定 |
| 代理店一覧 | 代理店名・コード・担当者・紹介加盟店数・ステータス |
| 条件設定 | 代理店ごとの手数料率（紹介料）・契約条件 |
| 新規画面群（代理店側） | D01〜D05（代理店専用管理画面） |
| D01 ダッシュボード | 紹介加盟店のKPI・報酬サマリー |
| D02 加盟店一覧 | 自分が紹介した加盟店の状況確認 |
| D03 報告書 | 代理店報告書（明細書）の閲覧・DL |
| D04 申込紹介 | 新規加盟店の紹介申請フォーム |
| D05 アカウント設定 | 代理店情報・スタッフ管理 |
| DB追加 | agents / agent_users / agent_merchants / agent_commissions テーブル |
| ロール追加 | agent_admin / agent_viewer（代理店側ロール2種） |

---

### 要件7: マルチサイト対応

**概要:** 1加盟店が複数のECサイト/サービスを運営するケースに対応。サイト単位で設定を管理。

**AIpaymentへの変更:**

| 項目 | 内容 |
|------|------|
| DB変更 | **sites テーブル新規追加**（merchant_id に紐づく） |
| 影響テーブル | transactions / merchant_processors / routing_rules / subscriptions → site_id カラム追加 |
| サイト設定項目 | サイト名 / URL / 決済手段 / 手数料率（サイト別） / 入金サイクル / ステータス |
| マスター画面影響 | M03: 加盟店詳細にサイト一覧追加 / M06: サイト別フィルタ / M10: サイト別ルーティング |
| 加盟店画面影響 | 全画面にサイト切替セレクターを追加（ヘッダー） |
| サイト単位の管理 | 手数料率・入金サイクル・接続先はサイト単位 |
| 加盟店単位の管理 | 会社情報・口座情報・ユーザー管理は加盟店単位のまま |
| 一括停止 | マスター側でサイト一括停止が可能 |
| 口座一括変更 | マスター側で複数サイトの口座を一括変更が可能 |

**設計方針:**
```
merchants (1) ─── (N) sites (1) ─── (N) transactions
                      │
                      ├── (N) merchant_processors（サイト×接続先）
                      ├── (N) routing_rules（サイト別ルーティング）
                      ├── (N) payment_links（サイト別決済リンク）
                      └── (N) subscription_plans（サイト別継続決済商品）
```

---

### 要件8: 一括ライン変更

**概要:** 接続先が障害のとき、運営が手動で該当接続先を使っている全加盟店/サイトを別の接続先に一括切替する。

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 追加先 | M10 ルーティング画面に「一括変更」セクション追加 |
| 操作 | 接続先Aを選択 → 切替先の接続先Bを選択 → 影響加盟店/サイト数を表示 → 確認ダイアログ → 実行 |
| リカーリング | リカーリング決済のライン変更も同時実行のオプション |
| ログ | 一括変更の実行ログ（誰が・いつ・何件切替えたか）を記録 |
| 復元 | 「元に戻す」ボタンで一括切替前の状態に復元可能 |

---

### 要件9: 決済制限候補の自動検知→採用/不採用フロー

**概要:** AI/ルールベースで不正の疑いがあるエンティティ（カードBIN・IP・メールアドレス等）を「制限候補」として自動リストアップし、運営スタッフが採用（ブロック）/不採用を判断する半自動ワークフロー。

**AQUAGATESの仕様:**
- 不正検知エンジンがパターンを検出し「制限候補」キューに自動登録
- 検出条件例: 同一カードで短時間に複数サイトで決済、失敗が多いIP、チャージバック率が高いメールドメイン等
- 運営が候補一覧を確認→取引履歴を参照→「採用」or「不採用」を判断
- 採用→ブロックリストに自動追加→即座にブロック発動
- 不採用→候補から除外（理由記録）

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 追加先 | M07 不正検知に「候補」タブ追加（7→8タブ） |
| タブ構成 | 候補一覧（未処理/採用済み/不採用）、フィルタ（種別/リスクスコア/検出日）、採用/不採用ボタン、検出理由表示 |
| DB追加 | `fraud_candidates` テーブル（type, value, reason, risk_score, status, detected_at, reviewed_by, reviewed_at） |
| Zone連携 | Zone A（検出）→ Zone B（候補キュー登録）→ Zone B（スタッフ採用時にブロックリスト登録）→ Zone A（ブロック同期） |
| M02例外キューとの違い | 例外キュー=取引単位の判断、制限候補=エンティティ単位（カード/IP等）のブロック判断 |
| 候補種別 | カードBIN / IPアドレス / メールアドレス / メールドメイン / デバイスフィンガープリント |
| ビジネスルール | 候補は30日間未処理で自動期限切れ / 採用時に影響範囲（該当取引数）を表示 |

---

### 要件10: デポジット管理（チャージバック留保金）

**概要:** チャージバック発生に備え、加盟店の入金から一定割合を留保（リザーブ）として保持する仕組み。チャージバックは決済後一定期間経過後に発生するため、発生時点で加盟店に取扱高がなければ請求＝未収リスクが生まれる。

**ビジネスリスクと対策:**
- チャージバック発生時、該当加盟店（サイト）の現時点の取扱高を自動チェック
- 取扱高が不足（＝請求しても回収できない可能性）の場合、**例外キュー（M02）に自動エスカレーション**
- 運営スタッフが未収リスクを判断→回収対応 or 損金処理

**AIpaymentへの追加:**

| 項目 | 内容 |
|------|------|
| 追加先 | M08 精算管理に「デポジット管理」「チャージバック」タブ追加 |
| デポジット管理タブ | リザーブ率設定（加盟店/サイト単位）、リザーブ残高一覧、リザーブ入出金履歴、リザーブ解放スケジュール |
| チャージバックタブ | チャージバック一覧・検索、ステータス管理（受領→調査→反論→確定/取下げ）、証拠資料アップロード、未収リスクアラート |
| 未収リスク自動検知 | チャージバック発生時に加盟店の直近取扱高を自動チェック→不足時はM02例外キューにエスカレーション |
| DB追加 | `merchant_reserves`（加盟店リザーブ設定・残高）、`reserve_transactions`（リザーブ入出金履歴）、`chargebacks`（チャージバック案件管理） |
| Zone連携 | Zone A（アクワイアラからCB通知受信）→ Zone B（CB登録 + リザーブ充当 + 未収チェック）→ M02例外キュー |
| ビジネスルール | リザーブ率: 加盟店リスクレベルに応じて5-30% / 保持期間: 契約終了後180日 / チャージバック期限: ブランド規定に準拠（VISA 120日, MC 120日等） |

**返金ポリシー（確定）:**
- **一部返金**: 基本実装しない（20年で2回程度のイレギュラー）
- **手数料**: 返金しても手数料は取消にならない（AQUAGATES準拠）
- **管理者権限での金額編集**: 自動処理で対応できないケースに備え、管理者権限でリファンド・チャージバック金額を手動編集可能にする
- **管理者金額編集の監査**: 金額手動編集時は操作ログに詳細記録（変更前/後金額、理由）＋上長承認フローを推奨

---

## 画面数の変更

### 変更前（22画面）
- マスター管理: M01〜M13（13画面）
- 加盟店管理: S01〜S08（8画面）
- 公開画面: P01（1画面）

### 変更後（36画面）
- マスター管理: M01〜M16 + AIチャット（17画面） ← **+4（M14リカーリング管理 / M15代理店管理 / M16顧客管理 / AIチャット）**
- 加盟店管理: S01〜S11（11画面） ← **+3（S09決済リンク管理 / S10継続・分割決済管理 / S11顧客管理）**
- 代理店管理: D01〜D05（5画面） ← **新規5画面**
- 公開画面: P01〜P02（2画面） ← **+1（P02決済ページ）**
- 既存画面の修正: M03, M04, M10, M13, S01, S08（6画面に機能追加）

---

## DB影響サマリー

### 新規テーブル（14テーブル）
| テーブル | 用途 | 関連要件 |
|----------|------|---------|
| sites | サイト情報（加盟店配下） | #7 |
| payment_links | 決済リンク設定 | #1 |
| subscription_plans | 継続決済の商品設定 | #2 |
| subscription_users | 継続決済のユーザー | #2 |
| installment_plans | 分割決済プラン | #2 |
| announcements | お知らせ | #4 |
| agents | 代理店情報 | #6 |
| agent_users | 代理店ユーザー | #6 |
| agent_merchants | 代理店×加盟店の紐付け | #6 |
| agent_commissions | 代理店報酬 | #6 |
| fraud_candidates | 決済制限候補（自動検知） | #9 |
| merchant_reserves | 加盟店リザーブ設定・残高 | #10 |
| reserve_transactions | リザーブ入出金履歴 | #10 |
| chargebacks | チャージバック案件管理 | #10 |

### 既存テーブルの変更
| テーブル | 変更内容 | 関連要件 |
|----------|---------|---------|
| transactions | site_id カラム追加 | #7 |
| merchant_processors | site_id カラム追加 | #7 |
| routing_rules | site_id カラム追加 | #7 |
| merchants | agent_id カラム追加 | #6 |
| error_codes（新規 or マスター） | エラーコードマスター | #3 |

---

## 推奨する進め方

### Phase 1: 基盤設計（先にやるべき）
1. **マルチサイト対応のDB設計**（要件7）← 他の全要件に影響するため最優先
2. **継続/分割決済のDB設計**（要件2）← Zone Aの設計にも影響
3. **デポジット管理（チャージバック留保金）のDB設計**（要件10）← 精算・入金フローに影響

### Phase 2: 画面追加
4. **S09 決済リンク管理**（要件1）
5. **S10 継続・分割決済管理**（要件2）
6. **M14 リカーリング管理**（要件2）
7. **M15 代理店管理 + D01〜D05**（要件6）
8. **M08 デポジット管理 + チャージバックタブ**（要件10）

### Phase 3: 既存画面の修正
9. **M10 一括ライン変更**（要件8）
10. **M13 エラーコード + お知らせ**（要件3, 4）
11. **S01 お知らせ表示 + S08 サイト追加**（要件4, 5）
12. **全画面にサイト切替セレクター**（要件7）
13. **M07 決済制限候補タブ**（要件9）

---

## ✅ カバー済み（変更不要）— 15件

| # | AQUAGATES機能 | AIpayment対応画面 |
|---|-------------|-----------------|
| 1 | 決済検索 | M06 注文管理 |
| 2 | 返金処理 | M06 注文管理 |
| 3 | 日別/月別集計 | M11 レポート + S03 売上レポート |
| 4 | 支払明細書 | S04 入金管理 |
| 5 | 不正検知ルール管理 | M07 不正検知設定 |
| 6 | ブロック/禁止リスト | M07 タブ3 |
| 7 | スタッフ管理（マスター） | M12 ユーザー管理 |
| 8 | スタッフ管理（加盟店） | S07 ユーザー管理 |
| 9 | 加盟店登録/検索 | M03 + M04 |
| 10 | 加盟店情報確認/変更 | S08 アカウント設定 |
| 11 | 口座情報変更 | S08 振込先口座タブ |
| 12 | パスワード変更 | 共通ログイン |
| 13 | 2段階認証 | MFA |
| 14 | 操作ログ | M13 監査ログ |
| 15 | ダッシュボード | M01 / S01 |

## ❌ 不要と判断（2件）

| 機能 | 理由 |
|------|------|
| カード共有グループ | 不要と判断 |
| クイック検索等 | AQUAGATES側でも不要とされた機能 |

## 特に注意すべきビジネスルールの差異

### 返金処理 ✅ 確定
- **AQUAGATES**: 返金しても手数料は取消にならない。一部返金は不可。
- **AIpayment（確定）**:
  - 手数料: 返金しても手数料は取消にならない（AQUAGATES準拠）
  - 一部返金: 基本実装しない（20年で2回程度のイレギュラー）
  - 管理者権限: リファンド・チャージバックの金額を手動編集可能（自動処理で対応不可のケース用）
  - 監査: 金額手動編集時は操作ログに詳細記録（変更前/後金額、理由）

### パスワードポリシー ✅ 対応済
- **AQUAGATES**: 12〜32文字、英大文字+小文字+数字+記号必須、過去4回不可、90日更新、6回失敗でロック（30分）
- **AIpayment**: ✅ PCI DSS v4.0 Req 8.3.6準拠に強化済み（12文字+複雑性要件）

### 継続決済のリトライロジック
- **AQUAGATES**: 失敗→10日後再トライ→失敗→10日後再トライ→3回連続失敗で自動停止。停止後の再開不可。
- **AIpayment**: 未設計。
