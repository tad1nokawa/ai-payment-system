# AIpayment システム全体構成書 v1.0

**作成日**: 2026-02-18
**目的**: 2環境（CDE + 管理系）の全体構成を整理し、現在の設計前提の妥当性を確認する

---

## 1. システム全体構成図

```
                           ┌──────────────────────────────────────────────────┐
                           │               インターネット                      │
                           └──────┬────────────┬──────────────┬───────────────┘
                                  │            │              │
                           エンドユーザー   加盟店/代理店     PSP運営チーム
                           （購入者）      スタッフ          スタッフ
                                  │            │              │
                            ┌─────┴─────┐  ┌──┴──────────────┴──────────┐
                            │  P02      │  │    管理画面 SPA            │
                            │  決済ページ │  │ (React 19 + Vite 6)       │
                            │  P01/P03  │  │  M01-M16, S01-S12,        │
                            │  申込ページ │  │  D01-D05                  │
                            └─────┬─────┘  └────────────┬───────────────┘
                                  │                     │
                    ┌─────────────┤                     │
                    │ CDE iframe  │                     │
                    │ (トークン化) │                     │
                    ▼             ▼                     ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐  ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│  AWS環境A: CDE（PCI DSS準拠）           │  │  AWS環境B: 管理系システム                    │
│  ── 江成チーム構築 ──                   │  │  ── 別途構築 ──                             │
│                                         │  │                                             │
│  ┌───────────────────────────────────┐  │  │  ┌─────────────────────────────────────┐   │
│  │  決済ゲートウェイ (Zone A)        │  │  │  │  管理API (Zone B)                    │   │
│  │                                   │  │  │  │                                     │   │
│  │  • 決済処理 (auth/capture/void)   │  │  │  │  • 加盟店/サイト管理 API             │   │
│  │  • カード番号受信・トークン化      │  │  │  │  • 例外キュー管理 API                │   │
│  │  • 3DS認証処理                    │  │  │  │  • 精算・入金管理 API                │   │
│  │  • 接続先API通信                  │  │  │  │  • 不正検知ルール管理 API             │   │
│  │  • リカーリングエンジン            │  │  │  │  • ルーティング管理 API               │   │
│  │  • 決済リンク決済処理             │  │  │  │  • レポート生成 API                   │   │
│  │  • ルーティングエンジン            │  │  │  │  • ユーザー認証・認可 API             │   │
│  │                                   │  │  │  │  • 顧客CRM API                       │   │
│  │  ┌─────────────┐  ┌───────────┐  │  │  │  │  • AIチャット/監視 API                │   │
│  │  │ CDE内DB     │  │ HSM/KMS   │  │  │  │  │  • 操作ログ API                       │   │
│  │  │ カード番号   │  │ 暗号鍵管理 │  │  │  │  │  • 通知配信 API                       │   │
│  │  │ CVV         │  │           │  │  │  │  │  • WebSocket (6ch)                   │   │
│  │  └─────────────┘  └───────────┘  │  │  │  │                                     │   │
│  └───────────────────────────────────┘  │  │  └──────────────┬──────────────────────┘   │
│                                         │  │                 │                           │
│  ┌───────────────────────────────────┐  │  │  ┌──────────────┴──────────────────────┐   │
│  │  接続先（プロセッサー）           │  │  │  │  管理系DB (PostgreSQL)               │   │
│  │                                   │  │  │  │                                     │   │
│  │  • Univa Pay cast                 │  │  │  │  62テーブル / 42 ENUM               │   │
│  │  • 楽天銀行                       │  │  │  │  ※カード番号は含まない              │   │
│  │  • Worldpay                       │  │  │  │  ※トークン参照のみ                  │   │
│  │  • Simpletransact                 │  │  │  │                                     │   │
│  │  • TCMS                           │  │  │  │  • merchants / sites / transactions  │   │
│  │  • ONTHELINE                      │  │  │  │  • fraud_rules / routing_rules       │   │
│  │  • Asiabill                       │  │  │  │  • settlements / payouts             │   │
│  │  • WEBマネー各社                  │  │  │  │  • customers (CRM)                   │   │
│  │                                   │  │  │  │  • audit_logs                        │   │
│  └───────────────────────────────────┘  │  │  │  • card_token (参照のみ)             │   │
│                                         │  │  └─────────────────────────────────────┘   │
│                                         │  │                                             │
│                                         │  │  ┌─────────────────────────────────────┐   │
│                                         │  │  │  共通基盤                            │   │
│                                         │  │  │                                     │   │
│                                         │  │  │  • Redis (キャッシュ/セッション)      │   │
│                                         │  │  │  • S3 (書類/CSV/レポート)             │   │
│                                         │  │  │  • SES/SNS (メール/通知)              │   │
│                                         │  │  │  • CloudWatch (監視/ログ)             │   │
│                                         │  │  └─────────────────────────────────────┘   │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘  └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
                    │                                          │
                    └──────────── 内部API通信 ─────────────────┘
                         (VPC Peering or PrivateLink)
```

---

## 2. 環境分離の基本方針

| 項目 | AWS環境A（CDE） | AWS環境B（管理系） |
|------|----------------|-------------------|
| **担当** | 江成チーム | 別途構築 |
| **PCI DSS** | **準拠必須** | **準拠不要**（カード番号非保持） |
| **扱うデータ** | カード番号, CVV, 暗号鍵 | トークン, 取引結果, 加盟店情報, 精算データ |
| **ネットワーク** | 完全隔離VPC, WAF, IDS/IPS | 通常のVPC, WAF |
| **アクセス** | 限定的（API経由のみ） | 管理画面SPA + API |
| **監査** | PCI DSS Lv.1 準拠の監査証跡 | 操作ログ（audit_logs, 90日保持） |
| **主要機能** | 決済処理, トークン化, 3DS, ルーティングエンジン | 管理画面API, CRM, レポート, AI |

---

## 3. 環境間のデータフロー

### 3.1 決済フロー（P02 → CDE → 管理系）

```
購入者ブラウザ                    CDE (Zone A)              管理系 (Zone B)
    │                                │                          │
    │ 1. P02決済ページ表示            │                          │
    │──────────────────────────────>│                          │
    │                                │                          │
    │ 2. CDE iframe内でカード入力    │                          │
    │ 3. カード→トークン化            │                          │
    │<─── token返却 ─────────────────│                          │
    │                                │                          │
    │ 4. token + 金額で決済API呼出    │                          │
    │──────────────────────────────>│                          │
    │                                │ 5. ルーティング判定       │
    │                                │ 6. 接続先API呼出          │
    │                                │ 7. 3DS処理（必要時）      │
    │                                │                          │
    │                                │ 8. 取引結果を管理系に通知  │
    │                                │─────────────────────────>│
    │                                │                          │ 9. transactions保存
    │                                │                          │ 10. 不正検知ルール評価
    │                                │                          │ 11. 例外キュー登録（該当時）
    │<─── 決済結果 ───────────────────│                          │
```

### 3.2 管理画面フロー（管理画面 → Zone B → Zone A参照）

```
管理画面SPA                      管理系 (Zone B)              CDE (Zone A)
    │                                │                          │
    │ 1. 取引検索                     │                          │
    │──────────────────────────────>│                          │
    │                                │ 2. 管理系DBから取引検索    │
    │                                │   （トークン、金額等）     │
    │<─── 検索結果 ───────────────────│                          │
    │                                │                          │
    │ 3. 返金実行                     │                          │
    │──────────────────────────────>│                          │
    │                                │ 4. CDE返金APIを呼出       │
    │                                │─────────────────────────>│
    │                                │                          │ 5. 接続先返金処理
    │                                │<────── 返金結果 ──────────│
    │<─── 返金完了 ───────────────────│                          │
```

---

## 4. 機能の環境割り当て

### 4.1 CDE（Zone A）に配置すべき機能

| # | 機能 | 理由 | 関連画面 |
|---|------|------|---------|
| A-1 | カードトークン化API | カード番号を直接受信 | P02 |
| A-2 | 決済処理（auth/capture/void） | トークン→カード復号→接続先通信 | P02 |
| A-3 | 3DS認証処理 | カード発行元との認証通信 | P02 |
| A-4 | 接続先API通信 | 各プロセッサーとのAPI通信 | — |
| A-5 | ルーティングエンジン | 決済時のリアルタイム接続先選択 | — |
| A-6 | リカーリングエンジン | カードトークンで定期課金実行 | — |
| A-7 | 返金処理（実行） | 接続先への返金API呼出 | — |
| A-8 | 決済リンク決済処理 | P02経由のリンク決済 | P02 |

### 4.2 管理系（Zone B）に配置すべき機能

| # | 機能 | 関連画面 | API数 |
|---|------|---------|-------|
| B-1 | 加盟店・サイト管理 | M04, M06, S06, S08 | R:9 / W:11 |
| B-2 | 取引検索・閲覧 | M03, M03b, S02 | R:7 / W:2 |
| B-3 | 例外キュー管理 | M02, M01 | R:1 / W:2 |
| B-4 | 精算・入金管理 | M08, S04 | R:5 / W:2 |
| B-5 | 不正検知ルール管理 | M07 | R:5 / W:9 |
| B-6 | ルーティングルール管理 | M10 | R:4 / W:7 |
| B-7 | レポート生成 | M11, S03 | R:2 / W:2 |
| B-8 | ユーザー認証・認可 | M12, S07, D05 | R:1 / W:5 |
| B-9 | 顧客CRM | M16, S11 | R:4 / W:3 |
| B-10 | 継続課金管理（設定・閲覧） | M14, S10 | R:5 / W:7 |
| B-11 | 決済リンク管理（設定） | S09 | R:2 / W:3 |
| B-12 | 代理店管理 | M15, D01-D05 | R:7 / W:1 |
| B-13 | AI監視・チャット | M05, M01, S12 | R:4 / W:7 |
| B-14 | システム設定 | M13 | R:6 / W:9 |
| B-15 | 操作ログ・監査 | M13 | R:1 / W:1 |
| B-16 | 通知配信 | M13 | R:1 / W:1 |

### 4.3 環境をまたぐ機能（要注意）

| # | 機能 | Zone A の役割 | Zone B の役割 | 連携方式 |
|---|------|-------------|-------------|---------|
| C-1 | ルーティング | 実行時のルール適用 | ルール設定・管理 | ルール変更時にZone Aへ同期 |
| C-2 | 不正検知 | 決済時のリアルタイム判定 | ルール設定・ログ閲覧 | ルール変更時にZone Aへ同期 |
| C-3 | 返金 | 接続先への返金実行 | 返金指示・結果表示 | Zone B→A API呼出 |
| C-4 | リカーリング | 定期課金実行 | プラン設定・ユーザー管理 | Zone Aが実行→結果をBに通知 |
| C-5 | 取引データ | 取引結果生成 | 取引検索・表示 | Zone A→B 取引結果同期 |
| C-6 | プロセッサーヘルス | 稼働率計測 | ヘルス表示・アラート | Zone A→B ヘルスデータ送信 |
| C-7 | 精算 | 精算金額計算（手数料適用） | バッチ管理・入金管理 | Zone A→B 精算データ同期 |

---

## 5. 現在の設計に対するレビュー

### 5.1 ✅ 問題なし（適切に設計されている点）

| # | 項目 | 評価 |
|---|------|------|
| 1 | **CDE分離方針** | ✅ カード番号をCDE内に閉じ、管理系はトークン参照のみ。PCI DSS準拠の基本設計として正しい |
| 2 | **P02のiframeトークン化** | ✅ CDE内iframeでカード入力→postMessageでtoken返却。管理系JSがカード番号に触れない設計 |
| 3 | **DB設計のカード情報** | ✅ `customer_cards.card_token` / `subscription_users.card_token` はCDE側トークン参照のみ。カード番号カラムなし |
| 4 | **操作ログ（audit_logs）** | ✅ PCI DSS要件の90日保持、月次パーティション設計済み |
| 5 | **62テーブル/42 ENUM** | ✅ 機能要件に対して漏れなく設計されている |
| 6 | **143 API** | ✅ 画面機能に対して必要なAPIが網羅されている |
| 7 | **マルチテナント分離** | ✅ merchant_id / agent_id によるデータ分離設計 |
| 8 | **3階層データモデル** | ✅ 加盟店→サイト→接続先の3階層が正しく設計されている |

### 5.2 ⚠️ 要検討（設計の明確化が必要な点）

#### 5.2.1 ルーティングエンジンの配置

**現状**: ルーティングルール管理はZone B、ルーティング実行はZone A
**課題**: ルールの同期方式が未定義

```
問題: Zone BでルーティングルールをCRUDした場合、Zone Aのルーティングエンジンに
     どうやってリアルタイムに反映するか？

選択肢:
  (a) Zone AがZone BのDBを直接参照 → ❌ PCI DSS的にCDEから外部DB参照は避けるべき
  (b) Zone BからZone AにAPIでルール同期 → ✅ 推奨
  (c) Zone Aに別途ルールDBを持ち、変更時に同期 → ✅ 推奨（レイテンシ考慮）
```

**推奨**: **(c)** Zone Aにルールキャッシュ（Redis等）を持ち、Zone Bでルール変更時にZone Aの同期APIを呼ぶ。ルーティング実行時はZone A内のキャッシュを参照。

---

#### 5.2.2 不正検知ルールの実行位置

**現状**: 不正検知ルール（35フィールド条件ビルダー）は管理画面で設定
**課題**: 実際の判定処理はどこで実行するか

```
選択肢:
  (a) Zone A（決済時にリアルタイム判定） → 高速だがルール管理が複雑
  (b) Zone B（決済後に非同期判定）       → 管理が容易だが「自動ブロック」が遅れる
  (c) ハイブリッド                       → 速度系・金額系はZone A、AI系はZone B

問題点:
  - 「自動ブロック」アクション → 決済前にブロックする必要 → Zone Aで実行必須
  - 「例外キュー送り」アクション → 決済後でもOK → Zone Bで可
  - 速度チェック（同一カード取引回数/5分）→ Zone Aでリアルタイム集計必要
  - AI不正スコア → AI推論はZone B or 外部、スコアをZone Aに返す
```

**推奨**: **(c) ハイブリッド方式**
- Zone A: 金額閾値/速度チェック/BINブロックリスト/地域制限 → 決済前リアルタイム判定
- Zone B: AIスコア判定/パターン分析/例外キュー送り → 決済後非同期判定
- Zone Bで設定したルールをZone Aに同期する仕組みが必要

---

#### 5.2.3 取引データの同期方式

**現状**: 取引結果はZone Aで生成、管理画面はZone Bから表示
**課題**: 2つのDBに取引データをどう持つか

```
選択肢:
  (a) Zone AのみにDB → Zone Bが毎回Zone A APIを呼出 → ❌ CDE負荷大
  (b) Zone BのみにDB → ❌ Zone Aの決済処理で取引記録が必要
  (c) 両方にDB（二重書き込み） → ⚠️ 整合性リスク
  (d) Zone A→Zone B イベント駆動同期 → ✅ 推奨

  ※ Zone BのDBにはカード番号を含めない（トークンのみ）
```

**推奨**: **(d) イベント駆動同期**
- Zone Aで決済完了時にイベント発行（SQS/EventBridge）
- Zone Bがイベントを受信し、管理系DBに取引データを書き込み（カード番号なし）
- 管理画面の取引検索はZone BのDBに対して実行

---

#### 5.2.4 精算処理の分担

**現状**: 精算バッチ管理はM08（Zone B）、手数料計算には接続先別レートが必要
**課題**: 精算計算をどちらの環境で行うか

```
選択肢:
  (a) Zone Aで精算計算 → 手数料率はCDE内で管理
  (b) Zone Bで精算計算 → 手数料率は管理系DBで管理
  (c) Zone Aで取引ごとの手数料を計算 → Zone Bで集計・バッチ管理

問題: M04のサイト接続先詳細で手数料率（原価率/加盟店率/マージン）を管理している
     → この手数料データは管理系DB（Zone B）にある
     → しかし実際の精算計算には取引ごとの手数料額が必要
```

**推奨**: **(c)**
- 取引ごとの手数料はZone Aで計算（決済時点のレート適用）
- Zone A→B同期時に手数料額も含める
- Zone Bでは集計・バッチ管理・入金スケジュール管理を行う
- 手数料率の変更はZone B→Zone Aに同期

---

#### 5.2.5 リカーリングエンジンの連携

**現状**: S10/M14でプラン設定・ユーザー管理、実際の課金実行はZone A
**課題**: プラン/ユーザーデータの同期

```
Zone B（管理画面で操作）:
  - プラン作成/編集/停止
  - ユーザー一時停止/再開/強制停止
  - カード変更URL発行

Zone A（バッチ実行）:
  - 毎日AM2:00 定期課金実行
  - リトライ（10日後、3回失敗で自動停止）
  - 実行結果の記録

同期が必要なデータ:
  - subscription_plans（プラン設定）→ Zone B → Zone A
  - subscription_users（ユーザー）  → 双方向
  - 課金結果                       → Zone A → Zone B
```

**推奨**:
- `subscription_plans`と`subscription_users`のマスタはZone Bに配置
- Zone Aは課金実行時にZone B APIで対象ユーザーを取得
- 実行結果はZone A→Zone Bにイベント通知

---

#### 5.2.6 P02決済ページのホスティング

**現状**: P02（決済ページ）はReact SPAの一部として定義
**課題**: P02にはCDE iframeが含まれるため、ドメイン/ホスティングの検討が必要

```
選択肢:
  (a) 管理画面SPAと同じドメイン → CDE iframeのCORS設定が管理画面ドメインを許可
  (b) 別ドメイン（pay.aipayment.jp） → 決済専用、管理画面から分離
  (c) CDE側でホスティング → PCI DSS範囲に含まれる
```

**推奨**: **(b) 別ドメイン**
- `pay.aipayment.jp` → 決済ページ専用（P02）
- `admin.aipayment.jp` → 管理画面SPA（M01-M16, S01-S12, D01-D05）
- `apply.aipayment.jp` → 申込ページ（P01, P03）
- CDE iframeは `cde.aipayment.jp` からロード
- CORS: `pay.aipayment.jp` のみCDE iframeを許可

---

### 5.3 🔴 要対応（現設計に不足している点）

#### 5.3.1 Zone A ↔ Zone B の内部API仕様が未定義

**現状**: Core_System_Integration_v2.0.md は「フロントエンド→バックエンド」のAPI一覧。Zone A↔Zone B間の内部APIは未定義。

**必要な内部API**:

| # | API | 方向 | 用途 |
|---|-----|------|------|
| I-001 | 取引結果通知 | A→B | 決済完了/失敗時に管理系DBへ同期 |
| I-002 | 返金実行 | B→A | 管理画面からの返金指示 |
| I-003 | キャンセル実行 | B→A | 管理画面からのキャンセル指示 |
| I-004 | ルーティングルール同期 | B→A | ルール変更時にZone Aに反映 |
| I-005 | 不正検知ルール同期 | B→A | ルール変更時にZone Aに反映 |
| I-006 | ブロックリスト同期 | B→A | BIN/IP/メール等のブロックリスト更新 |
| I-007 | プロセッサーヘルス通知 | A→B | 稼働率/レスポンス/エラー数の定期送信 |
| I-008 | リカーリング対象取得 | A→B | 本日の課金対象ユーザー一覧 |
| I-009 | リカーリング結果通知 | A→B | 課金実行結果の通知 |
| I-010 | 精算データ集計 | A→B | 期間内取引の手数料集計データ |
| I-011 | プロセッサー設定同期 | B→A | 接続先の有効/無効切替、手数料率変更 |
| I-012 | 加盟店設定同期 | B→A | 加盟店/サイトのステータス変更 |
| I-013 | カード変更URL生成 | B→A | サブスクユーザーのカード変更 |
| I-014 | 3DS結果取得 | A→B | 3DS認証結果の管理系DB記録 |
| I-015 | 不正検知結果通知 | A→B | リアルタイム判定結果の通知 |

→ **「内部API仕様書」を別途作成する必要あり**

---

#### 5.3.2 パスワードポリシーの強化

**現状**: 8文字以上/英数字混合（M12で定義）
**AQUAGATES（PCI DSS準拠）**: 12~32文字、英大文字+小文字+数字+記号必須、過去4回不可、90日更新、6回失敗でロック（30分）

**対応**: M13セキュリティ設定のパスワードポリシーをAQUAGATES相当に強化

---

#### 5.3.3 CSVバッチ決済の実行環境

**現状**: S10のCSV決済タブからCSVアップロード→バッチ実行
**課題**: CSVの各レコードの決済実行はZone A、管理・承認フローはZone B

```
フロー:
  1. 加盟店がCSVアップロード → Zone B（S3保存 + バリデーション）
  2. 加盟店/管理者が承認 → Zone B
  3. バッチ実行 → Zone B→Zone A（各レコードの決済をZone AのAPIで実行）
  4. 結果通知 → Zone A→Zone B
```

---

#### 5.3.4 AI機能の外部API連携

**現状**: AI機能が6種（不正検知/審査/ルーティング/チャット/予測/URL巡回）
**課題**: AIモデルの実行環境とAPI接続が未定義

```
選択肢:
  (a) 外部AI API（Claude API等）をZone Bから直接呼出
  (b) 自社AIモデルをSageMaker等でホスティング
  (c) ハイブリッド（チャット=外部API、不正検知=自社モデル）
```

**推奨**: **(c)**
- チャットサポート（M01, S12）: 外部AI API（Claude API）→ Zone Bから呼出
- 不正検知AI: 自社モデル（Zone Bでホスティング or SageMaker）
- 審査AI: 外部API（反社チェック等）+ 自社モデル
- AIプロンプト設定（M13）: 外部API呼出時のパラメータ管理

---

## 6. 確認事項（江成チームへ追加）

### 6.1 環境間連携

- [ ] Zone A → Zone B の取引データ同期方式（イベント駆動 / バッチ / API？）
- [ ] Zone B → Zone A のルール同期方式（API同期 / メッセージキュー？）
- [ ] VPC Peering or PrivateLink の構成
- [ ] 内部API認証方式（mTLS / IAM / API Key？）

### 6.2 CDE（Zone A）の機能範囲

- [ ] ルーティングエンジンはZone A内で完結するか？
- [ ] 不正検知のリアルタイム判定はZone Aで行うか？
- [ ] 精算の手数料計算はZone Aで行うか？
- [ ] リカーリングエンジンのスケジューラーはZone A内か？

### 6.3 フロント関連

- [ ] P02決済ページのホスティング先（CDEドメイン or 別ドメイン？）
- [ ] CDE iframeのCORS許可ドメイン
- [ ] 管理画面SPAのデプロイ先（Vercel→AWS移行？CloudFront + S3？）

---

## 7. 推奨アーキテクチャ構成（AWS）

### 7.1 AWS環境B（管理系）推奨構成

```
┌─────────────────────────────────────────────────────────┐
│  VPC: 管理系                                            │
│                                                         │
│  ┌───────────────┐    ┌──────────────────────────┐     │
│  │ CloudFront    │    │ ALB (Application LB)     │     │
│  │ + S3          │    │                          │     │
│  │ (React SPA)   │    │ admin.aipayment.jp       │     │
│  └───────────────┘    └────────────┬─────────────┘     │
│                                    │                    │
│                        ┌───────────┴───────────┐       │
│                        │ ECS Fargate            │       │
│                        │ (Zone B API)           │       │
│                        │                        │       │
│                        │ • REST API             │       │
│                        │ • WebSocket            │       │
│                        │ • バッチジョブ          │       │
│                        └───────┬────────────────┘       │
│                                │                        │
│                   ┌────────────┼────────────┐           │
│                   ▼            ▼            ▼           │
│             ┌──────────┐ ┌──────────┐ ┌──────────┐     │
│             │ RDS      │ │ ElastiC. │ │ S3       │     │
│             │ (PgSQL)  │ │ (Redis)  │ │ (Files)  │     │
│             │ 62tables │ │ Cache    │ │ CSV/PDF  │     │
│             └──────────┘ └──────────┘ └──────────┘     │
│                                                         │
│  ┌────────────────┐  ┌────────────────┐                │
│  │ SES (Email)    │  │ EventBridge    │                │
│  │ SNS (通知)     │  │ (イベント連携)  │                │
│  └────────────────┘  └────────────────┘                │
│                                                         │
│  ──── VPC Peering / PrivateLink ────                   │
│                                     ↕                   │
│                            Zone A (CDE VPC)             │
└─────────────────────────────────────────────────────────┘
```

### 7.2 通信経路

| 経路 | プロトコル | 認証 | 用途 |
|------|----------|------|------|
| ブラウザ → CloudFront | HTTPS | — | SPA配信 |
| ブラウザ → ALB | HTTPS | JWT | API通信 |
| ブラウザ → ALB | WSS | JWT | WebSocket |
| Zone B → Zone A | HTTPS (内部) | mTLS | 返金/キャンセル/ルール同期 |
| Zone A → Zone B | HTTPS (内部) or SQS | mTLS | 取引結果/ヘルス通知 |
| Zone B → 外部AI | HTTPS | API Key | Claude API / 反社チェックAPI |
| Zone B → SES/SNS | AWS SDK | IAM | メール/通知配信 |

---

## 8. サマリー

### 現在の設計状態

| 項目 | 状態 |
|------|------|
| 画面設計 | ✅ 38画面完了（ワイヤーフレーム実装済み） |
| DB設計 | ✅ 62テーブル / 42 ENUM 定義済み |
| フロント→バックエンドAPI | ✅ 143件定義済み |
| CDE分離方針 | ✅ カード番号非保持、トークン参照のみ |
| **内部API（Zone A↔B）** | 🔴 **未定義（15件以上必要）** |
| **環境間同期方式** | 🔴 **未定義（イベント駆動推奨）** |
| **ドメイン/ホスティング構成** | ⚠️ **要検討** |
| **パスワードポリシー** | ⚠️ **PCI DSS要件に対して弱い** |
| **AI実行環境** | ⚠️ **要検討** |

### 次のステップ

1. **江成チームとの確認**: Zone Aの機能範囲と内部API仕様の合意
2. **内部API仕様書の作成**: Zone A↔B間の15件以上のAPIを定義
3. **ドメイン・インフラ構成の決定**: ホスティング先、CDN、DB構成
4. **パスワードポリシーの強化**: AQUAGATES/PCI DSS相当に引き上げ
5. **AI環境の選定**: 外部API vs 自社モデルの判断
