# コアシステム連携 必要情報
**作成日**: 2026-02-17
**確認先**: 江成チーム
**目的**: AIpaymentフロントエンドが必要とするAPI/データの一覧

---

## 1. API一覧（READ系 = データ取得）

### 1.1 取引・決済

| API | 呼出元画面 | 必要データ | 更新頻度 |
|-----|-----------|-----------|----------|
| 取引リアルタイムフィード | M03 リアルタイム監視 | 取引ID/加盟店/金額/ブランド/プロセッサー/ルーティング理由/応答時間/3DS/ステータス/購入者ID/メール/名前 | **5秒ポーリング or WebSocket** |
| 取引検索 | M03b 注文検索, S02 注文一覧 | 上記＋検索条件16項目（取引ID/加盟店/カード下4桁/ブランド/金額範囲/日時範囲/ユーザーID/メール/名前/代理店/チケット番号/課金方法/備考/ステータス/テスト含む/マネロン疑い） | オンデマンド |
| 取引KPI | M01 ダッシュボード, M03 | 取引量/売上額/成功率/CB率/自動化率 （本日/今週/今月/カスタム期間） | 1分間隔 |
| 取引推移チャート | M01, S01 | 日次/時間別の件数・金額（7日/30日/90日） | 5分間隔 |
| 決済手段分布 | S01 ダッシュボード | ブランド別の件数・金額・構成比 | 日次集計 |

### 1.2 顧客

| API | 呼出元画面 | 必要データ | 更新頻度 |
|-----|-----------|-----------|----------|
| 顧客検索 | M16, S11 | 顧客ID/メール/カード情報（マスク済）/加盟店/取引回数/LTV/最終取引日/サブスク状態/リスクレベル/セグメント/PQ-ID/RC紐付数/カード保存状態 | オンデマンド |
| 顧客分析 | M16, S11 | 総顧客数/アクティブ率/平均LTV/リピート率/新規数/セグメント分布/コホートデータ/LTV分布 | 日次集計 |
| 顧客タイムライン | M16, S11 | 取引履歴（日時/金額/ブランド/ステータス/メモ）、カード情報一覧 | オンデマンド |

### 1.3 サブスクリプション・継続課金

| API | 呼出元画面 | 必要データ | 更新頻度 |
|-----|-----------|-----------|----------|
| プラン一覧 | M14, S10 | プランID/名前/タイプ（月額/年額/分割）/金額/サイクル/ユーザー数/ステータス | オンデマンド |
| サブスクユーザー一覧 | M14, S10 | ユーザーID/メール/プラン/カード/次回決済日/失敗回数/ステータス | オンデマンド |
| 決済履歴（継続） | M14, S10 | 実行日時/ユーザーID/プラン/金額/結果/リトライステータス/エラーコード | オンデマンド |
| CSVバッチ一覧 | S10 | バッチID/名称/件数/合計金額/予定日/ステータス/アップロード日時 | オンデマンド |

### 1.4 加盟店

| API | 呼出元画面 | 必要データ | 更新頻度 |
|-----|-----------|-----------|----------|
| 加盟店一覧 | M04 | 加盟店ID/名称/業種/ステータス/月間処理額/成功率/CB率/契約日/手数料率 | オンデマンド |
| 加盟店詳細 | M04 | 会社情報/口座情報/API設定/手数料テーブル/月次チャート/直近取引 | オンデマンド |
| 審査申込一覧 | M06 | 申込ID/会社名/業種/申込日/AI審査結果/スコア/ステータス | オンデマンド |
| AI審査詳細 | M06 | 反社チェック/Web分析/財務分析/業種リスク/総合スコア/推薦結果 | **WebSocket（リアルタイム更新）** |

### 1.5 精算・入金

| API | 呼出元画面 | 必要データ | 更新頻度 |
|-----|-----------|-----------|----------|
| 精算バッチ一覧 | M08 | バッチID/対象期間/加盟店数/総額/手数料/純振込額/ステータス/実行日時 | オンデマンド |
| 入金スケジュール | M08, S04 | 入金予定日/対象期間/売上合計/手数料/リザーブ控除/リザーブ解放/純入金額 | 日次更新 |
| 入金履歴 | S04 | 入金日/精算期間/売上/手数料/リザーブ保留/解放/純入金額/ステータス/ブランド別内訳 | オンデマンド |
| リザーブ情報 | S04 | 現在残高/当月解放予定/翌月解放予定/当月新規保留/プロセッサー別条件（率/日数/残高/次回解放） | 日次更新 |

### 1.6 代理店

| API | 呼出元画面 | 必要データ | 更新頻度 |
|-----|-----------|-----------|----------|
| 代理店一覧 | M15 | 代理店ID/名称/紹介加盟店数/月間処理額/報酬率/ステータス | オンデマンド |
| 紹介先加盟店一覧 | D02 | 加盟店ID/名称/ステータス/取引額/手数料/稼働開始日 | オンデマンド |
| 報酬明細一覧 | D03 | 報告書ID/レポートNo/対象月/発行日/支払金額/支払予定日/ステータス/加盟店別内訳 | オンデマンド |
| 代理店決済検索 | D02 | 決済ID/オーダーID/加盟店/サイト/通貨/ステータス/顧客名/メール/カード下4桁/金額/決済日時 | オンデマンド |

### 1.7 不正検知・ルーティング

| API | 呼出元画面 | 必要データ | 更新頻度 |
|-----|-----------|-----------|----------|
| 不正検知ルール一覧 | M07 | ルールID/名前/タイプ/条件/アクション/優先度/有効フラグ/30日ヒット数 | オンデマンド |
| ブロックリスト | M07 | BINリスト/IPリスト/メールリスト（各エントリ+追加日） | オンデマンド |
| ルーティングルール一覧 | M10 | ルール文/優先度/有効フラグ | オンデマンド |
| プロセッサー状態 | M09, M01 | プロセッサーID/名称/ステータス/稼働率/平均レスポンス/直近エラー数 | **30秒間隔** |

### 1.8 その他

| API | 呼出元画面 | 必要データ | 更新頻度 |
|-----|-----------|-----------|----------|
| 例外キュー | M02, M01 | キューID/タイプ/対象/リスクスコア/AI推薦/経過時間/ステータス | **30秒間隔** |
| AIモジュール状態 | M05 | モジュール名/精度/最終学習日/次回学習日/エラー数 | 5分間隔 |
| Webhookログ | S05 | イベント名/日時/ステータス/レスポンスタイム | オンデマンド |
| スタッフ一覧 | M12, S07, D05 | スタッフID/名前/メール/ロール/MFA状態/最終ログイン/活動ログ | オンデマンド |
| レポートテンプレート | M11 | テンプレートID/名前/タイプ/パラメータ定義 | オンデマンド |

---

## 2. API一覧（WRITE系 = データ更新）

### 2.1 取引操作

| API | 呼出元画面 | 送信データ | 備考 |
|-----|-----------|-----------|------|
| 返金実行 | M03b, S02 | 取引ID, 返金種別（全額/一部）, 返金金額, 理由 | **権限: admin以上** |
| 取引キャンセル | M03b | 取引ID | **権限: admin以上** |

### 2.2 加盟店・審査

| API | 呼出元画面 | 送信データ | 備考 |
|-----|-----------|-----------|------|
| 加盟店申込送信 | P01 | 会社情報/業種/決済設定/書類ファイル | AI審査パイプライン起動 |
| 審査承認/拒否 | M06 | 申込ID, 判定（承認/条件付き/拒否）, コメント | **権限: admin以上** |
| 加盟店ステータス変更 | M04 | 加盟店ID, 新ステータス | **権限: super_admin** |
| 加盟店手数料率変更 | M04 | 加盟店ID, ブランド別手数料率 | **権限: super_admin** |

### 2.3 精算・入金

| API | 呼出元画面 | 送信データ | 備考 |
|-----|-----------|-----------|------|
| 精算バッチ実行 | M08 | 対象期間, 対象加盟店（全件/個別指定） | **権限: super_admin** |
| 精算バッチ再実行 | M08 | バッチID | エラー分のみ再実行 |

### 2.4 サブスクリプション・CSV決済

| API | 呼出元画面 | 送信データ | 備考 |
|-----|-----------|-----------|------|
| プラン作成/更新 | S10 | プラン名/タイプ/金額/サイクル | |
| ユーザー一時停止/再開 | S10, M14 | ユーザーID, アクション | |
| 手動リトライ | S10, M14 | ユーザーID | 失敗したサブスク決済のリトライ |
| CSVバッチアップロード | S10 | CSVファイル, バッチ名, 予定日 | **承認フロー必須** |
| CSVバッチ承認/却下 | S10 | バッチID, 判定 | **権限: admin以上** |

### 2.5 例外キュー

| API | 呼出元画面 | 送信データ | 備考 |
|-----|-----------|-----------|------|
| 例外承認/拒否 | M02 | キューID, 判定, コメント | |
| 例外バッチ操作 | M02 | キューID[], 判定 | 複数件一括操作 |

### 2.6 不正検知・ルーティング

| API | 呼出元画面 | 送信データ | 備考 |
|-----|-----------|-----------|------|
| 不正検知ルールCRUD | M07 | ルール名/タイプ/条件/アクション/優先度/有効フラグ | |
| ブロックリスト登録 | M07 | タイプ（BIN/IP/メール）, 値, 理由 | |
| ルーティングルールCRUD | M10 | ルール文/優先度/有効フラグ | |
| プロセッサー有効化/無効化 | M09 | プロセッサーID, ステータス | |

### 2.7 設定・管理

| API | 呼出元画面 | 送信データ | 備考 |
|-----|-----------|-----------|------|
| APIキー再発行 | S05, S08 | 環境（本番/テスト） | **確認ダイアログ必須** |
| Webhook設定更新 | S05 | URL, 受信イベント種別[] | |
| Webhookテスト送信 | S05 | エンドポイントURL | |
| IP制限設定 | S05 | IP/CIDR, ラベル | |
| 会社情報変更申請 | S08 | 変更フィールド, 新値 | 承認フロー |
| 口座変更申請 | S08 | 銀行情報 | 承認フロー（1-3営業日） |
| パスワード変更 | S08 | 現パスワード, 新パスワード | |
| スタッフ招待 | S07, M12, D05 | 名前/メール/ロール/MFA設定 | |
| スタッフ権限変更 | S07, M12, D05 | ユーザーID, 新ロール, 理由 | 監査ログ記録 |
| 顧客ブロック/WL | M16 | 顧客ID, アクション（ブロック/ホワイトリスト） | |
| 顧客タグ/メモ追加 | M16, S11 | 顧客ID, タグ or メモ内容 | |
| 代理店紹介送信 | D04 | 会社名/代表者/業種/URL/コメント | |

---

## 3. リアルタイム通信（WebSocket要件）

| チャネル | 用途 | データ | 画面 |
|----------|------|--------|------|
| `transactions.live` | 決済リアルタイムフィード | 全取引イベント | M03 |
| `queue.updates` | 例外キュー更新 | 新規キュー/ステータス変更 | M02, M01 |
| `processor.health` | プロセッサーヘルス | 稼働率/レスポンス/エラー数 | M09, M01 |
| `review.progress` | AI審査進捗 | 各チェック項目の結果 | P01, M06 |
| `ai.chat` | AIチャット | メッセージ送受信 | M01, S06 |

---

## 4. 認証・認可

| 項目 | 内容 |
|------|------|
| 認証方式 | JWT（アクセストークン + リフレッシュトークン） |
| ロール体系 | super_admin / admin / staff / viewer |
| マルチテナント | 加盟店ID/代理店IDによるデータ分離 |
| MFA | Google Authenticator / TOTP |
| セッション | ログイン履歴（IP/デバイス/OS/日時） |

---

## 5. 確認事項（江成チームへ）

### 5.1 データモデル確認
- [ ] 取引データに「購入者ID/メール/名前/カード名義」は含まれるか？
- [ ] 顧客データの「PQ-ID」（ペイクイックID）の仕様は？
- [ ] リザーブ（デポジット）の計算ロジックはプロセッサー別か？
- [ ] CSVバッチ決済のpaymentid空欄時の挙動（新規決済扱い？）

### 5.2 API仕様確認
- [ ] リアルタイム監視のデータ取得方式（WebSocket / SSE / ポーリング？）
- [ ] 取引検索APIのページネーション仕様（カーソル / オフセット？）
- [ ] 返金APIのレスポンス（同期 / 非同期？処理完了通知方法は？）
- [ ] AI審査のプログレス通知方式（WebSocket推奨）

### 5.3 ルーティング・不正検知
- [ ] ルーティングエンジンのA/Bテスト機能の有無
- [ ] 不正検知AIスコアの算出タイミング（リアルタイム / バッチ？）
- [ ] BINブロックリストのインポート機能の要否

### 5.4 精算
- [ ] 精算サイクルの設定粒度（週次/月2回/月次？加盟店別設定可能？）
- [ ] 手数料計算のタイミング（取引時 / 精算バッチ時？）
- [ ] 為替対応の要否（JPYのみ or 多通貨？）

### 5.5 その他
- [ ] テスト環境と本番環境のデータ分離方式
- [ ] 監査ログの保持期間
- [ ] CSVエクスポートの上限件数
- [ ] ファイルアップロード（申込書類/CSV）のストレージ
