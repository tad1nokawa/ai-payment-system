# AI Payment System - ワイヤーフレーム

## プロジェクト概要
決済代行システム（PSP）の管理画面ワイヤーフレーム。React + Tailwind CSSの単一ファイル構成。

## 技術スタック
- React 19 + Vite 6
- Tailwind CSS v4
- 単一ファイル: `src/wireframes_v3.jsx`（約8,100行）
- デプロイ: Vercel（https://aipayment-system.vercel.app/）
- Git: https://github.com/tad1nokawa/ai-payment-system.git (main)

## 画面構成（36画面）

### マスター管理（17画面）M01-M16 + AIチャット
| ID | 画面名 | メニュー表示名 | カテゴリ |
|----|--------|---------------|---------|
| M01 | ダッシュボード | ダッシュボード | 概況 |
| M02 | 例外キュー | 例外キュー | 概況 |
| M06 | トランザクション監視 | 取引モニタリング | 取引 |
| M16 | 顧客管理 | 顧客管理 | 取引 |
| M14 | リカーリング管理 | 継続課金管理 | 取引 |
| M03 | 加盟店管理 | 加盟店管理 | 加盟店・代理店 |
| M04 | 申込・登録管理 | 審査・申込管理 | 加盟店・代理店 |
| M15 | 代理店管理 | 代理店管理 | 加盟店・代理店 |
| M08 | 精算管理 | 精算・入金管理 | 経理 |
| M11 | レポート | レポート | 経理 |
| M09 | 接続先管理 | 接続先管理 | 決済インフラ |
| M10 | ルーティング設定 | ルーティング | 決済インフラ |
| M07 | 不正検知設定 | 不正検知 | 決済インフラ |
| M05 | AI監視 | AI監視 | AI・運用 |
| — | AIチャット（master_chat） | AIチャット | AI・運用 |
| M12 | ユーザー管理 | スタッフ管理 | AI・運用 |
| M13 | システム設定（8タブ） | システム設定 | AI・運用 |

#### M13 システム設定 タブ構成
| タブ | 内容 |
|------|------|
| 決済手段 | 有効な決済手段トグル、決済種別ごと詳細設定テーブル |
| 接続先管理 | プロセッサー接続一覧、ルーティングルール、ヘルスモニター |
| 通知設定 | チャンネル設定（Slack/Email/SMS）、イベント別通知マトリクス、スケジュール |
| API設定 | AI APIキー（Claude/OpenAI）、6機能別プロンプト編集、外部APIキー管理、Webhook |
| セキュリティ | パスワードポリシー、2FA、IP制限、レート制限、暗号化/PCI DSS |
| エラーコード | エラーコード一覧（20件サンプル）、検索、ページネーション |
| お知らせ管理 | お知らせ検索・登録、種別（障害/メンテ/機能リリース/お知らせ）、公開状態管理 |
| 操作ログ | 管理画面操作ログ検索（スタッフ/IP/ページ/日時/種別）、PCI DSS v4.0準拠バッジ、12ヶ月保持 |

#### M03 加盟店管理 タブ構成
| タブ | 内容 |
|------|------|
| 加盟店一覧 | 既存の加盟店検索・一覧テーブル |
| サイト管理 | サイト検索（ID/名前/加盟店/ステータス/ブランド）、サイト一覧、一括停止・口座一括変更 |

#### M07 不正検知 タブ構成
| タブ | 内容 |
|------|------|
| ルール | 不正検知ルール一覧・設定 |
| リスト | ブラックリスト・ホワイトリスト管理 |
| ブロック | ブロック一覧・解除 |
| AI設定 | AI不正検知モデル設定 |
| 統計 | 不正検知統計・グラフ |
| CSVインポート | CSVファイルアップロード、フォーマット説明、インポート履歴 |
| 制限登録禁止リスト | 誤ブロック防止ホワイトリスト検索・登録 |
| 候補 | AI/ルール自動検知の制限候補一覧、採用/不採用判断、リスクスコア表示 |

#### M08 精算管理 タブ構成
| タブ | 内容 |
|------|------|
| 精算一覧 | 加盟店別精算サイクル・金額一覧、精算実行・確認 |
| 入金管理 | 入金スケジュール、入金履歴、入金ステータス |
| 代理店精算 | 代理店報酬計算・精算、フィー明細 |
| デポジット管理 | リザーブ率設定（加盟店/サイト単位）、リザーブ残高一覧、入出金履歴、解放スケジュール |
| チャージバック | CB一覧・検索、ステータス管理（受領→調査→反論→確定）、証拠資料、未収リスクアラート→M02連携 |

#### M10 ルーティング タブ構成
| タブ | 内容 |
|------|------|
| ルーティング設定 | 既存のルーティングルール管理 |
| 一括変更 | 通常/リカーリング決済ライン、サイトID CSV入力、ブランド別接続先変更、変更履歴 |

#### M16 顧客管理 タブ構成
| タブ | 内容 |
|------|------|
| 顧客検索 | 検索フォーム（カード保存設定/最終利用日追加）、結果テーブル（PQ ID/RC紐付数追加） |
| 顧客分析 | セグメント分布、LTV分布、加盟店別顧客数 |
| カード情報管理 | トークン検索、KPI、トークン一覧テーブル、PCI DSS準拠情報 |

### 加盟店管理（11画面）S01-S11
| ID | 画面名 | メニュー表示名 | カテゴリ |
|----|--------|---------------|---------|
| S01 | ダッシュボード | ダッシュボード | 概況 |
| S02 | 取引一覧 | 取引一覧 | 取引 |
| S11 | 顧客管理 | 顧客管理 | 取引 |
| S09 | 決済リンク管理 | 決済リンク | 決済プロダクト |
| S10 | 継続・分割決済 | 継続・分割払い | 決済プロダクト |
| S03 | 売上レポート | 売上レポート | 売上・入金 |
| S04 | 入金管理 | 入金管理 | 売上・入金 |
| S05 | API設定 | API・Webhook | 設定 |
| S07 | ユーザー管理 | スタッフ管理 | 設定 |
| S08 | アカウント設定 | アカウント設定 | 設定 |
| S06 | AIチャット | AIチャット | サポート |

### 代理店管理（5画面）D01-D05
| ID | 画面名 | メニュー表示名 | カテゴリ |
|----|--------|---------------|---------|
| D01 | ダッシュボード | ダッシュボード | 概況 |
| D02 | 加盟店一覧 | 紹介先加盟店 | 営業 |
| D04 | 紹介管理 | 新規紹介 | 営業 |
| D03 | レポート | 実績レポート | 管理 |
| D05 | アカウント設定 | アカウント設定 | 管理 |

### 公開画面（3画面）P01-P03
- P01: 加盟店申込フォーム（4ステップ）
- P02: 決済ページ（PCI DSS対応）
- P03: 代理店申込フォーム（4ステップ、オレンジテーマ）

## サイドバーメニュー構造
カテゴリ区切り（separator）対応済み。各メニュー項目にカテゴリヘッダーを表示。

## コード構造
- 共通UI: Sidebar（separator対応）, KPICard, TableHeader, Badge, MiniChart
- データ: merchantData, processorList, reviewFlowData, approvedHistory
- メニュー: masterMenuItems, merchantMenuItems, agentMenuItems
- メインApp: `export default function Wireframes()`
- テーブル: 全てHTML `<table>` 要素（`<div>` flexではない）

## 開発ルール
- セクションコメント形式: `// ─── [SCREEN_ID]: [日本語名] ───`
- コンポーネントは全てトップレベル（depth=0）で定義
- モーダルはコンポーネントのルートdiv内に配置
- hooksを使うコンポーネントは `() => {` 構文、使わないものは `() => (` 構文
- タブ: `useState` + 条件付きレンダリング `{tab === X && (<>...</>)}`
- メニューセパレーター: `{ separator: true, label: "カテゴリ名" }`

## 代理店フィーモデル
- 代理店フィーは決済種別ごと（VISA/MC/JCB/AMEX/QR/銀行振込/コンビニ）
- フィーは加盟店の決済手数料から差引
- 代理店と加盟店の紐づけは運営が手動で設定
- M15「フィー設定」タブで管理、M08に代理店精算セクション

## AI設定
- M13 API設定タブ内に統合
- Claude API / OpenAI（バックアップ）のAPIキー管理
- 6機能別プロンプト編集: 不正検知AI / 審査AI / チャットAI / レポートAI / URL巡回AI / ルーティングAI
- 各機能: モデル選択、最大トークン数、Temperature、システムプロンプト（テキストエリア）

## 関連ドキュメント
- `docs/Screen_Specification_v1.0.md` - 画面仕様書（35画面）
- `docs/DB_Design_Addendum_v1.1.md` - DB設計（62テーブル、42 ENUM）
- `docs/System_Architecture_v1.0.md` - システム全体構成書
- `docs/Core_System_Integration_v2.0.md` - フロントエンド→バックエンドAPI一覧（143件）
- `docs/Internal_API_Specification_v1.0.md` - Zone A↔B内部API仕様書（15件、mTLS認証）
- `docs/AQUAGATES_Gap_Analysis.md` - ギャップ分析
- `docs/AQUAGATES_Screen_Mapping.md` - 画面マッピング（全54画面 完了）
- `docs/AQUAGATES_Screen_List.xlsx` - AQUAGATES画面一覧Excel（必要/不要判定用）
- `docs/Requirements_Priority.md` - 要件優先度（分析中）
- `docs/Analysis_Checklist.md` - 分析チェックリスト

## AQUAGATES分析（動画分析 + スクリーンショット補完 完了）
Google Drive上の管理画面動画12本 + スクリーンショット54枚を分析し、全54サブ画面のマッピングを完了。

### 分析ステータス
- [x] 動画12本の分析完了（2026-02-17）
- [x] スクリーンショット54枚の分析完了（2026-02-17）
- [x] 画面マッピング完了（`docs/AQUAGATES_Screen_Mapping.md`）
- [x] ギャップ分析完了（`docs/AQUAGATES_Gap_Analysis.md`）
- [x] 不足機能の追加実装完了（2026-02-17）
- [ ] 要件の最終確認（ユーザーと詰め）

### AQUAGATES不足機能 追加実装（2026-02-17 完了）
| # | 対象画面 | 追加内容 |
|---|---------|---------|
| 1 | M13 システム設定 | エラーコード一覧タブ（20件サンプル+検索+ページネーション） |
| 2 | M13 システム設定 | お知らせ管理タブ（検索+登録、種別/公開状態管理） |
| 3 | M13 システム設定 | 操作ログタブ（スタッフ/IP/ページ/日時検索、PCI DSS準拠バッジ） |
| 4 | — AIチャット | マスター管理向けAIチャット新規作成（master_chat） |
| 5 | M06 取引モニタリング | 検索フィルタ追加: 代理店名/チケット番号/課金方法/決済備考/テスト決済/マネロン疑い |
| 6 | M07 不正検知 | CSVインポートタブ（ファイルアップロード+フォーマット説明+インポート履歴） |
| 7 | M07 不正検知 | 制限登録禁止リストタブ（検索+登録、誤ブロック防止ホワイトリスト） |
| 8 | M03 加盟店管理 | サイト管理タブ（サイト検索+一覧、一括停止/口座一括変更ボタン） |
| 9 | M10 ルーティング | 一括変更タブ（通常/リカーリング切替、サイトID入力、ブランド別接続先変更、変更履歴） |
| 10 | M16 顧客管理 | カード保存設定/最終利用日フィルタ追加、PQ ID/RC紐付数カラム追加 |
| 11 | M16 顧客管理 | カード情報管理タブ（トークン検索+KPI+一覧、PCI DSS準拠情報） |
| 12 | M11 レポート | レポート生成に決済種別フィルタ追加（URL決済のみ/除外/リカーリング/通常） |
| 13 | M11 レポート | カスタムレポートに「URL決済分析」項目追加 |

### 分析結果サマリー
- AQUAGATES全54サブ画面中:
  - ✅ 対応済み: 23画面 (43%)
  - ⚠️ 部分対応: 13画面 (24%) → 不足機能追加により大幅改善
  - ❌ 未対応: 8画面 (15%) → 操作ログ等の主要機能は実装済み
  - 🚫 不要: 10画面 (19%)
- 追加要件: 8件（詳細は `docs/AQUAGATES_Gap_Analysis.md`）
- スクリーンショットで追加発見: 3件

### 動画分析+スクリーンショットで判明した主な差異
1. デポジット管理（チャージバック留保金）
2. 代理店フィーの仕切りモデル詳細
3. 決済制限のCSVインポート/エクスポート → **M07に実装済み**
4. 決済制限候補の自動検知→採用/不採用フロー
5. サイト一括停止/口座一括変更 → **M03に実装済み**
6. **管理画面操作ログ検索（監査証跡）** → **M13操作ログタブに実装済み**
7. **決済検索の豊富なフィルタ条件** → **M06に実装済み**
8. **エラーコード一覧の大量データ** → **M13エラーコードタブに実装済み**

### スクリーンショット分析の結果
- 54枚中20画面で実際のフォームが確認できた
- 34画面は403エラー（権限不足）でサイドバーメニューのみ確認
- 新発見の画面: 管理画面操作ログ検索 / リカーリングオフサイト検索

## 次のタスク
- [x] PCI DSS v4.0対応完了（パスワードポリシー Req 8.3.6、操作ログ12ヶ月保持 Req 10.5.1、スクリプト完全性 Req 6.4.3/11.6.1）
- [x] ユーザーと要件の詰め
  - デポジット管理: ✅ 必要（要件10として追加、M08にタブ追加）
  - CSV一括決済: ✅ 必要に変更（S10 CSV決済タブで実装済み）
  - 決済制限候補: ✅ 実装（要件9、M07候補タブ追加）
  - 返金ポリシー: ✅ 確定（一部返金なし、手数料取消なし、管理者金額編集可）
  - チャージバック未収リスク検知: ✅ M02例外キュー連携で実装
- [ ] 優先度の最終決定
